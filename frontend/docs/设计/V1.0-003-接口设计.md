# V1.0-003 接口设计文档

## 一、接口概述

本文档定义前端与后端API的接口规范，包括请求格式、响应格式、错误处理等。

## 二、基础配置

### 2.1 API基础地址
```typescript
// 开发环境
const API_BASE_URL = 'http://localhost:8001';

// 生产环境（需要根据实际部署情况配置）
const API_BASE_URL = 'https://your-domain.com';
```

### 2.2 请求配置
- **Content-Type**：`application/json`
- **超时时间**：60秒（聊天接口），5秒（健康检查接口）
- **请求拦截器**：统一添加认证信息（如果需要）
- **响应拦截器**：统一处理错误响应

## 三、聊天相关接口

### 3.1 发送消息

**接口地址**：`POST /api/chat`

**请求参数**：
```typescript
interface ChatRequest {
  message: string;        // 用户消息内容（必填）
  session_id: string;     // 会话ID（必填，UUID格式）
  user_id: string;        // 用户ID（必填）
}
```

**请求示例**：
```json
{
  "message": "我想记录血压",
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "user_123"
}
```

**响应数据**：
```typescript
interface ChatResponse {
  response: string;              // 智能体回复内容
  current_intent: string;        // 当前意图（blood_pressure/appointment/doctor_assistant/unclear）
  current_agent: string | null;  // 当前活跃的智能体名称（可能为null）
}
```

**响应示例**：
```json
{
  "response": "好的，我来帮您记录血压。请告诉我您的收缩压和舒张压数值。",
  "current_intent": "blood_pressure",
  "current_agent": "blood_pressure_agent"
}
```

**意图类型说明**：
- `blood_pressure`：血压记录意图
- `appointment`：复诊管理意图
- `doctor_assistant`：医生助手意图
- `unclear`：意图不明确

**智能体名称说明**：
- `blood_pressure_agent`：血压记录智能体
- `appointment_agent`：复诊管理智能体
- `doctor_assistant_agent`：医生助手智能体
- `null`：路由智能体（未路由到具体智能体）

**错误响应**：
```typescript
// HTTP状态码：500
{
  "detail": "处理请求时出错: 具体错误信息"
}
```

**前端处理逻辑**：
```typescript
async function sendMessage(
  message: string,
  sessionId: string,
  userId: string
): Promise<ChatResponse> {
  try {
    const response = await axios.post<ChatResponse>('/api/chat', {
      message,
      session_id: sessionId,
      user_id: userId
    }, {
      timeout: 60000  // 60秒超时
    });
    return response.data;
  } catch (error) {
    if (axios.isAxiosError(error)) {
      if (error.code === 'ECONNABORTED') {
        throw new Error('请求超时，请稍后重试');
      } else if (error.response) {
        throw new Error(error.response.data.detail || '服务器错误');
      } else if (error.request) {
        throw new Error('无法连接到服务器，请检查网络连接');
      }
    }
    throw error;
  }
}
```

## 四、健康检查接口

### 4.1 服务健康检查

**接口地址**：`GET /health`

**请求参数**：无

**响应数据**：
```typescript
interface HealthResponse {
  status: string;    // 状态：'ok' 表示正常
  message: string;   // 状态消息
}
```

**响应示例**：
```json
{
  "status": "ok",
  "message": "服务运行正常"
}
```

**前端处理逻辑**：
```typescript
async function checkHealth(): Promise<boolean> {
  try {
    const response = await axios.get<HealthResponse>('/health', {
      timeout: 5000
    });
    return response.data.status === 'ok';
  } catch (error) {
    return false;
  }
}
```

### 4.2 数据库健康检查

**接口地址**：`GET /health/db`

**请求参数**：无

**响应数据**：
```typescript
interface DatabaseHealthResponse {
  status: string;                    // 状态：'ok' | 'degraded' | 'error'
  langgraph_pool: string;            // LangGraph连接池状态：'ok' | 'not_initialized'
  sqlalchemy_engine: string;         // SQLAlchemy引擎状态：'ok' | 'not_initialized'
  pool_stats: PoolStats;             // 连接池统计信息
  message?: string;                  // 错误消息（仅在status为'error'时存在）
}

interface PoolStats {
  langgraph_pool: LangGraphPoolStats | null;
  sqlalchemy_engine: SqlAlchemyPoolStats | null;
}

interface LangGraphPoolStats {
  min_size: number;      // 最小连接数
  max_size: number;      // 最大连接数
  pool_size: number;     // 当前连接池大小
  available: number;     // 可用连接数
  waiting: number;       // 等待连接数
}

interface SqlAlchemyPoolStats {
  size: number;          // 连接池大小
  checked_in: number;    // 已归还连接数
  checked_out: number;   // 已借出连接数
  overflow: number;     // 溢出连接数
  invalid: number;      // 无效连接数
}
```

**响应示例（正常）**：
```json
{
  "status": "ok",
  "langgraph_pool": "ok",
  "sqlalchemy_engine": "ok",
  "pool_stats": {
    "langgraph_pool": {
      "min_size": 5,
      "max_size": 10,
      "pool_size": 5,
      "available": 5,
      "waiting": 0
    },
    "sqlalchemy_engine": {
      "size": 5,
      "checked_in": 5,
      "checked_out": 0,
      "overflow": 0,
      "invalid": 0
    }
  }
}
```

**响应示例（错误）**：
```json
{
  "status": "error",
  "langgraph_pool": "not_initialized",
  "sqlalchemy_engine": "not_initialized",
  "pool_stats": {
    "langgraph_pool": null,
    "sqlalchemy_engine": null
  },
  "message": "数据库连接失败: connection refused"
}
```

**前端处理逻辑**：
```typescript
async function checkDatabaseHealth(): Promise<DatabaseHealthResponse> {
  try {
    const response = await axios.get<DatabaseHealthResponse>('/health/db', {
      timeout: 5000
    });
    return response.data;
  } catch (error) {
    if (axios.isAxiosError(error) && error.response) {
      return error.response.data;
    }
    throw new Error('无法获取数据库健康状态');
  }
}
```

## 五、TypeScript类型定义

### 5.1 完整类型定义文件

```typescript
// types/api.ts

// 聊天请求
export interface ChatRequest {
  message: string;
  session_id: string;
  user_id: string;
}

// 聊天响应
export interface ChatResponse {
  response: string;
  current_intent: 'blood_pressure' | 'appointment' | 'doctor_assistant' | 'unclear';
  current_agent: string | null;
}

// 健康检查响应
export interface HealthResponse {
  status: string;
  message: string;
}

// 数据库健康检查响应
export interface DatabaseHealthResponse {
  status: 'ok' | 'degraded' | 'error';
  langgraph_pool: 'ok' | 'not_initialized';
  sqlalchemy_engine: 'ok' | 'not_initialized';
  pool_stats: PoolStats;
  message?: string;
}

// 连接池统计信息
export interface PoolStats {
  langgraph_pool: LangGraphPoolStats | null;
  sqlalchemy_engine: SqlAlchemyPoolStats | null;
}

// LangGraph连接池统计
export interface LangGraphPoolStats {
  min_size: number;
  max_size: number;
  pool_size: number;
  available: number;
  waiting: number;
}

// SQLAlchemy连接池统计
export interface SqlAlchemyPoolStats {
  size: number;
  checked_in: number;
  checked_out: number;
  overflow: number;
  invalid: number;
}

// API错误响应
export interface ApiErrorResponse {
  detail: string;
}
```

## 六、Axios配置

### 6.1 Axios实例配置

```typescript
// services/api.ts
import axios, { AxiosInstance, AxiosError } from 'axios';
import { message } from 'antd';

// 创建Axios实例
const api: AxiosInstance = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:8001',
  timeout: 60000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器
api.interceptors.request.use(
  (config) => {
    // 可以在这里添加认证token等
    // const token = localStorage.getItem('token');
    // if (token) {
    //   config.headers.Authorization = `Bearer ${token}`;
    // }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// 响应拦截器
api.interceptors.response.use(
  (response) => {
    return response;
  },
  (error: AxiosError) => {
    // 统一错误处理
    if (error.response) {
      // 服务器返回了错误状态码
      const status = error.response.status;
      const data = error.response.data as { detail?: string };
      
      switch (status) {
        case 400:
          message.error(data.detail || '请求参数错误');
          break;
        case 401:
          message.error('未授权，请重新登录');
          // 可以在这里处理登录跳转
          break;
        case 403:
          message.error('没有权限访问');
          break;
        case 404:
          message.error('请求的资源不存在');
          break;
        case 500:
          message.error(data.detail || '服务器内部错误');
          break;
        default:
          message.error(data.detail || '请求失败');
      }
    } else if (error.request) {
      // 请求已发出，但没有收到响应
      message.error('网络错误，请检查网络连接');
    } else {
      // 请求配置出错
      message.error('请求配置错误');
    }
    
    return Promise.reject(error);
  }
);

export default api;
```

## 七、服务封装

### 7.1 聊天服务

```typescript
// services/chatService.ts
import api from './api';
import { ChatRequest, ChatResponse } from '../types/api';

export const chatService = {
  /**
   * 发送消息
   */
  async sendMessage(
    message: string,
    sessionId: string,
    userId: string
  ): Promise<ChatResponse> {
    const request: ChatRequest = {
      message,
      session_id: sessionId,
      user_id: userId,
    };
    
    const response = await api.post<ChatResponse>('/api/chat', request);
    return response.data;
  },
};
```

### 7.2 健康检查服务

```typescript
// services/healthService.ts
import api from './api';
import { HealthResponse, DatabaseHealthResponse } from '../types/api';

export const healthService = {
  /**
   * 检查服务健康状态
   */
  async checkHealth(): Promise<HealthResponse> {
    const response = await api.get<HealthResponse>('/health', {
      timeout: 5000,
    });
    return response.data;
  },

  /**
   * 检查数据库健康状态
   */
  async checkDatabaseHealth(): Promise<DatabaseHealthResponse> {
    const response = await api.get<DatabaseHealthResponse>('/health/db', {
      timeout: 5000,
    });
    return response.data;
  },
};
```

## 八、错误处理策略

### 8.1 错误类型

```typescript
// 自定义错误类
export class ApiError extends Error {
  constructor(
    message: string,
    public statusCode?: number,
    public originalError?: unknown
  ) {
    super(message);
    this.name = 'ApiError';
  }
}
```

### 8.2 错误处理工具函数

```typescript
// utils/errorHandler.ts
import { AxiosError } from 'axios';
import { ApiError } from './ApiError';

export function handleApiError(error: unknown): ApiError {
  if (error instanceof ApiError) {
    return error;
  }

  if (axios.isAxiosError(error)) {
    if (error.code === 'ECONNABORTED') {
      return new ApiError('请求超时，请稍后重试', 408, error);
    } else if (error.response) {
      const status = error.response.status;
      const data = error.response.data as { detail?: string };
      return new ApiError(
        data.detail || `请求失败 (${status})`,
        status,
        error
      );
    } else if (error.request) {
      return new ApiError('无法连接到服务器', 0, error);
    }
  }

  return new ApiError(
    error instanceof Error ? error.message : '未知错误',
    undefined,
    error
  );
}
```

## 九、环境变量配置

### 9.1 环境变量文件

```bash
# .env.development
VITE_API_BASE_URL=http://localhost:8001

# .env.production
VITE_API_BASE_URL=https://your-production-domain.com
```

### 9.2 类型定义

```typescript
// vite-env.d.ts
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_API_BASE_URL: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

## 十、测试用例示例

### 10.1 聊天接口测试

```typescript
// 测试发送消息
describe('ChatService', () => {
  it('should send message successfully', async () => {
    const response = await chatService.sendMessage(
      '你好',
      'test-session-id',
      'test-user-id'
    );
    
    expect(response).toHaveProperty('response');
    expect(response).toHaveProperty('current_intent');
    expect(response).toHaveProperty('current_agent');
  });
});
```

## 十一、接口文档更新说明

- 当后端接口发生变化时，需要同步更新本文档
- 建议使用OpenAPI/Swagger规范生成接口文档（如果后端支持）
- 接口版本管理：如果未来需要支持多版本API，可以在URL中添加版本号，如 `/api/v1/chat`

