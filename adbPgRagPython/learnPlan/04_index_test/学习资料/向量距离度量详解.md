# 向量距离度量详解

## 📖 目录

1. [概述](#概述)
2. [欧氏距离（L2 距离）](#欧氏距离l2-距离)
3. [余弦相似度](#余弦相似度)
4. [内积（点积）](#内积点积)
5. [三种距离度量的对比](#三种距离度量的对比)
6. [如何选择距离度量](#如何选择距离度量)
7. [在 pgvector 中的使用](#在-pgvector-中的使用)
8. [距离度量对索引的影响](#距离度量对索引的影响)

---

## 概述

在向量相似度搜索中，**距离度量**（Distance Metric）用于衡量两个向量之间的相似程度。不同的距离度量适用于不同的场景，选择合适的距离度量对搜索精度和性能至关重要。

### 常见的距离度量

1. **欧氏距离**（Euclidean Distance / L2 Distance）
2. **余弦相似度**（Cosine Similarity）
3. **内积**（Inner Product / Dot Product）

---

## 欧氏距离（L2 距离）

### 定义

欧氏距离是**多维空间中两点之间的直线距离**，也就是我们通常所说的"几何距离"。

### 数学公式

对于两个 n 维向量 **a** 和 **b**：

```
欧氏距离 = √[(a₁ - b₁)² + (a₂ - b₂)² + ... + (aₙ - bₙ)²]

简化形式：d(a, b) = ||a - b||₂ = √(Σ(aᵢ - bᵢ)²)
```

### 几何意义

```
        b (x₂, y₂)
         ●
        /|
       / |
      /  |
     /   |
    /    |
   ●─────●
a (x₁, y₁)     距离 = √[(x₂-x₁)² + (y₂-y₁)²]
```

**物理意义**：
- 衡量两个向量在向量空间中的**绝对距离**
- 距离越小，向量越相似

### 计算示例

```python
import numpy as np

# 两个 3 维向量
a = np.array([1, 2, 3])
b = np.array([4, 5, 6])

# 计算欧氏距离
euclidean_distance = np.linalg.norm(a - b)
print(f"欧氏距离: {euclidean_distance:.2f}")  # 输出: 5.20

# 手动计算
distance = np.sqrt(np.sum((a - b) ** 2))
print(f"手动计算: {distance:.2f}")  # 输出: 5.20
```

### 特点

✅ **优点**：
- 直观易懂，符合人类的几何直觉
- 考虑向量的**绝对大小**和**方向**
- 对向量的大小敏感（能区分"大向量"和"小向量"）

❌ **缺点**：
- 受向量维度影响（高维空间中所有点距离都很远）
- 对向量的大小敏感（可能不是我们想要的）

### 适用场景

✅ **适合使用欧氏距离**：
- 向量表示**实际测量值**（如温度、价格、坐标）
- 需要考虑向量的**绝对大小**
- 例如：图像特征向量、物理测量数据

❌ **不适合使用欧氏距离**：
- 向量只表示**方向**（如词向量、语义向量）
- 需要忽略向量的大小，只关注方向相似性
- 例如：文本语义相似度搜索

---

## 余弦相似度

### 定义

余弦相似度通过**计算两个向量的夹角余弦值**来衡量相似度。

### 数学公式

对于两个 n 维向量 **a** 和 **b**：

```
余弦相似度 = (a · b) / (||a|| × ||b||)

其中：
- a · b = Σ(aᵢ × bᵢ)  (内积)
- ||a|| = √(Σaᵢ²)     (向量 a 的模长)
- ||b|| = √(Σbᵢ²)     (向量 b 的模长)
```

**取值范围**：[-1, 1]
- **1**：完全相似（方向相同）
- **0**：正交（垂直）
- **-1**：完全相反（方向相反）

**通常转化为距离**（相似度越大，距离越小）：
```
余弦距离 = 1 - 余弦相似度
```

### 几何意义

```
        b
        /
       /
      /
     /
    / θ
   /
  /
 a

余弦相似度 = cos(θ)
```

**物理意义**：
- 衡量两个向量的**方向相似性**
- **不考虑向量的大小**，只关注方向
- 方向越接近，相似度越高

### 计算示例

```python
import numpy as np
from numpy.linalg import norm

# 两个向量
a = np.array([1, 2, 3])
b = np.array([2, 4, 6])  # b 是 a 的 2 倍（方向相同）

# 计算余弦相似度
cosine_similarity = np.dot(a, b) / (norm(a) * norm(b))
print(f"余弦相似度: {cosine_similarity:.2f}")  # 输出: 1.00（完全相似）

# 余弦距离
cosine_distance = 1 - cosine_similarity
print(f"余弦距离: {cosine_distance:.2f}")  # 输出: 0.00
```

### 特点

✅ **优点**：
- **不受向量大小影响**（归一化后）
- 适合衡量**方向相似性**
- 对高维数据更稳定
- 适合文本、语义等场景

❌ **缺点**：
- 忽略向量的绝对大小
- 可能不适合需要区分"大小"的场景

### 适用场景

✅ **适合使用余弦相似度**：
- **文本语义搜索**（词向量、句子向量）
- **推荐系统**（用户偏好向量）
- **图像检索**（特征向量方向更重要）
- **Embedding 向量**（通常已经归一化）
- 例如：RAG 检索、语义搜索、相似文档查找

❌ **不适合使用余弦相似度**：
- 需要区分向量大小的场景
- 向量表示实际数值测量

---

## 内积（点积）

### 定义

内积（点积）是**两个向量对应元素相乘后求和**。

### 数学公式

对于两个 n 维向量 **a** 和 **b**：

```
内积 = a · b = Σ(aᵢ × bᵢ) = a₁b₁ + a₂b₂ + ... + aₙbₙ
```

**取值范围**：(-∞, +∞)
- **正值**：向量方向相似
- **负值**：向量方向相反
- **0**：向量正交

**注意**：内积不是严格的距离度量（不满足三角不等式），但可以作为相似度指标。

### 几何意义

```
内积 = ||a|| × ||b|| × cos(θ)

其中 θ 是两个向量的夹角
```

**物理意义**：
- 同时考虑向量的**大小**和**方向**
- 大向量之间的内积更大
- 方向相同的向量内积为正

### 计算示例

```python
import numpy as np

# 两个向量
a = np.array([1, 2, 3])
b = np.array([2, 4, 6])

# 计算内积
inner_product = np.dot(a, b)
print(f"内积: {inner_product}")  # 输出: 28

# 手动计算
inner_product_manual = np.sum(a * b)
print(f"手动计算: {inner_product_manual}")  # 输出: 28
```

### 特点

✅ **优点**：
- 计算简单快速
- 同时考虑大小和方向
- 在特定场景下效果好

❌ **缺点**：
- 不是严格的距离度量
- 受向量大小影响大
- 需要向量归一化才能正确使用

### 适用场景

✅ **适合使用内积**：
- 向量已经**归一化**（模长为 1）
- 在归一化情况下，内积 ≈ 余弦相似度
- 例如：归一化的 embedding 向量

❌ **不适合使用内积**：
- 向量未归一化
- 需要严格的距离度量

---

## 三种距离度量的对比

### 对比表

| 特性 | 欧氏距离 | 余弦相似度 | 内积 |
|------|---------|-----------|------|
| **考虑方向** | ✅ | ✅ | ✅ |
| **考虑大小** | ✅ | ❌ | ✅ |
| **取值范围** | [0, +∞) | [-1, 1] | (-∞, +∞) |
| **归一化需求** | ❌ | ✅ 推荐 | ✅ 必需 |
| **计算复杂度** | O(n) | O(n) | O(n) |
| **适用场景** | 实际测量值 | 方向相似性 | 归一化向量 |

### 示例对比

```python
import numpy as np
from numpy.linalg import norm

# 示例向量
a = np.array([1, 2, 3])
b = np.array([2, 4, 6])    # b 是 a 的 2 倍
c = np.array([-1, -2, -3]) # c 与 a 方向相反

print("向量 a:", a)
print("向量 b:", b)
print("向量 c:", c)

# 欧氏距离
print("\n=== 欧氏距离 ===")
print(f"d(a, b) = {norm(a - b):.2f}")  # 输出: 3.74
print(f"d(a, c) = {norm(a - c):.2f}")  # 输出: 5.48

# 余弦相似度
print("\n=== 余弦相似度 ===")
cos_ab = np.dot(a, b) / (norm(a) * norm(b))
cos_ac = np.dot(a, c) / (norm(a) * norm(c))
print(f"cos(a, b) = {cos_ab:.2f}")  # 输出: 1.00（方向相同）
print(f"cos(a, c) = {cos_ac:.2f}")  # 输出: -1.00（方向相反）

# 内积
print("\n=== 内积 ===")
print(f"a · b = {np.dot(a, b)}")  # 输出: 28
print(f"a · c = {np.dot(a, c)}")  # 输出: -14
```

**观察结果**：
- **欧氏距离**：a 和 b 有距离（因为大小不同）
- **余弦相似度**：a 和 b 完全相似（方向相同）
- **内积**：a 和 b 的内积更大（因为 b 更大）

---

## 如何选择距离度量

### 决策流程图

```
开始
  ↓
向量是否已经归一化？
  ├─ 是 → 使用余弦相似度或内积
  └─ 否 → 
       ↓
    需要区分向量大小？
       ├─ 是 → 使用欧氏距离
       └─ 否 → 先归一化，再使用余弦相似度
```

### 场景选择指南

#### 1. **文本语义搜索**
- **推荐**：余弦相似度
- **原因**：文本 embedding 关注语义方向，不关注向量大小
- **示例**：RAG 检索、文档相似度

#### 2. **图像特征搜索**
- **推荐**：余弦相似度或欧氏距离（取决于特征提取方式）
- **原因**：
  - 归一化的特征向量 → 余弦相似度
  - 原始特征值 → 欧氏距离
- **示例**：相似图片搜索、图像检索

#### 3. **推荐系统**
- **推荐**：余弦相似度
- **原因**：关注用户偏好方向，而非绝对评分大小
- **示例**：用户画像匹配、商品推荐

#### 4. **物理测量数据**
- **推荐**：欧氏距离
- **原因**：需要考虑绝对数值差异
- **示例**：温度、价格、坐标

#### 5. **归一化的 Embedding 向量**
- **推荐**：余弦相似度或内积（等价）
- **原因**：归一化后内积 = 余弦相似度
- **示例**：大多数现代 embedding 模型（如 OpenAI、Cohere）

---

## 在 pgvector 中的使用

### 1. 创建索引时指定距离操作符

```sql
-- 使用余弦距离创建索引
CREATE INDEX ON items 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 使用欧氏距离创建索引
CREATE INDEX ON items 
USING hnsw (embedding vector_l2_ops)
WITH (m = 16, ef_construction = 64);

-- 使用内积创建索引
CREATE INDEX ON items 
USING hnsw (embedding vector_ip_ops)
WITH (m = 16, ef_construction = 64);
```

### 2. 查询时使用对应的操作符

```sql
-- 余弦距离查询（<=> 操作符）
SELECT id, name, embedding <=> query_vector AS distance
FROM items
ORDER BY embedding <=> query_vector
LIMIT 10;

-- 欧氏距离查询（<-> 操作符）
SELECT id, name, embedding <-> query_vector AS distance
FROM items
ORDER BY embedding <-> query_vector
LIMIT 10;

-- 内积查询（<#> 操作符，注意：内积越小越相似）
SELECT id, name, embedding <#> query_vector AS distance
FROM items
ORDER BY embedding <#> query_vector
LIMIT 10;
```

### 3. pgvector 中的操作符对照表

| 距离度量 | 操作符 | 操作符名称 | 说明 |
|---------|--------|-----------|------|
| **余弦距离** | `<=>` | `vector_cosine_ops` | 距离越小越相似 |
| **欧氏距离** | `<->` | `vector_l2_ops` | 距离越小越相似 |
| **内积** | `<#>` | `vector_ip_ops` | **值越小越相似**（注意：这是负内积） |

### 4. 重要注意事项

⚠️ **索引和查询必须使用相同的距离度量**：

```sql
-- ✅ 正确：索引和查询使用相同的距离度量
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops);
SELECT * FROM items ORDER BY embedding <=> query_vector LIMIT 10;

-- ❌ 错误：索引和查询使用了不同的距离度量
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops);
SELECT * FROM items ORDER BY embedding <-> query_vector LIMIT 10;  -- 不会使用索引！
```

⚠️ **内积的特殊性**：
- pgvector 中的 `<#>` 操作符实际上是 `-1 * 内积`
- 所以值越小，相似度越高
- 适用于归一化向量（内积 ≈ 余弦相似度）

### 5. 完整示例

```sql
-- 1. 创建表
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(768)  -- 768 维向量
);

-- 2. 插入数据（假设使用文本 embedding，已经归一化）
INSERT INTO documents (content, embedding) VALUES
    ('文档1', '[0.1, 0.2, 0.3, ...]'::vector),
    ('文档2', '[0.2, 0.3, 0.4, ...]'::vector);

-- 3. 创建余弦距离索引（推荐用于文本 embedding）
CREATE INDEX documents_embedding_idx ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 4. 查询相似文档
SET hnsw.ef_search = 40;
SELECT id, content, embedding <=> query_vector AS similarity
FROM documents
ORDER BY embedding <=> query_vector
LIMIT 10;
```

---

## 距离度量对索引的影响

### 1. 对索引构建的影响

不同的距离度量在索引构建时需要计算不同的距离：
- **计算复杂度**：基本相同（都是 O(n)）
- **数值范围**：可能影响索引参数的调优
- **精度要求**：可能影响 ef_construction 的选择

### 2. 对查询精度的影响

| 距离度量 | 查询精度 | 说明 |
|---------|---------|------|
| **余弦相似度** | ⭐⭐⭐⭐⭐ | 适合高维归一化向量，精度高 |
| **欧氏距离** | ⭐⭐⭐⭐ | 精度较高，但高维空间可能精度下降 |
| **内积** | ⭐⭐⭐⭐ | 在归一化向量上，精度与余弦相似度相当 |

### 3. 对查询速度的影响

查询速度主要取决于：
- 索引类型（HNSW vs IVFFlat）
- 索引参数（m, ef_search 等）
- **距离度量的影响较小**（都是 O(n) 计算）

### 4. 最佳实践

1. **根据数据类型选择**：
   - 文本 embedding → 余弦相似度
   - 图像特征 → 余弦相似度或欧氏距离
   - 物理测量 → 欧氏距离

2. **确保向量归一化**（如果使用余弦相似度）：
   ```python
   # Python 示例
   import numpy as np
   
   def normalize_vector(v):
       norm = np.linalg.norm(v)
       return v / norm if norm > 0 else v
   
   embedding = normalize_vector(embedding)
   ```

3. **索引和查询保持一致**：
   - 创建索引时选择的操作符必须与查询时一致

4. **测试和对比**：
   - 在实际数据上测试不同距离度量的效果
   - 选择召回率最高的距离度量

---

## 总结

### 核心要点

1. **三种距离度量的特点**：
   - **欧氏距离**：考虑绝对大小和方向
   - **余弦相似度**：只考虑方向，忽略大小
   - **内积**：同时考虑大小和方向（需归一化）

2. **选择原则**：
   - 文本/语义向量 → 余弦相似度
   - 归一化 embedding → 余弦相似度或内积
   - 实际测量值 → 欧氏距离

3. **在 pgvector 中**：
   - 索引和查询必须使用相同的距离度量
   - 使用对应的操作符（<=>, <->, <#>）

### 学习建议

1. **理解数学原理**：掌握每种距离度量的计算公式
2. **实际测试**：在自己的数据上测试不同距离度量的效果
3. **结合场景**：根据实际应用场景选择最合适的距离度量
4. **查阅文档**：参考 embedding 模型文档，了解推荐的距离度量

---

## 参考资源

- **pgvector 官方文档**：https://github.com/pgvector/pgvector#distance-operators
- **数学参考**：
  - 《线性代数》- 向量空间和距离
  - 《机器学习》- 距离度量章节
- **实践指南**：
  - 《向量检索技术详解》
  - 《Embedding 向量相似度计算》

---

**最后更新**：2025年1月

