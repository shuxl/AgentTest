# çœŸå®æ•°æ®æµ‹è¯•ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä½¿ç”¨çœŸå®æ–‡æœ¬æ•°æ®ï¼ˆè€Œééšæœºå‘é‡ï¼‰è¿›è¡Œç´¢å¼•æ€§èƒ½æµ‹è¯•å’ŒæŸ¥è¯¢ç²¾åº¦è¯„ä¼°ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦çœŸå®æ•°æ®ï¼Ÿ

1. **æŸ¥è¯¢ç²¾åº¦è¯„ä¼°**ï¼šåªæœ‰çœŸå®æ•°æ®æ‰èƒ½è¯„ä¼°æŸ¥è¯¢çš„å¬å›ç‡ï¼ˆRecall@Kï¼‰
2. **çœŸå®åœºæ™¯æ¨¡æ‹Ÿ**ï¼šçœŸå® embedding å‘é‡å…·æœ‰èšç±»ç‰¹å¾ï¼Œæ›´æ¥è¿‘ç”Ÿäº§ç¯å¢ƒ
3. **å‚æ•°è°ƒä¼˜éªŒè¯**ï¼šåœ¨çœŸå®æ•°æ®ä¸Šè°ƒä¼˜çš„å‚æ•°æ‰çœŸæ­£æœ‰æ•ˆ

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šç”ŸæˆçœŸå®æ–‡æœ¬å‘é‡æ•°æ®

æœ‰ä¸‰ç§æ–¹å¼å‡†å¤‡æ•°æ®ï¼š

#### æ–¹å¼1ï¼šä½¿ç”¨é¢„è®¾ç¤ºä¾‹æ–‡æœ¬ï¼ˆæ¨èç”¨äºå¿«é€Ÿæµ‹è¯•ï¼‰

```bash
cd adbPgRagPython/learnPlan/04_index_test
conda activate py_311_rag

# ç”Ÿæˆ 1000 æ¡ç¤ºä¾‹æ–‡æœ¬å‘é‡
python data_generation/generate_text_vectors.py --sample --count 1000
```

#### æ–¹å¼2ï¼šä»æ–‡æœ¬æ–‡ä»¶è¯»å–

```bash
# å‡†å¤‡ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡Œä¸€ä¸ªæ–‡æœ¬
echo -e "è¿™æ˜¯ç¬¬ä¸€æ¡æµ‹è¯•æ–‡æœ¬\nè¿™æ˜¯ç¬¬äºŒæ¡æµ‹è¯•æ–‡æœ¬" > test_queries.txt

# ä»æ–‡ä»¶ç”Ÿæˆå‘é‡
python data_generation/generate_text_vectors.py --file test_queries.txt
```

#### æ–¹å¼3ï¼šä»ç›®å½•è¯»å–æ‰€æœ‰æ–‡æœ¬æ–‡ä»¶

```bash
# ä»æŒ‡å®šç›®å½•è¯»å–æ‰€æœ‰ .txt å’Œ .md æ–‡ä»¶
python data_generation/generate_text_vectors.py --dir /path/to/text/files

# å¦‚æœæ–‡æœ¬å¾ˆé•¿ï¼Œå¯ä»¥åˆ†å—å¤„ç†
python data_generation/generate_text_vectors.py \
    --dir /path/to/text/files \
    --chunk-size 512 \
    --chunk-overlap 50
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç´¢å¼•å¹¶æµ‹è¯•æ€§èƒ½

```bash
# åˆ›å»º HNSW ç´¢å¼•
python performance_testing/test_hnsw_index.py \
    --table-name index_test_items \
    --m 16 \
    --ef-construction 64 \
    --ef-search 40 \
    --num-queries 100
```

### ç¬¬ä¸‰æ­¥ï¼šè¯„ä¼°æŸ¥è¯¢ç²¾åº¦

```bash
# è¯„ä¼°æŸ¥è¯¢ç²¾åº¦ï¼ˆå¬å›ç‡ï¼‰
python performance_testing/query_accuracy.py \
    --table-name index_test_items \
    --k 10 \
    --ef-search 40 \
    --num-queries 50 \
    --sample-queries
```

---

## ğŸ“– è¯¦ç»†ä½¿ç”¨è¯´æ˜

### 1. æ•°æ®ç”Ÿæˆè„šæœ¬ï¼š`generate_text_vectors.py`

#### ä¸»è¦å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--sample` | ä½¿ç”¨é¢„è®¾ç¤ºä¾‹æ–‡æœ¬ | `--sample --count 1000` |
| `--file` | ä»æ–‡æœ¬æ–‡ä»¶è¯»å– | `--file queries.txt` |
| `--dir` | ä»ç›®å½•è¯»å– | `--dir ./documents` |
| `--count` | ç”Ÿæˆæ•°é‡ï¼ˆä»…ç”¨äº --sampleï¼‰ | `--count 5000` |
| `--table-name` | è¡¨å | `--table-name my_test_table` |
| `--chunk-size` | æ–‡æœ¬åˆ†å—å¤§å° | `--chunk-size 512` |
| `--chunk-overlap` | åˆ†å—é‡å å¤§å° | `--chunk-overlap 50` |
| `--drop-existing` | åˆ é™¤å·²å­˜åœ¨çš„è¡¨ | `--drop-existing` |

#### ä½¿ç”¨ç¤ºä¾‹

```bash
# ç¤ºä¾‹1ï¼šå¿«é€Ÿç”Ÿæˆ 5000 æ¡æµ‹è¯•æ•°æ®
python data_generation/generate_text_vectors.py \
    --sample \
    --count 5000 \
    --table-name test_5000_items

# ç¤ºä¾‹2ï¼šä»æ–‡ä»¶ç”Ÿæˆï¼Œå¹¶åˆ é™¤æ—§è¡¨
python data_generation/generate_text_vectors.py \
    --file my_documents.txt \
    --table-name my_docs \
    --drop-existing

# ç¤ºä¾‹3ï¼šä»ç›®å½•è¯»å–ï¼Œå¤„ç†é•¿æ–‡æœ¬
python data_generation/generate_text_vectors.py \
    --dir /path/to/long/documents \
    --chunk-size 512 \
    --chunk-overlap 50 \
    --table-name chunked_docs
```

---

### 2. æŸ¥è¯¢ç²¾åº¦è¯„ä¼°ï¼š`query_accuracy.py`

#### ä¸»è¦åŠŸèƒ½

- **å¬å›ç‡@K (Recall@K)**ï¼šè¯„ä¼°ç´¢å¼•æ‰¾åˆ°çš„çœŸå®æœ€è¿‘é‚»æ¯”ä¾‹
- **ç²¾ç¡®ç‡@K (Precision@K)**ï¼šè¯„ä¼°è¿”å›ç»“æœä¸­çœŸå®æœ€è¿‘é‚»çš„æ¯”ä¾‹
- **æŸ¥è¯¢æ€§èƒ½**ï¼šè¯„ä¼°æŸ¥è¯¢å»¶è¿Ÿ

#### ä¸»è¦å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--table-name` | è¡¨å | `index_test_items` |
| `--k` | Top-K ç»“æœæ•° | `10` |
| `--ef-search` | HNSW ef_search å‚æ•° | `40` |
| `--num-queries` | è¯„ä¼°æŸ¥è¯¢æ•°é‡ | `50` |
| `--query-file` | æŸ¥è¯¢æ–‡æœ¬æ–‡ä»¶ | æ— ï¼ˆä½¿ç”¨ç¤ºä¾‹æŸ¥è¯¢ï¼‰ |
| `--sample-queries` | ä»è¡¨ä¸­éšæœºé‡‡æ ·æŸ¥è¯¢ | `False` |
| `--distance-op` | è·ç¦»æ“ä½œç¬¦ | `<=>` |

#### ä½¿ç”¨ç¤ºä¾‹

```bash
# ç¤ºä¾‹1ï¼šä½¿ç”¨é¢„è®¾æŸ¥è¯¢è¯„ä¼°ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰
python performance_testing/query_accuracy.py \
    --table-name index_test_items \
    --k 10 \
    --ef-search 40 \
    --num-queries 50

# ç¤ºä¾‹2ï¼šä»æ–‡ä»¶è¯»å–æŸ¥è¯¢
echo -e "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ\næœºå™¨å­¦ä¹ çš„åŸºæœ¬åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ" > queries.txt
python performance_testing/query_accuracy.py \
    --table-name index_test_items \
    --query-file queries.txt \
    --k 10

# ç¤ºä¾‹3ï¼šä»è¡¨ä¸­éšæœºé‡‡æ ·æŸ¥è¯¢ï¼ˆæ¨èï¼‰
python performance_testing/query_accuracy.py \
    --table-name index_test_items \
    --sample-queries \
    --num-queries 100 \
    --ef-search 100 \
    --k 20
```

#### è¾“å‡ºè¯´æ˜

```
è¯„ä¼°ç»“æœ
============================================================
æŸ¥è¯¢æ•°é‡: 50

å¬å›ç‡@K (Recall@10):
  å¹³å‡: 0.8500 (85.00%)
  ä¸­ä½æ•°: 0.9000 (90.00%)
  æœ€å°å€¼: 0.6000
  æœ€å¤§å€¼: 1.0000

ç²¾ç¡®ç‡@K (Precision@10):
  å¹³å‡: 0.8200 (82.00%)
  ä¸­ä½æ•°: 0.8500 (85.00%)

æŸ¥è¯¢æ€§èƒ½:
  å¹³å‡æŸ¥è¯¢æ—¶é—´: 15.23 ms
  ä¸­ä½æ•°æŸ¥è¯¢æ—¶é—´: 14.50 ms
  P95 æŸ¥è¯¢æ—¶é—´: 18.50 ms
```

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šæµ‹è¯•ä¸åŒ ef_search å€¼å¯¹æŸ¥è¯¢ç²¾åº¦çš„å½±å“

```bash
# 1. ç”ŸæˆçœŸå®æ•°æ®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
python data_generation/generate_text_vectors.py \
    --sample --count 10000 \
    --table-name accuracy_test

# 2. åˆ›å»ºç´¢å¼•
python performance_testing/test_hnsw_index.py \
    --table-name accuracy_test \
    --m 16 \
    --ef-construction 64 \
    --skip-query

# 3. æµ‹è¯•ä¸åŒ ef_search å€¼çš„ç²¾åº¦
for ef in 20 40 100 200; do
    echo "æµ‹è¯• ef_search=$ef"
    python performance_testing/query_accuracy.py \
        --table-name accuracy_test \
        --ef-search $ef \
        --k 10 \
        --num-queries 50 \
        --sample-queries
    echo "---"
done
```

### åœºæ™¯ï¼šå¯¹æ¯”éšæœºå‘é‡å’ŒçœŸå®æ•°æ®çš„å·®å¼‚

```bash
# 1. ç”Ÿæˆéšæœºå‘é‡æ•°æ®
python data_generation/generate_test_data.py \
    --count 10000 \
    --table-name random_test

# 2. ç”ŸæˆçœŸå®æ–‡æœ¬å‘é‡æ•°æ®
python data_generation/generate_text_vectors.py \
    --sample --count 10000 \
    --table-name real_test

# 3. åˆ†åˆ«æµ‹è¯•æ€§èƒ½
python performance_testing/test_hnsw_index.py --table-name random_test
python performance_testing/test_hnsw_index.py --table-name real_test

# 4. è¯„ä¼°çœŸå®æ•°æ®çš„ç²¾åº¦ï¼ˆéšæœºæ•°æ®æ— æ³•è¯„ä¼°ç²¾åº¦ï¼‰
python performance_testing/query_accuracy.py --table-name real_test
```

---

## ğŸ“Š è¯„ä¼°æŒ‡æ ‡è¯´æ˜

### å¬å›ç‡@K (Recall@K)

**å®šä¹‰**ï¼šæŸ¥è¯¢ç»“æœä¸­åŒ…å«çœŸå®æœ€è¿‘é‚»çš„æ¯”ä¾‹

```
Recall@K = |æŸ¥è¯¢ç»“æœ âˆ© çœŸå®æœ€è¿‘é‚»| / min(K, |çœŸå®æœ€è¿‘é‚»|)
```

**æ„ä¹‰**ï¼š
- å¬å›ç‡è¶Šé«˜ï¼Œè¯´æ˜ç´¢å¼•æ‰¾åˆ°çš„çœŸå®æœ€è¿‘é‚»è¶Šå¤š
- ç†æƒ³æƒ…å†µä¸‹ï¼Œå¬å›ç‡åº”è¯¥æ¥è¿‘ 1.0ï¼ˆ100%ï¼‰
- å¬å›ç‡ä½å¯èƒ½æ„å‘³ç€ `ef_search` å‚æ•°è®¾ç½®è¿‡å°

### ç²¾ç¡®ç‡@K (Precision@K)

**å®šä¹‰**ï¼šè¿”å›ç»“æœä¸­çœŸå®æœ€è¿‘é‚»çš„æ¯”ä¾‹

```
Precision@K = |æŸ¥è¯¢ç»“æœ âˆ© çœŸå®æœ€è¿‘é‚»| / min(K, |æŸ¥è¯¢ç»“æœ|)
```

**æ„ä¹‰**ï¼š
- ç²¾ç¡®ç‡è¶Šé«˜ï¼Œè¯´æ˜è¿”å›ç»“æœçš„å‡†ç¡®æ€§è¶Šé«˜
- ç†æƒ³æƒ…å†µä¸‹ï¼Œç²¾ç¡®ç‡åº”è¯¥æ¥è¿‘ 1.0ï¼ˆ100%ï¼‰

### å¦‚ä½•æé«˜ç²¾åº¦ï¼Ÿ

1. **å¢å¤§ ef_search**ï¼š
   ```bash
   # ef_search è¶Šå¤§ï¼Œå¬å›ç‡è¶Šé«˜ï¼Œä½†æŸ¥è¯¢è¶Šæ…¢
   python performance_testing/query_accuracy.py --ef-search 200
   ```

2. **ä¼˜åŒ–ç´¢å¼•å‚æ•°**ï¼š
   - å¢å¤§ `m`ï¼šæé«˜ç´¢å¼•è´¨é‡ï¼Œä½†æ„å»ºæ—¶é—´æ›´é•¿
   - å¢å¤§ `ef_construction`ï¼šæé«˜ç´¢å¼•è´¨é‡ï¼Œä½†æ„å»ºæ—¶é—´æ›´é•¿

3. **å¹³è¡¡ç²¾åº¦å’Œé€Ÿåº¦**ï¼š
   - æµ‹è¯•ä¸åŒå‚æ•°ç»„åˆï¼Œæ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹
   - è®°å½•æµ‹è¯•ç»“æœï¼Œé€‰æ‹©æ»¡è¶³ä¸šåŠ¡éœ€æ±‚çš„å‚æ•°

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ•°æ®å‡†å¤‡

- **å°è§„æ¨¡æµ‹è¯•**ï¼šä½¿ç”¨ `--sample --count 1000` å¿«é€Ÿç”Ÿæˆæ•°æ®
- **ä¸­ç­‰è§„æ¨¡æµ‹è¯•**ï¼šä½¿ç”¨ `--sample --count 10000` æˆ–ä»æ–‡ä»¶è¯»å–
- **å¤§è§„æ¨¡æµ‹è¯•**ï¼šä»ç›®å½•è¯»å–çœŸå®æ–‡æ¡£ï¼Œä½¿ç”¨åˆ†å—å¤„ç†é•¿æ–‡æœ¬

### 2. ç²¾åº¦è¯„ä¼°

- **åˆå§‹è¯„ä¼°**ï¼šä½¿ç”¨ 50-100 ä¸ªæŸ¥è¯¢å¿«é€Ÿè¯„ä¼°
- **è¯¦ç»†è¯„ä¼°**ï¼šä½¿ç”¨ 200+ ä¸ªæŸ¥è¯¢è·å¾—æ›´å‡†ç¡®çš„ç»Ÿè®¡ç»“æœ
- **å¯¹æ¯”æµ‹è¯•**ï¼šå›ºå®šå…¶ä»–å‚æ•°ï¼Œåªæ”¹å˜ `ef_search` è¿›è¡Œå¯¹æ¯”

### 3. å‚æ•°è°ƒä¼˜æµç¨‹

1. **ç”ŸæˆçœŸå®æ•°æ®**ï¼ˆ10000-50000 æ¡ï¼‰
2. **åˆ›å»ºç´¢å¼•**ï¼ˆä½¿ç”¨é»˜è®¤æˆ–æ¨èçš„å‚æ•°ï¼‰
3. **è¯„ä¼°åŸºçº¿ç²¾åº¦**ï¼ˆè®°å½•å¬å›ç‡å’ŒæŸ¥è¯¢æ—¶é—´ï¼‰
4. **è°ƒæ•´å‚æ•°**ï¼ˆå¦‚å¢å¤§ `ef_search`ï¼‰
5. **é‡æ–°è¯„ä¼°**ï¼ˆå¯¹æ¯”ç²¾åº¦å’Œæ€§èƒ½ï¼‰
6. **é€‰æ‹©æœ€ä¼˜å‚æ•°**ï¼ˆå¹³è¡¡ç²¾åº¦å’Œé€Ÿåº¦ï¼‰

---

## â“ å¸¸è§é—®é¢˜

### Q1: ç²¾åº¦è¯„ä¼°å¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

**A**: ç²¾åº¦è¯„ä¼°éœ€è¦æš´åŠ›æœç´¢è®¡ç®—çœŸå®æœ€è¿‘é‚»ï¼Œç¡®å®è¾ƒæ…¢ã€‚å»ºè®®ï¼š
- å‡å°‘è¯„ä¼°æŸ¥è¯¢æ•°é‡ï¼ˆ`--num-queries 20`ï¼‰
- ä½¿ç”¨è¾ƒå°çš„ K å€¼ï¼ˆ`--k 5`ï¼‰
- å…ˆåœ¨è¾ƒå°æ•°æ®é›†ä¸Šæµ‹è¯•ï¼ˆ1000-5000 æ¡ï¼‰

### Q2: å¬å›ç‡æ€»æ˜¯å¾ˆä½æ€ä¹ˆåŠï¼Ÿ

**A**: å¯èƒ½çš„åŸå› ï¼š
1. `ef_search` å¤ªå°ï¼šå°è¯•å¢å¤§åˆ° 100-200
2. ç´¢å¼•å‚æ•°ä¸åˆé€‚ï¼šå°è¯•å¢å¤§ `m` å’Œ `ef_construction`
3. æ•°æ®è´¨é‡é—®é¢˜ï¼šæ£€æŸ¥ embedding æ¨¡å‹å’Œæ•°æ®è´¨é‡

### Q3: å¯ä»¥è¯„ä¼°éšæœºå‘é‡æ•°æ®çš„ç²¾åº¦å—ï¼Ÿ

**A**: æŠ€æœ¯ä¸Šå¯ä»¥ï¼Œä½†**æ²¡æœ‰å®é™…æ„ä¹‰**ã€‚éšæœºå‘é‡æ²¡æœ‰çœŸå®çš„è¯­ä¹‰ç›¸å…³æ€§ï¼Œè¯„ä¼°å‡ºçš„å¬å›ç‡ä¸èƒ½åæ˜ çœŸå®åœºæ™¯çš„æ€§èƒ½ã€‚

### Q4: å¦‚ä½•å‡†å¤‡è‡ªå·±çš„æ–‡æœ¬æ•°æ®ï¼Ÿ

**A**: å‡ ç§æ–¹å¼ï¼š
1. **æ–‡æœ¬æ–‡ä»¶**ï¼šå‡†å¤‡ä¸€ä¸ª `.txt` æ–‡ä»¶ï¼Œæ¯è¡Œä¸€ä¸ªæ–‡æœ¬
2. **æ–‡æ¡£ç›®å½•**ï¼šå°†æ–‡æ¡£æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è¯»å–
3. **ä»æ•°æ®åº“å¯¼å‡º**ï¼šå¦‚æœæœ‰ç°æœ‰æ•°æ®ï¼Œå¯ä»¥å¯¼å‡ºä¸ºæ–‡æœ¬æ–‡ä»¶

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [README.md](./README.md) - å®Œæ•´å­¦ä¹ æ–¹æ¡ˆ
- [QUICK_START.md](./QUICK_START.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—
- [å­¦ä¹ èµ„æ–™/HNSWç®—æ³•åŸç†è¯¦è§£.md](./å­¦ä¹ èµ„æ–™/HNSWç®—æ³•åŸç†è¯¦è§£.md) - HNSW ç®—æ³•åŸç†

---

## ğŸ“ æ€»ç»“

ä½¿ç”¨çœŸå®æ•°æ®æµ‹è¯•çš„ä¼˜åŠ¿ï¼š
1. âœ… å¯ä»¥è¯„ä¼°æŸ¥è¯¢ç²¾åº¦ï¼ˆå¬å›ç‡ï¼‰
2. âœ… æ›´æ¥è¿‘ç”Ÿäº§ç¯å¢ƒ
3. âœ… å‚æ•°è°ƒä¼˜ç»“æœæ›´æœ‰å‚è€ƒä»·å€¼

å»ºè®®å·¥ä½œæµç¨‹ï¼š
1. å…ˆç”¨éšæœºå‘é‡å¿«é€Ÿå­¦ä¹ å‚æ•°çš„å½±å“
2. å†ç”¨çœŸå®æ•°æ®éªŒè¯ç²¾åº¦å’Œæœ€ç»ˆå‚æ•°
3. åœ¨çœŸå®æ•°æ®ä¸Šè¿›è¡Œå®Œæ•´çš„å‚æ•°è°ƒä¼˜

