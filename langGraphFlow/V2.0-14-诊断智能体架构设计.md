# 1、功能描述

诊断智能体系统是专门协助医生进行患者病情诊断的智能体集群，通过细化的专业智能体提供不同科室或疾病类型的诊断支持。每个诊断智能体拥有自己的知识库和提示词，定义其专业角色和回答风格。

诊断智能体系统作为路由系统中的专门智能体之一，通过路由智能体路由调用。系统采用RAG（检索增强生成）架构，前期使用通用模型进行诊断支持，后期可升级为专业医疗模型。

# 2、需求

## 2.1 功能需求

| JIRA编号 | 产品/子系统/服务 | 功能 | 功能描述 |
| ------ | ------ | ------ | ------ |
| DIAG-001 | 诊断智能体系统 | 内科诊断支持 | 协助医生进行内科相关疾病的诊断，提供诊断建议和参考信息 |
| DIAG-002 | 诊断智能体系统 | 外科诊断支持 | 协助医生进行外科相关疾病的诊断，提供诊断建议和参考信息 |
| DIAG-003 | 诊断智能体系统 | 儿科诊断支持 | 协助医生进行儿科相关疾病的诊断，提供诊断建议和参考信息 |
| DIAG-004 | 诊断智能体系统 | 妇科诊断支持 | 协助医生进行妇科相关疾病的诊断，提供诊断建议和参考信息 |
| DIAG-005 | 诊断智能体系统 | 心血管科诊断支持 | 协助医生进行心血管相关疾病的诊断，提供诊断建议和参考信息 |
| DIAG-006 | 诊断智能体系统 | 其他科室诊断支持 | 支持扩展其他科室的诊断智能体 |

## 2.2 非功能需求

| 非功能需求 | 需求描述 |
| ------ | ------ |
| 响应 | 单次诊断支持响应时间 < 5s（包含RAG检索和LLM生成时间） |
| 准确性 | RAG检索准确率 > 80%，诊断建议相关性 > 85% |
| 扩展性 | 易于扩展新的科室诊断智能体，支持动态添加知识库 |
| 安全性 | 验证医生权限，诊断结果仅供参考，不替代医生专业判断 |
| 可靠性 | RAG检索失败时优雅降级，返回基础诊断建议 |

# 3、技术设计

## 3.1 设计思路

诊断智能体系统基于LangGraph和RAG架构实现，采用以下设计思路：

1. **细化架构**：按科室或疾病类型细分为多个专业诊断智能体
2. **RAG架构**：每个诊断智能体拥有独立的知识库，通过向量检索获取相关知识
3. **提示词定制**：每个诊断智能体有专门的系统提示词，定义角色、回答风格和专业领域
4. **模型演进**：前期使用通用模型，后期可升级为专业医疗模型
5. **知识库管理**：支持知识库的增量更新和版本管理

## 3.2 架构设计

### 3.2.1 整体架构

```
路由智能体（Router Agent）
    ↓
识别诊断意图（diagnosis）
    ↓
识别具体科室/疾病类型
    ├─→ 内科诊断智能体（Internal Medicine Diagnosis Agent）
    ├─→ 外科诊断智能体（Surgery Diagnosis Agent）
    ├─→ 儿科诊断智能体（Pediatrics Diagnosis Agent）
    ├─→ 妇科诊断智能体（Gynecology Diagnosis Agent）
    ├─→ 心血管科诊断智能体（Cardiology Diagnosis Agent）
    └─→ 其他科室诊断智能体（可扩展）
```

### 3.2.2 诊断智能体内部架构

```
用户输入（患者症状、检查结果等）
    ↓
诊断智能体节点
    ↓
RAG检索工具（retrieve_diagnosis_knowledge）
    ├─→ 向量数据库检索
    ├─→ 检索相关医学知识、病例、指南
    └─→ 返回Top-K相关文档
    ↓
LLM生成诊断建议
    ├─→ 结合检索到的知识
    ├─→ 基于系统提示词（定义角色和风格）
    └─→ 生成诊断建议和参考信息
    ↓
返回给医生
```

### 3.2.3 知识库架构

```
知识库存储
    ├─→ 向量数据库（Vector Store）
    │   ├─→ 医学教科书和指南
    │   ├─→ 典型病例库
    │   ├─→ 诊断标准
    │   └─→ 最新医学研究（可定期更新）
    │
    └─→ 元数据管理
        ├─→ 知识来源
        ├─→ 更新时间
        ├─→ 可信度评分
        └─→ 科室分类标签
```

## 3.3 诊断智能体分类

### 3.3.1 按科室分类（推荐方案）

| 智能体名称 | 意图标识 | 专业领域 | 知识库范围 |
| ------ | ------ | ------ | ------ |
| 内科诊断智能体 | internal_medicine_diagnosis | 内科常见疾病诊断 | 内科医学知识、内科病例、内科诊疗指南 |
| 外科诊断智能体 | surgery_diagnosis | 外科疾病诊断 | 外科学知识、外科病例、手术指征 |
| 儿科诊断智能体 | pediatrics_diagnosis | 儿科疾病诊断 | 儿科学知识、儿科病例、儿童生长发育 |
| 妇科诊断智能体 | gynecology_diagnosis | 妇科疾病诊断 | 妇科学知识、妇科病例、妇科诊疗指南 |
| 心血管科诊断智能体 | cardiology_diagnosis | 心血管疾病诊断 | 心血管医学知识、心血管病例、心血管指南 |
| 神经科诊断智能体 | neurology_diagnosis | 神经系统疾病诊断 | 神经科学知识、神经科病例、神经科指南 |
| 皮肤科诊断智能体 | dermatology_diagnosis | 皮肤疾病诊断 | 皮肤科学知识、皮肤科病例、皮肤科指南 |

### 3.3.2 扩展机制

系统支持动态添加新的诊断智能体：

1. **添加新的科室诊断智能体**：
   - 创建新的知识库集合
   - 配置系统提示词
   - 在路由层添加新的意图识别规则
   - 创建对应的智能体节点

2. **知识库更新**：
   - 支持增量更新知识库
   - 支持版本管理
   - 支持A/B测试不同版本的知识库

## 3.4 接口设计

### 3.4.1 工具接口

#### 功能描述：RAG检索工具

<table>
    <th colspan="4">功能描述：<span>检索诊断相关知识</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>DIAG-001 ~ DIAG-006</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">retrieve_diagnosis_knowledge</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>query</td><td>str</td><td>Y</td><td>检索查询（患者症状、检查结果等）</td>
    </tr>
    <tr>
        <td>department</td><td>str</td><td>Y</td><td>科室类型（internal_medicine/surgery/pediatrics等）</td>
    </tr>
    <tr>
        <td>top_k</td><td>int</td><td>N</td><td>返回Top-K相关文档（默认5）</td>
    </tr>
    <tr>
        <td>filter_metadata</td><td>dict</td><td>N</td><td>元数据过滤条件（如知识来源、更新时间等）</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>documents</td><td>list</td><td colspan="2">相关文档列表，每个文档包含：content（内容）、source（来源）、score（相关性得分）</td>
    </tr>
</table>

### 3.4.2 系统提示词模板

每个诊断智能体都有专门的系统提示词，定义其角色、回答风格和专业领域：

```python
def get_diagnosis_system_prompt(department: str, current_datetime: str = None) -> str:
    """
    获取诊断智能体系统提示词
    
    Args:
        department: 科室类型（internal_medicine/surgery/pediatrics等）
        current_datetime: 当前日期时间字符串
    
    Returns:
        str: 系统提示词
    """
    
    department_configs = {
        "internal_medicine": {
            "role": "内科诊断专家",
            "expertise": "内科常见疾病的诊断和鉴别诊断",
            "style": "严谨、细致，注重病史采集和症状分析",
            "focus": "重点关注症状的演变过程、伴随症状、既往病史"
        },
        "surgery": {
            "role": "外科诊断专家",
            "expertise": "外科疾病的诊断和手术指征评估",
            "style": "果断、精准，注重体征检查和影像学分析",
            "focus": "重点关注体征、影像学检查结果、手术指征"
        },
        "pediatrics": {
            "role": "儿科诊断专家",
            "expertise": "儿科疾病的诊断，考虑儿童生长发育特点",
            "style": "耐心、细致，注重儿童特殊性和家长沟通",
            "focus": "重点关注年龄特点、生长发育情况、疫苗接种史"
        },
        # ... 其他科室配置
    }
    
    config = department_configs.get(department, {})
    
    return f"""你是一位专业的{config.get('role', '诊断专家')}，协助医生进行患者病情诊断。

**你的专业领域**：
- {config.get('expertise', '疾病诊断')}

**你的回答风格**：
- {config.get('style', '专业、严谨')}
- 提供结构化的诊断建议
- 明确指出诊断依据和鉴别要点
- 建议必要的辅助检查

**重点关注**：
- {config.get('focus', '症状、体征、检查结果')}

**重要原则**：
1. 诊断建议仅供医生参考，不替代医生的专业判断
2. 对于紧急情况，建议医生立即采取相应措施
3. 如果信息不足，主动询问关键信息
4. 引用知识库中的相关医学知识，提高建议的可信度

**当前日期时间**：{current_datetime}

**可用工具**：
- retrieve_diagnosis_knowledge: 检索诊断相关知识库，获取相关医学知识、病例和指南

记住：始终以患者安全为中心，提供专业、可靠的诊断支持。"""
```

## 3.5 实现细节

### 3.5.1 RAG检索实现

```python
from langchain_community.vectorstores import PGVector
from langchain_community.embeddings import OpenAIEmbeddings
from langchain_core.tools import tool

@tool("retrieve_diagnosis_knowledge", description="检索诊断相关知识库")
async def retrieve_diagnosis_knowledge(
    query: str,
    department: str,
    top_k: int = 5,
    filter_metadata: dict = None
) -> str:
    """
    检索诊断相关知识
    
    Args:
        query: 检索查询（患者症状、检查结果等）
        department: 科室类型
        top_k: 返回Top-K相关文档
        filter_metadata: 元数据过滤条件
    
    Returns:
        str: 格式化的相关知识文档
    """
    try:
        # 初始化向量数据库连接
        vectorstore = get_vectorstore_by_department(department)
        
        # 执行相似度检索
        if filter_metadata:
            docs = await vectorstore.asimilarity_search_with_score(
                query,
                k=top_k,
                filter=filter_metadata
            )
        else:
            docs = await vectorstore.asimilarity_search_with_score(
                query,
                k=top_k
            )
        
        # 格式化返回结果
        formatted_docs = []
        for doc, score in docs:
            formatted_docs.append({
                "content": doc.page_content,
                "source": doc.metadata.get("source", "未知"),
                "score": float(score)
            })
        
        # 格式化为字符串返回
        result = "检索到的相关知识：\n\n"
        for i, doc_info in enumerate(formatted_docs, 1):
            result += f"[{i}] {doc_info['content']}\n"
            result += f"来源：{doc_info['source']}\n"
            result += f"相关性得分：{doc_info['score']:.3f}\n\n"
        
        return result
        
    except Exception as e:
        logger.error(f"RAG检索失败: {e}")
        return "知识库检索暂时不可用，将基于通用医学知识提供诊断建议。"
```

### 3.5.2 诊断智能体节点创建

```python
def create_diagnosis_agent_node(
    department: str,
    pool: AsyncConnectionPool,
    checkpointer: AsyncPostgresSaver,
    store: AsyncPostgresStore = None
):
    """
    创建诊断智能体节点工厂函数
    
    Args:
        department: 科室类型
        pool: 数据库连接池
        checkpointer: Checkpointer实例
        store: Store实例
    
    Returns:
        节点函数
    """
    async def diagnosis_agent_node(state: RouterState) -> RouterState:
        """诊断智能体节点"""
        messages = state.get("messages", [])
        user_id = state.get("user_id", "")
        
        # 获取LLM
        llm = get_llm_by_config()
        
        # 创建RAG检索工具
        tools = [
            create_retrieve_diagnosis_knowledge_tool(department)
        ]
        
        # 获取系统提示词
        system_prompt = get_diagnosis_system_prompt(department)
        
        # 创建ReAct Agent
        agent = create_react_agent(
            model=llm,
            tools=tools,
            checkpointer=checkpointer,
            store=store,
            state_modifier=system_prompt
        )
        
        # 调用智能体
        config = {
            "configurable": {
                "thread_id": state.get("session_id")
            }
        }
        
        result = await agent.ainvoke(
            {"messages": messages},
            config=config
        )
        
        # 更新状态
        updated_state = state.copy()
        updated_state["messages"] = result["messages"]
        
        return updated_state
    
    return diagnosis_agent_node
```

### 3.5.3 路由层意图识别扩展

在路由工具中扩展意图识别，支持识别具体的诊断科室：

```python
INTENT_IDENTIFICATION_PROMPT = """你是一个智能路由助手，负责识别用户的真实意图。

支持的意图类型：
1. blood_pressure: 用户想要记录、查询或管理血压数据
2. appointment: 用户想要预约、查询或管理复诊
3. diagnosis: 医生需要进行患者病情诊断
   - 子类型：
     - internal_medicine_diagnosis: 内科诊断
     - surgery_diagnosis: 外科诊断
     - pediatrics_diagnosis: 儿科诊断
     - gynecology_diagnosis: 妇科诊断
     - cardiology_diagnosis: 心血管科诊断
     - neurology_diagnosis: 神经科诊断
     - dermatology_diagnosis: 皮肤科诊断
     - general_diagnosis: 通用诊断（无法确定具体科室）
   - 关键词：诊断、病情、症状、检查结果、患者、病例
   - 示例："帮我诊断这个患者"、"这个症状是什么病"、"分析一下检查结果"
4. unclear: 意图不明确，需要进一步澄清

请分析用户消息，返回JSON格式的意图识别结果：
{{
    "intent_type": "意图类型（blood_pressure/appointment/diagnosis/unclear）",
    "sub_intent": "子意图类型（如果是diagnosis，返回具体科室；否则为null）",
    "confidence": 置信度（0.0-1.0之间的浮点数）,
    "entities": {{}},
    "need_clarification": 是否需要澄清（true/false）,
    "reasoning": "识别理由"
}}

规则：
- 如果意图明确且置信度>0.8，设置need_clarification=false
- 如果意图不明确（置信度<0.8），设置need_clarification=true
- 如果识别为diagnosis但无法确定具体科室，sub_intent设置为"general_diagnosis"
- 如果用户同时提及多个意图，按优先级选择
"""
```

## 3.6 知识库管理

### 3.6.1 知识库构建流程

```
医学文档收集
    ↓
文档预处理
    ├─→ 文本清洗
    ├─→ 分块（chunking）
    └─→ 元数据提取
    ↓
向量化
    ├─→ 文本嵌入（embedding）
    └─→ 存储到向量数据库
    ↓
知识库索引
    ├─→ 建立索引
    └─→ 质量检查
```

### 3.6.2 知识库更新机制

1. **增量更新**：
   - 支持新增文档的增量索引
   - 支持文档的更新和删除
   - 支持版本管理

2. **质量保证**：
   - 知识来源可信度验证
   - 内容质量审核
   - 定期更新和清理过期知识

3. **A/B测试**：
   - 支持不同版本的知识库
   - 对比不同版本的效果
   - 选择最优版本

## 3.7 模型演进策略

### 3.7.1 前期阶段（当前）

- **模型选择**：通用大语言模型（如GPT-4、Claude、DeepSeek等）
- **知识增强**：通过RAG检索增强模型知识
- **重点**：搭建RAG流程，验证知识检索效果

### 3.7.2 后期阶段（优化）

- **模型升级**：选择专业医疗模型（如Med-PaLM、ChatGLM-医疗版等）
- **知识库优化**：
  - 精细化知识库内容
  - 优化检索策略
  - 增加高质量病例和指南
- **其他优化**：
  - 多模态支持（图像、检查报告等）
  - 推理链优化（Chain-of-Thought）
  - 诊断置信度评估

## 3.8 错误处理

- **RAG检索失败**：返回友好的错误提示，基于通用医学知识提供建议
- **向量数据库不可用**：优雅降级，使用缓存或备用知识库
- **模型调用失败**：重试机制，超时后返回错误提示
- **知识库数据质量问题**：记录日志，定期审核和更新

## 3.9 配置说明

- **向量数据库配置**：通过环境变量或配置文件配置向量数据库连接信息
- **知识库路径**：配置各科室知识库的存储路径
- **检索参数**：配置Top-K数量、相似度阈值等
- **模型配置**：配置LLM类型、温度参数等（支持不同科室使用不同模型）

## 3.10 pgvector扩展安装和初始化

### 3.10.1 pgvector扩展安装

pgvector是PostgreSQL的向量扩展，用于存储和检索向量数据。安装方法如下：

#### 方法1：使用已包含pgvector的PostgreSQL镜像（推荐）

如果PostgreSQL Docker镜像已包含pgvector扩展，只需在数据库中启用：

```sql
-- 连接到目标数据库
\c doctor_agent_db

-- 启用pgvector扩展
CREATE EXTENSION IF NOT EXISTS vector;
```

#### 方法2：手动安装pgvector扩展

如果PostgreSQL未包含pgvector，需要手动安装：

**在Docker容器中安装**：
```bash
# 进入PostgreSQL容器
docker exec -it <postgres_container_name> bash

# 安装pgvector（根据PostgreSQL版本选择）
# PostgreSQL 15
apt-get update && apt-get install -y postgresql-15-pgvector

# PostgreSQL 14
apt-get update && apt-get install -y postgresql-14-pgvector

# PostgreSQL 13
apt-get update && apt-get install -y postgresql-13-pgvector
```

**从源码编译安装**（如果apt包不可用）：
```bash
# 进入容器
docker exec -it <postgres_container_name> bash

# 安装编译依赖
apt-get update
apt-get install -y build-essential git postgresql-server-dev-15

# 下载并编译pgvector
cd /tmp
git clone --branch v0.5.1 https://github.com/pgvector/pgvector.git
cd pgvector
make
make install

# 退出容器
exit
```

**验证安装**：
```sql
-- 检查扩展是否可用
SELECT * FROM pg_available_extensions WHERE name = 'vector';

-- 如果看到结果，说明扩展已安装
```

### 3.10.2 在doctor_agent_db数据库中初始化pgvector

**步骤1：连接到doctor_agent_db数据库**

```bash
# 使用psql连接
psql -h localhost -p 5433 -U postgres -d doctor_agent_db

# 或使用docker exec
docker exec -it <postgres_container_name> psql -U postgres -d doctor_agent_db
```

**步骤2：启用pgvector扩展**

```sql
-- 启用pgvector扩展
CREATE EXTENSION IF NOT EXISTS vector;

-- 验证扩展是否启用成功
SELECT extname, extversion FROM pg_extension WHERE extname = 'vector';
```

**步骤3：验证vector类型可用**

```sql
-- 测试创建包含vector类型的表
CREATE TABLE test_vector_table (
    id SERIAL PRIMARY KEY,
    content TEXT,
    embedding vector(768)
);

-- 测试插入向量数据
INSERT INTO test_vector_table (content, embedding) 
VALUES ('test', '[0.1,0.2,0.3]'::vector(768));

-- 测试查询
SELECT * FROM test_vector_table;

-- 清理测试表
DROP TABLE test_vector_table;
```

**步骤4：创建向量索引（可选，用于性能优化）**

```sql
-- 创建HNSW索引（推荐用于大规模数据）
CREATE INDEX ON your_table_name USING hnsw (embedding vector_cosine_ops);

-- 或创建IVFFlat索引（适用于中等规模数据）
CREATE INDEX ON your_table_name USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
```

### 3.10.3 常见问题排查

**问题1：扩展未找到**
```
ERROR: could not open extension control file "/usr/share/postgresql/15/extension/vector.control": No such file or directory
```
**解决方案**：需要先安装pgvector扩展（参考方法2）

**问题2：权限不足**
```
ERROR: permission denied to create extension "vector"
```
**解决方案**：需要使用超级用户（postgres）或具有CREATE权限的用户

**问题3：扩展已存在但无法使用**
```
ERROR: type "vector" does not exist
```
**解决方案**：
1. 确认扩展已启用：`SELECT * FROM pg_extension WHERE extname = 'vector';`
2. 如果未启用，执行：`CREATE EXTENSION IF NOT EXISTS vector;`
3. 确认在正确的数据库中启用扩展（每个数据库需要单独启用）

### 3.10.4 初始化脚本示例

为了方便初始化，可以创建SQL脚本：

```sql
-- init_pgvector.sql
-- 在doctor_agent_db数据库中初始化pgvector扩展

-- 启用pgvector扩展
CREATE EXTENSION IF NOT EXISTS vector;

-- 验证扩展版本
SELECT extname, extversion FROM pg_extension WHERE extname = 'vector';

-- 显示扩展信息
\dx vector
```

**使用方法**：
```bash
psql -h localhost -p 5433 -U postgres -d doctor_agent_db -f init_pgvector.sql
```

# 4、实施计划

## 4.1 第一阶段：基础架构搭建

1. **RAG基础设施**：
   - 搭建向量数据库（如PGVector、Chroma等）
   - 实现基础的RAG检索工具
   - 设计知识库存储结构

2. **第一个诊断智能体**：
   - 选择内科诊断智能体作为试点
   - 构建内科知识库（基础版本）
   - 实现内科诊断智能体节点
   - 集成到路由系统

3. **测试和验证**：
   - 测试RAG检索效果
   - 验证诊断建议质量
   - 收集反馈并优化

## 4.2 第二阶段：扩展更多科室

1. **扩展诊断智能体**：
   - 逐步添加外科、儿科、妇科等诊断智能体
   - 为每个科室构建专门的知识库
   - 定制系统提示词

2. **优化RAG检索**：
   - 优化检索策略
   - 改进知识库质量
   - 提升检索准确率

## 4.3 第三阶段：模型和知识库优化

1. **模型升级**：
   - 评估专业医疗模型
   - 进行模型切换
   - 对比效果

2. **知识库精细化**：
   - 增加高质量病例
   - 更新最新医学指南
   - 优化知识库结构

3. **功能增强**：
   - 支持多模态输入
   - 增加诊断置信度评估
   - 优化推理链

# 5、相关文档

- `V2.0-10-总体设计.md`：总体设计文档
- `V2.0-11-路由智能体详细设计.md`：路由智能体设计
- `V2.0-14-医生助手智能体详细设计.md`：医生助手智能体设计（已更新）

