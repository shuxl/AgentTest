# 1、功能描述

血压记录智能体是专门处理血压数据收集和管理的智能体，继承0701版本的功能，支持血压数据的记录、查询、更新和统计功能。血压记录智能体作为路由系统中的专门智能体之一，通过路由智能体路由调用。

# 2、需求

## 2.1 功能需求

| JIRA编号 | 产品/子系统/服务 | 功能 | 功能描述 |
| ------ | ------ | ------ | ------ |
| BP-001 | 血压记录智能体 | 记录血压 | 引导用户完成血压数据收集，包括收缩压、舒张压、测量时间等信息 |
| BP-002 | 血压记录智能体 | 查询历史 | 查询用户的历史血压记录，支持按时间范围查询 |
| BP-003 | 血压记录智能体 | 更新记录 | 更新已有的血压记录信息 |
| BP-004 | 血压记录智能体 | 统计信息 | 提供血压统计信息，如平均值、最高值、最低值等 |

## 2.2 非功能需求

| 非功能需求 | 需求描述 |
| ------ | ------ |
| 响应 | 单次工具调用响应时间 < 2s |
| 容量 | 支持单用户最多10000条血压记录 |
| 扩展性 | 易于扩展新的血压相关功能 |
| 安全性 | 验证血压数据合法性，防止异常数据 |
| 可靠性 | 数据存储可靠性 > 99.9% |

# 3、技术设计

## 3.1 设计思路

血压记录智能体基于LangGraph实现，采用以下设计思路：

1. **引导式收集**：通过多轮对话引导用户完成血压数据收集
2. **数据验证**：验证血压数据的合法性（收缩压、舒张压范围等）
3. **持久化存储**：使用PostgreSQL存储血压数据
4. **长期记忆**：使用LangGraph的store功能存储和检索历史数据

## 3.2 设计图(流程图/时序图/其他)

### 3.2.1 记录血压流程

```
用户: "我想记录血压"
    ↓
血压记录智能体: "请告诉我您的收缩压是多少？"
    ↓
用户: "120"
    ↓
血压记录智能体: "好的，请告诉我您的舒张压是多少？"
    ↓
用户: "80"
    ↓
血压记录智能体: "请问您是什么时候测量的？"
    ↓
用户: "今天早上8点"
    ↓
调用record_blood_pressure工具
    ↓
保存到PostgreSQL
    ↓
返回: "成功保存血压记录..."
```

### 3.2.2 查询历史流程

```
用户: "查询我的血压记录"
    ↓
调用query_blood_pressure工具
    ↓
从PostgreSQL查询数据
    ↓
格式化返回结果
    ↓
返回: "您最近的血压记录如下：..."
```

## 3.3 ER设计

### 3.3.1 表清单

| 表名 | 描述 | 是否分表 | 备注 |
| ------ | ------ | ------ | ------ |
| blood_pressure_records | 血压记录表 | 否 | 存储用户的血压记录 |

### 3.3.2 ER关系

```
users (用户表)
    ↓ 1:N
blood_pressure_records (血压记录表)
    - id: 主键
    - user_id: 用户ID（外键）
    - systolic: 收缩压
    - diastolic: 舒张压
    - measurement_time: 测量时间
    - created_at: 创建时间
    - updated_at: 更新时间
```

## 3.4 接口设计

### 3.4.1 接口清单

| 接口地址 | 接口名称 | 备注 |
| ------ | ------ | ------ |
| - | - | 血压记录智能体通过路由智能体调用，不直接提供HTTP接口 |

### 3.4.2 工具接口

#### 功能描述：记录血压工具

<table>
    <th colspan="4">功能描述：<span>记录用户的血压数据</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>BP-001</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">record_blood_pressure</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>systolic</td><td>int</td><td>Y</td><td>收缩压（50-300）</td>
    </tr>
    <tr>
        <td>diastolic</td><td>int</td><td>Y</td><td>舒张压（30-200）</td>
    </tr>
    <tr>
        <td>measurement_time</td><td>datetime</td><td>N</td><td>测量时间，默认为当前时间</td>
    </tr>
    <tr>
        <td>user_id</td><td>str</td><td>Y</td><td>用户ID</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>result</td><td>str</td><td colspan="2">保存结果消息</td>
    </tr>
</table>

#### 功能描述：查询血压记录工具

<table>
    <th colspan="4">功能描述：<span>查询用户的历史血压记录</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>BP-002</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">query_blood_pressure</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>user_id</td><td>str</td><td>Y</td><td>用户ID</td>
    </tr>
    <tr>
        <td>start_date</td><td>datetime</td><td>N</td><td>开始日期</td>
    </tr>
    <tr>
        <td>end_date</td><td>datetime</td><td>N</td><td>结束日期</td>
    </tr>
    <tr>
        <td>limit</td><td>int</td><td>N</td><td>返回记录数限制，默认10</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>records</td><td>list</td><td colspan="2">血压记录列表</td>
    </tr>
</table>

#### 功能描述：更新血压记录工具

<table>
    <th colspan="4">功能描述：<span>更新已有的血压记录</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>BP-003</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">update_blood_pressure</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>record_id</td><td>str</td><td>Y</td><td>记录ID</td>
    </tr>
    <tr>
        <td>systolic</td><td>int</td><td>N</td><td>收缩压</td>
    </tr>
    <tr>
        <td>diastolic</td><td>int</td><td>N</td><td>舒张压</td>
    </tr>
    <tr>
        <td>measurement_time</td><td>datetime</td><td>N</td><td>测量时间</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>result</td><td>str</td><td colspan="2">更新结果消息</td>
    </tr>
</table>

#### 功能描述：查询统计信息工具

<table>
    <th colspan="4">功能描述：<span>查询血压统计信息</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>BP-004</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">info</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>user_id</td><td>str</td><td>Y</td><td>用户ID</td>
    </tr>
    <tr>
        <td>start_date</td><td>datetime</td><td>N</td><td>开始日期</td>
    </tr>
    <tr>
        <td>end_date</td><td>datetime</td><td>N</td><td>结束日期</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>statistics</td><td>dict</td><td colspan="2">统计信息（平均值、最高值、最低值等）</td>
    </tr>
</table>

## 3.5 其他

### 3.5.1 系统提示词

```
你是一个专业的血压记录助手，帮助用户记录和管理血压数据。

你的职责：
1. 引导用户完成血压数据收集（收缩压、舒张压、测量时间）
2. 验证血压数据的合法性
3. 查询用户的历史血压记录
4. 更新已有的血压记录
5. 提供血压统计信息

数据验证规则：
- 收缩压范围：50-300 mmHg
- 舒张压范围：30-200 mmHg
- 收缩压必须大于舒张压

记住：始终以用户为中心，提供友好的交互体验。
```

### 3.5.2 数据验证

- 收缩压和舒张压必须在合理范围内
- 收缩压必须大于舒张压
- 测量时间不能是未来时间
- 用户ID必须存在

### 3.5.3 错误处理

- 数据验证失败：返回友好的错误提示
- 数据库操作失败：记录日志，返回错误提示
- 异常情况：捕获异常，返回友好的错误提示

