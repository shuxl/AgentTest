# 1、功能描述

健康档案存储系统是多智能体路由系统的长期记忆核心组件，负责存储和管理用户的健康档案信息，为各智能体提供个性化的健康信息服务。健康档案信息包括用户基本信息、健康指标基线、既往病史、过敏史、常用药物等，这些信息将帮助诊断智能体提供更准确的诊断建议，帮助血压记录智能体判断异常情况，帮助复诊管理智能体推荐合适的科室和医生。

# 2、需求

## 2.1 功能需求

| JIRA编号 | 产品/子系统/服务 | 功能 | 功能描述 |
| ------ | ------ | ------ | ------ |
| HP-001 | 健康档案存储系统 | 创建健康档案 | 支持创建用户的健康档案，包括基本信息、健康指标基线、既往病史等 |
| HP-002 | 健康档案存储系统 | 查询健康档案 | 支持查询用户的健康档案信息，支持按字段查询 |
| HP-003 | 健康档案存储系统 | 更新健康档案 | 支持更新用户的健康档案信息，支持部分更新 |
| HP-004 | 健康档案存储系统 | 健康档案同步 | 支持健康档案在Store和业务表之间的同步 |
| HP-005 | 健康档案存储系统 | 健康档案访问工具 | 提供健康档案访问工具，供各智能体调用 |

## 2.2 非功能需求

| 非功能需求 | 需求描述 |
| ------ | ------ |
| 响应 | 健康档案查询响应时间 < 200ms |
| 容量 | 支持单用户健康档案数据量 < 100KB |
| 扩展性 | 易于扩展新的健康档案字段 |
| 安全性 | 敏感信息加密存储，严格的访问控制 |
| 可靠性 | 数据存储可靠性 > 99.9%，Store和业务表数据一致性 > 99% |
| 隐私性 | 符合医疗数据隐私保护要求，支持数据删除 |

# 3、技术设计

## 3.1 设计思路

健康档案存储系统基于长期记忆设计实现，采用以下设计思路：

1. **双存储架构**：同时使用Store和业务表存储健康档案信息
   - Store用于快速检索和向量搜索
   - 业务表用于关系查询和统计分析
2. **统一接口**：提供统一的长期记忆访问接口，简化智能体集成
3. **数据同步**：Store和业务表之间保持同步，确保数据一致性
4. **隐私安全**：敏感信息加密存储，严格的访问控制

## 3.2 设计图(流程图/时序图/其他)

### 3.2.1 健康档案创建流程

```
用户/智能体: 创建健康档案请求
    ↓
健康档案访问工具: 接收请求
    ↓
长期记忆管理器: 验证数据合法性
    ↓
    ├─→ 保存到业务表（PostgreSQL）
    │   └─→ 使用事务保证数据一致性
    │
    └─→ 同步到Store（AsyncPostgresStore）
        └─→ 使用命名空间隔离（health_profile, user_id）
    ↓
返回: 创建成功
```

### 3.2.2 健康档案查询流程

```
智能体: 查询健康档案请求
    ↓
长期记忆管理器: 查询健康档案
    ↓
    ├─→ 优先从Store获取（快速检索）
    │   └─→ 如果存在，直接返回
    │
    └─→ 如果Store不存在，从业务表获取
        └─→ 同步到Store（供下次快速访问）
    ↓
返回: 健康档案信息
```

### 3.2.3 健康档案更新流程

```
用户/智能体: 更新健康档案请求
    ↓
长期记忆管理器: 验证数据合法性
    ↓
    ├─→ 更新业务表（PostgreSQL）
    │   └─→ 使用事务保证数据一致性
    │
    └─→ 同步更新Store（AsyncPostgresStore）
        └─→ 更新命名空间中的数据
    ↓
返回: 更新成功
```

### 3.2.4 智能体使用健康档案流程

```
诊断智能体: 开始诊断
    ↓
调用健康档案访问工具: get_health_profile(user_id)
    ↓
长期记忆管理器: 获取健康档案
    ↓
返回健康档案信息
    ↓
诊断智能体: 在系统提示词中包含健康档案信息
    ↓
结合健康档案和当前症状，生成诊断建议
```

## 3.3 ER设计

### 3.3.1 表清单

| 表名 | 描述 | 是否分表 | 备注 |
| ------ | ------ | ------ | ------ |
| health_profiles | 健康档案表 | 否 | 存储用户的健康档案信息（结构化数据） |

### 3.3.2 ER关系

```
users (用户表，假设存在)
    ↓ 1:1
health_profiles (健康档案表)
    - id: 主键
    - user_id: 用户ID（外键，唯一索引）
    - age: 年龄
    - gender: 性别
    - height: 身高（cm）
    - weight: 体重（kg）
    - blood_type: 血型
    - allergies: 过敏史（JSON数组）
    - medical_history: 既往病史（JSON数组）
    - family_history: 家族病史（JSON数组）
    - medications: 常用药物（JSON数组）
    - baseline_bp_systolic: 基线收缩压
    - baseline_bp_diastolic: 基线舒张压
    - health_goals: 健康目标（JSON对象）
    - created_at: 创建时间
    - updated_at: 更新时间
```

### 3.3.3 表结构设计

```sql
CREATE TABLE health_profiles (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL UNIQUE,
    age INTEGER,
    gender VARCHAR(10),
    height FLOAT,
    weight FLOAT,
    blood_type VARCHAR(10),
    allergies JSONB,
    medical_history JSONB,
    family_history JSONB,
    medications JSONB,
    baseline_bp_systolic INTEGER,
    baseline_bp_diastolic INTEGER,
    health_goals JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_health_profiles_user_id ON health_profiles(user_id);
```

## 3.4 接口设计

### 3.4.1 接口清单

| 接口地址 | 接口名称 | 备注 |
| ------ | ------ | ------ |
| - | - | 健康档案存储系统通过工具接口供智能体调用，不直接提供HTTP接口 |

### 3.4.2 工具接口

#### 功能描述：获取健康档案工具

<table>
    <th colspan="4">功能描述：<span>获取用户的健康档案信息</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>HP-002</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">get_health_profile</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>user_id</td><td>str</td><td>Y</td><td>用户ID</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>result</td><td>str</td><td colspan="2">格式化的健康档案信息（JSON字符串或文本格式）</td>
    </tr>
</table>

#### 功能描述：更新健康档案工具

<table>
    <th colspan="4">功能描述：<span>更新用户的健康档案信息</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>HP-003</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">update_health_profile</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>user_id</td><td>str</td><td>Y</td><td>用户ID</td>
    </tr>
    <tr>
        <td>age</td><td>int</td><td>N</td><td>年龄</td>
    </tr>
    <tr>
        <td>gender</td><td>str</td><td>N</td><td>性别（male/female/other）</td>
    </tr>
    <tr>
        <td>height</td><td>float</td><td>N</td><td>身高（cm）</td>
    </tr>
    <tr>
        <td>weight</td><td>float</td><td>N</td><td>体重（kg）</td>
    </tr>
    <tr>
        <td>blood_type</td><td>str</td><td>N</td><td>血型（A/B/AB/O）</td>
    </tr>
    <tr>
        <td>allergies</td><td>List[str]</td><td>N</td><td>过敏史列表</td>
    </tr>
    <tr>
        <td>medical_history</td><td>List[str]</td><td>N</td><td>既往病史列表</td>
    </tr>
    <tr>
        <td>family_history</td><td>List[str]</td><td>N</td><td>家族病史列表</td>
    </tr>
    <tr>
        <td>medications</td><td>List[str]</td><td>N</td><td>常用药物列表</td>
    </tr>
    <tr>
        <td>baseline_bp_systolic</td><td>int</td><td>N</td><td>基线收缩压</td>
    </tr>
    <tr>
        <td>baseline_bp_diastolic</td><td>int</td><td>N</td><td>基线舒张压</td>
    </tr>
    <tr>
        <td>health_goals</td><td>Dict[str, Any]</td><td>N</td><td>健康目标（JSON对象）</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>result</td><td>str</td><td colspan="2">更新结果消息</td>
    </tr>
</table>

#### 功能描述：创建健康档案工具

<table>
    <th colspan="4">功能描述：<span>创建用户的健康档案</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>HP-001</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">create_health_profile</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>user_id</td><td>str</td><td>Y</td><td>用户ID</td>
    </tr>
    <tr>
        <td>age</td><td>int</td><td>N</td><td>年龄</td>
    </tr>
    <tr>
        <td>gender</td><td>str</td><td>N</td><td>性别（male/female/other）</td>
    </tr>
    <tr>
        <td>height</td><td>float</td><td>N</td><td>身高（cm）</td>
    </tr>
    <tr>
        <td>weight</td><td>float</td><td>N</td><td>体重（kg）</td>
    </tr>
    <tr>
        <td>blood_type</td><td>str</td><td>N</td><td>血型（A/B/AB/O）</td>
    </td>
    <tr>
        <td>allergies</td><td>List[str]</td><td>N</td><td>过敏史列表</td>
    </tr>
    <tr>
        <td>medical_history</td><td>List[str]</td><td>N</td><td>既往病史列表</td>
    </tr>
    <tr>
        <td>family_history</td><td>List[str]</td><td>N</td><td>家族病史列表</td>
    </tr>
    <tr>
        <td>medications</td><td>List[str]</td><td>N</td><td>常用药物列表</td>
    </tr>
    <tr>
        <td>baseline_bp_systolic</td><td>int</td><td>N</td><td>基线收缩压</td>
    </tr>
    <tr>
        <td>baseline_bp_diastolic</td><td>int</td><td>N</td><td>基线舒张压</td>
    </tr>
    <tr>
        <td>health_goals</td><td>Dict[str, Any]</td><td>N</td><td>健康目标（JSON对象）</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>result</td><td>str</td><td colspan="2">创建结果消息</td>
    </tr>
</table>

## 3.5 数据模型设计

### 3.5.1 SQLAlchemy模型

```python
from sqlalchemy import Column, Integer, String, Float, DateTime, JSON
from sqlalchemy.sql import func
from sqlalchemy.dialects.postgresql import JSONB
from ..base import Base

class HealthProfile(Base):
    """健康档案模型"""
    __tablename__ = "health_profiles"
    
    # 主键
    id = Column(Integer, primary_key=True, autoincrement=True, comment="记录ID")
    
    # 用户信息
    user_id = Column(String(255), nullable=False, unique=True, comment="用户ID")
    
    # 基本信息
    age = Column(Integer, nullable=True, comment="年龄")
    gender = Column(String(10), nullable=True, comment="性别（male/female/other）")
    height = Column(Float, nullable=True, comment="身高（cm）")
    weight = Column(Float, nullable=True, comment="体重（kg）")
    blood_type = Column(String(10), nullable=True, comment="血型（A/B/AB/O）")
    
    # 健康信息（JSON格式）
    allergies = Column(JSONB, nullable=True, comment="过敏史列表")
    medical_history = Column(JSONB, nullable=True, comment="既往病史列表")
    family_history = Column(JSONB, nullable=True, comment="家族病史列表")
    medications = Column(JSONB, nullable=True, comment="常用药物列表")
    
    # 健康指标基线
    baseline_bp_systolic = Column(Integer, nullable=True, comment="基线收缩压")
    baseline_bp_diastolic = Column(Integer, nullable=True, comment="基线舒张压")
    
    # 健康目标（JSON格式）
    health_goals = Column(JSONB, nullable=True, comment="健康目标（JSON对象）")
    
    # 时间戳
    created_at = Column(DateTime(timezone=True), server_default=func.now(), comment="创建时间")
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), comment="更新时间")
    
    # 索引
    __table_args__ = (
        Index('idx_health_profiles_user_id', 'user_id'),
    )
```

### 3.5.2 Store命名空间设计

健康档案在Store中的存储结构：

```
命名空间: ("health_profile", user_id)
键名: "profile"
值: {
    "age": 45,
    "gender": "male",
    "height": 175.0,
    "weight": 70.0,
    "blood_type": "A",
    "allergies": ["penicillin", "sulfa"],
    "medical_history": ["hypertension", "diabetes"],
    "family_history": ["heart_disease"],
    "medications": ["lisinopril", "metformin"],
    "baseline_bp_systolic": 120,
    "baseline_bp_diastolic": 80,
    "health_goals": {
        "bp_target": {"systolic": 120, "diastolic": 80},
        "weight_target": 65.0
    }
}
```

## 3.6 实现细节

### 3.6.1 长期记忆管理器

创建统一的长期记忆管理器，封装健康档案操作：

```python
# utils/memory/long_term_memory.py
from typing import Dict, Any, Optional
from langgraph.store.postgres import AsyncPostgresStore
from sqlalchemy.ext.asyncio import AsyncSession
from ..db.models.health_profile_model import HealthProfile
from ..db.crud.health_profile_crud import HealthProfileCRUD

class LongTermMemoryManager:
    """长期记忆管理器"""
    
    def __init__(self, store: AsyncPostgresStore, session_maker):
        self.store = store
        self.session_maker = session_maker
        self.health_profile_crud = HealthProfileCRUD()
    
    async def get_health_profile(self, user_id: str) -> Dict[str, Any]:
        """获取健康档案（优先从Store获取，如果不存在则从业务表获取并同步到Store）"""
        # 1. 尝试从Store获取
        namespace = ("health_profile", user_id)
        profile_store = await self.store.aget(namespace, "profile")
        if profile_store:
            return profile_store.value
        
        # 2. 从业务表获取
        async with self.session_maker() as session:
            profile = await self.health_profile_crud.get_by_user_id(session, user_id)
            if profile:
                profile_dict = self._profile_to_dict(profile)
                # 同步到Store
                await self.store.aput(namespace, "profile", profile_dict)
                return profile_dict
        
        return {}
    
    async def create_or_update_health_profile(self, user_id: str, profile_data: Dict[str, Any]) -> Dict[str, Any]:
        """创建或更新健康档案（同时更新Store和业务表）"""
        # 1. 更新业务表
        async with self.session_maker() as session:
            profile = await self.health_profile_crud.create_or_update(session, user_id, profile_data)
            profile_dict = self._profile_to_dict(profile)
        
        # 2. 更新Store
        namespace = ("health_profile", user_id)
        await self.store.aput(namespace, "profile", profile_dict)
        
        return profile_dict
    
    def _profile_to_dict(self, profile: HealthProfile) -> Dict[str, Any]:
        """将HealthProfile模型转换为字典"""
        return {
            "age": profile.age,
            "gender": profile.gender,
            "height": profile.height,
            "weight": profile.weight,
            "blood_type": profile.blood_type,
            "allergies": profile.allergies or [],
            "medical_history": profile.medical_history or [],
            "family_history": profile.family_history or [],
            "medications": profile.medications or [],
            "baseline_bp_systolic": profile.baseline_bp_systolic,
            "baseline_bp_diastolic": profile.baseline_bp_diastolic,
            "health_goals": profile.health_goals or {},
        }
```

### 3.6.2 健康档案CRUD

```python
# utils/db/crud/health_profile_crud.py
from typing import Optional, Dict, Any
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from datetime import datetime
from ..models.health_profile_model import HealthProfile

class HealthProfileCRUD:
    """健康档案CRUD操作"""
    
    async def get_by_user_id(self, session: AsyncSession, user_id: str) -> Optional[HealthProfile]:
        """根据用户ID获取健康档案"""
        result = await session.execute(
            select(HealthProfile).where(HealthProfile.user_id == user_id)
        )
        return result.scalar_one_or_none()
    
    async def create_or_update(self, session: AsyncSession, user_id: str, profile_data: Dict[str, Any]) -> HealthProfile:
        """创建或更新健康档案"""
        profile = await self.get_by_user_id(session, user_id)
        if profile:
            # 更新
            for key, value in profile_data.items():
                if hasattr(profile, key):
                    setattr(profile, key, value)
            profile.updated_at = datetime.now()
        else:
            # 创建
            profile = HealthProfile(user_id=user_id, **profile_data)
            session.add(profile)
        await session.commit()
        await session.refresh(profile)
        return profile
    
    async def delete(self, session: AsyncSession, user_id: str) -> bool:
        """删除健康档案"""
        profile = await self.get_by_user_id(session, user_id)
        if profile:
            await session.delete(profile)
            await session.commit()
            return True
        return False
```

### 3.6.3 健康档案访问工具

```python
# utils/tools/health_profile_tools.py
from langchain_core.tools import tool
from typing import Optional, List, Dict, Any
from langgraph.store.postgres import AsyncPostgresStore
from ..memory.long_term_memory import LongTermMemoryManager
from ..db.base import get_async_session

def create_health_profile_tools(user_id: str, store: Optional[AsyncPostgresStore] = None):
    """创建健康档案访问工具"""
    
    session_maker = get_async_session()
    memory_manager = LongTermMemoryManager(store, session_maker)
    
    @tool("get_health_profile", description="获取用户的健康档案信息，包括基本信息、健康指标基线、既往病史、过敏史、常用药物等")
    async def get_health_profile() -> str:
        """获取健康档案"""
        try:
            profile = await memory_manager.get_health_profile(user_id)
            if not profile:
                return "您还没有创建健康档案，请使用create_health_profile工具创建。"
            
            # 格式化输出
            lines = ["=== 健康档案信息 ==="]
            if profile.get("age"):
                lines.append(f"年龄: {profile['age']}岁")
            if profile.get("gender"):
                lines.append(f"性别: {profile['gender']}")
            if profile.get("height"):
                lines.append(f"身高: {profile['height']}cm")
            if profile.get("weight"):
                lines.append(f"体重: {profile['weight']}kg")
            if profile.get("blood_type"):
                lines.append(f"血型: {profile['blood_type']}")
            if profile.get("allergies"):
                lines.append(f"过敏史: {', '.join(profile['allergies'])}")
            if profile.get("medical_history"):
                lines.append(f"既往病史: {', '.join(profile['medical_history'])}")
            if profile.get("family_history"):
                lines.append(f"家族病史: {', '.join(profile['family_history'])}")
            if profile.get("medications"):
                lines.append(f"常用药物: {', '.join(profile['medications'])}")
            if profile.get("baseline_bp_systolic") and profile.get("baseline_bp_diastolic"):
                lines.append(f"基线血压: {profile['baseline_bp_systolic']}/{profile['baseline_bp_diastolic']}mmHg")
            if profile.get("health_goals"):
                lines.append(f"健康目标: {profile['health_goals']}")
            
            return "\n".join(lines)
        except Exception as e:
            return f"获取健康档案时发生错误: {str(e)}"
    
    @tool("update_health_profile", description="更新用户的健康档案信息，支持部分更新")
    async def update_health_profile(
        age: Optional[int] = None,
        gender: Optional[str] = None,
        height: Optional[float] = None,
        weight: Optional[float] = None,
        blood_type: Optional[str] = None,
        allergies: Optional[List[str]] = None,
        medical_history: Optional[List[str]] = None,
        family_history: Optional[List[str]] = None,
        medications: Optional[List[str]] = None,
        baseline_bp_systolic: Optional[int] = None,
        baseline_bp_diastolic: Optional[int] = None,
        health_goals: Optional[Dict[str, Any]] = None
    ) -> str:
        """更新健康档案"""
        try:
            profile_data = {}
            if age is not None:
                profile_data["age"] = age
            if gender is not None:
                profile_data["gender"] = gender
            if height is not None:
                profile_data["height"] = height
            if weight is not None:
                profile_data["weight"] = weight
            if blood_type is not None:
                profile_data["blood_type"] = blood_type
            if allergies is not None:
                profile_data["allergies"] = allergies
            if medical_history is not None:
                profile_data["medical_history"] = medical_history
            if family_history is not None:
                profile_data["family_history"] = family_history
            if medications is not None:
                profile_data["medications"] = medications
            if baseline_bp_systolic is not None:
                profile_data["baseline_bp_systolic"] = baseline_bp_systolic
            if baseline_bp_diastolic is not None:
                profile_data["baseline_bp_diastolic"] = baseline_bp_diastolic
            if health_goals is not None:
                profile_data["health_goals"] = health_goals
            
            if not profile_data:
                return "没有提供要更新的字段"
            
            await memory_manager.create_or_update_health_profile(user_id, profile_data)
            return "健康档案更新成功"
        except Exception as e:
            return f"更新健康档案时发生错误: {str(e)}"
    
    @tool("create_health_profile", description="创建用户的健康档案")
    async def create_health_profile(
        age: Optional[int] = None,
        gender: Optional[str] = None,
        height: Optional[float] = None,
        weight: Optional[float] = None,
        blood_type: Optional[str] = None,
        allergies: Optional[List[str]] = None,
        medical_history: Optional[List[str]] = None,
        family_history: Optional[List[str]] = None,
        medications: Optional[List[str]] = None,
        baseline_bp_systolic: Optional[int] = None,
        baseline_bp_diastolic: Optional[int] = None,
        health_goals: Optional[Dict[str, Any]] = None
    ) -> str:
        """创建健康档案"""
        try:
            profile_data = {}
            if age is not None:
                profile_data["age"] = age
            if gender is not None:
                profile_data["gender"] = gender
            if height is not None:
                profile_data["height"] = height
            if weight is not None:
                profile_data["weight"] = weight
            if blood_type is not None:
                profile_data["blood_type"] = blood_type
            if allergies is not None:
                profile_data["allergies"] = allergies
            if medical_history is not None:
                profile_data["medical_history"] = medical_history
            if family_history is not None:
                profile_data["family_history"] = family_history
            if medications is not None:
                profile_data["medications"] = medications
            if baseline_bp_systolic is not None:
                profile_data["baseline_bp_systolic"] = baseline_bp_systolic
            if baseline_bp_diastolic is not None:
                profile_data["baseline_bp_diastolic"] = baseline_bp_diastolic
            if health_goals is not None:
                profile_data["health_goals"] = health_goals
            
            await memory_manager.create_or_update_health_profile(user_id, profile_data)
            return "健康档案创建成功"
        except Exception as e:
            return f"创建健康档案时发生错误: {str(e)}"
    
    return [get_health_profile, update_health_profile, create_health_profile]
```

## 3.7 数据同步机制

### 3.7.1 同步策略

- **实时同步**：健康档案创建或更新时，立即同步到Store和业务表
- **读取同步**：从业务表读取时，如果Store不存在，自动同步到Store
- **冲突解决**：以业务表为准，Store定期从业务表同步

### 3.7.2 一致性保证

- **事务保证**：业务表操作使用数据库事务
- **最终一致性**：Store和业务表之间采用最终一致性模型
- **错误处理**：同步失败时记录日志，但不影响主流程

## 3.8 数据隐私和安全

### 3.8.1 数据加密

- **敏感信息加密**：健康档案中的敏感信息（如过敏史、既往病史）加密存储
- **传输加密**：使用HTTPS传输数据
- **访问控制**：基于用户ID的访问控制，确保用户只能访问自己的数据

### 3.8.2 数据保留策略

- **健康档案**：永久保留，直到用户删除账户
- **数据删除**：用户可以通过工具删除自己的健康档案数据

## 3.9 智能体集成

### 3.9.1 诊断智能体集成

诊断智能体在诊断时自动获取健康档案信息，并在系统提示词中包含：

```python
# 在诊断智能体中使用健康档案
async def diagnosis_agent_node(state: RouterState):
    user_id = state["user_id"]
    
    # 获取健康档案
    memory_manager = LongTermMemoryManager(store, session_maker)
    health_profile = await memory_manager.get_health_profile(user_id)
    
    # 在系统提示词中包含健康档案信息
    system_prompt = f"""
    患者基本信息：
    - 年龄：{health_profile.get('age', '未知')}
    - 性别：{health_profile.get('gender', '未知')}
    - 过敏史：{', '.join(health_profile.get('allergies', []))}
    - 既往病史：{', '.join(health_profile.get('medical_history', []))}
    - 常用药物：{', '.join(health_profile.get('medications', []))}
    
    请基于以上信息，结合患者当前症状，提供诊断建议。
    """
    
    # ... 继续诊断流程
```

### 3.9.2 血压记录智能体集成

血压记录智能体在记录血压时，自动获取健康档案中的基线血压，判断是否异常：

```python
# 在血压记录智能体中使用健康档案
async def record_blood_pressure(systolic: int, diastolic: int, ...):
    # 获取健康档案
    health_profile = await memory_manager.get_health_profile(user_id)
    baseline_systolic = health_profile.get('baseline_bp_systolic')
    baseline_diastolic = health_profile.get('baseline_bp_diastolic')
    
    # 判断是否异常
    if baseline_systolic and baseline_diastolic:
        if abs(systolic - baseline_systolic) > 20 or abs(diastolic - baseline_diastolic) > 10:
            return "您的血压与基线值相比有明显变化，建议咨询医生。"
    
    # ... 继续记录流程
```

## 4. 测试设计

### 4.1 单元测试

- 测试健康档案CRUD操作
- 测试Store和业务表同步机制
- 测试数据验证逻辑

### 4.2 集成测试

- 测试健康档案工具调用
- 测试诊断智能体使用健康档案
- 测试血压记录智能体使用健康档案

### 4.3 性能测试

- 测试健康档案查询性能（目标 < 200ms）
- 测试健康档案更新性能
- 测试Store和业务表同步性能

## 5. 部署和运维

### 5.1 数据库迁移

使用Alembic创建数据库迁移脚本，创建health_profiles表。

### 5.2 监控和日志

- 记录健康档案访问日志
- 监控Store和业务表同步状态
- 监控健康档案查询性能

## 6. 相关文档

- `V2.0-03-长期记忆设计.md`：长期记忆总体设计
- `V2.0-10-总体设计.md`：系统总体架构设计
- `V2.0-12-血压记录智能体详细设计.md`：血压记录智能体设计
- `V2.0-14-诊断智能体架构设计.md`：诊断智能体系统设计

