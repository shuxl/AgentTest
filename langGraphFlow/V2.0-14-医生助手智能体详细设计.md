# 1、功能描述

医生助手智能体是专门协助医生处理日常咨询、病历管理和处方管理的智能体，通过调用Java微服务提供的HTTP API接口实现业务功能。医生助手智能体作为路由系统中的专门智能体之一，通过路由智能体路由调用。

# 2、需求

## 2.1 功能需求

| JIRA编号 | 产品/子系统/服务 | 功能 | 功能描述 |
| ------ | ------ | ------ | ------ |
| DOC-001 | 医生助手智能体 | 日常咨询处理 | 处理患者的常见咨询问题，提供医疗建议，引导患者到合适的科室 |
| DOC-002 | 医生助手智能体 | 病历管理 | 查询、更新和管理患者病历记录 |
| DOC-003 | 医生助手智能体 | 处方管理 | 查询、开具和管理患者处方记录 |

## 2.2 非功能需求

| 非功能需求 | 需求描述 |
| ------ | ------ |
| 响应 | 单次工具调用响应时间 < 3s（包含Java微服务调用时间） |
| 容量 | 支持单医生最多处理10000条病历记录和处方记录 |
| 扩展性 | 易于扩展新的医生助手相关功能 |
| 安全性 | 验证医生权限，调用Java微服务时进行认证 |
| 可靠性 | Java微服务调用失败时优雅降级，返回友好错误提示 |

# 3、技术设计

## 3.1 设计思路

医生助手智能体基于LangGraph实现，采用以下设计思路：

1. **咨询处理**：基于规则和知识库处理常见咨询问题
2. **Java微服务集成**：通过HTTP API调用Java微服务，不直接操作数据库
3. **权限验证**：验证医生身份和权限
4. **错误处理**：Java微服务调用失败时优雅降级

## 3.2 设计图(流程图/时序图/其他)

### 3.2.1 病历查询流程

```
医生: "查询患者张三的病历"
    ↓
医生助手智能体: "正在查询..."
    ↓
调用query_patient_record工具
    ↓
HTTP GET请求到Java微服务
    ↓
Java微服务返回病历记录
    ↓
格式化返回结果
    ↓
返回: "患者张三的病历如下：..."
```

### 3.2.2 处方开具流程

```
医生: "为患者张三开具处方"
    ↓
医生助手智能体: "请告诉我药品名称和剂量"
    ↓
医生: "阿司匹林100mg，每日一次"
    ↓
医生助手智能体: "请确认处方信息"
    ↓
医生: "确认"
    ↓
调用prescribe_medicine工具
    ↓
HTTP POST请求到Java微服务
    ↓
Java微服务处理并返回结果
    ↓
返回: "处方开具成功，处方编号：..."
```

## 3.3 ER设计

### 3.3.1 表清单

| 表名 | 描述 | 是否分表 | 备注 |
| ------ | ------ | ------ | ------ |
| - | - | - | 病历和处方数据存储在Java微服务中，本系统不涉及数据库表设计 |

### 3.3.2 ER关系

医生助手智能体不直接操作数据库，数据存储在Java微服务中。

## 3.4 接口设计

### 3.4.1 接口清单

| 接口地址 | 接口名称 | 备注 |
| ------ | ------ | ------ |
| - | - | 医生助手智能体通过路由智能体调用，不直接提供HTTP接口 |

### 3.4.2 工具接口

#### 功能描述：查询病历工具

<table>
    <th colspan="4">功能描述：<span>查询患者病历记录</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>DOC-002</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">query_patient_record</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>patient_id</td><td>str</td><td>Y</td><td>患者ID</td>
    </tr>
    <tr>
        <td>doctor_id</td><td>str</td><td>Y</td><td>医生ID</td>
    </tr>
    <tr>
        <td>start_date</td><td>datetime</td><td>N</td><td>开始日期</td>
    </tr>
    <tr>
        <td>end_date</td><td>datetime</td><td>N</td><td>结束日期</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>records</td><td>list</td><td colspan="2">病历记录列表</td>
    </tr>
</table>

#### 功能描述：更新病历工具

<table>
    <th colspan="4">功能描述：<span>更新患者病历记录</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>DOC-002</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">update_patient_record</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>record_id</td><td>str</td><td>Y</td><td>病历记录ID</td>
    </tr>
    <tr>
        <td>diagnosis</td><td>str</td><td>N</td><td>诊断结果</td>
    </tr>
    <tr>
        <td>notes</td><td>str</td><td>N</td><td>备注信息</td>
    </tr>
    <tr>
        <td>doctor_id</td><td>str</td><td>Y</td><td>医生ID</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>result</td><td>str</td><td colspan="2">更新结果消息</td>
    </tr>
</table>

#### 功能描述：开具处方工具

<table>
    <th colspan="4">功能描述：<span>为患者开具处方</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>DOC-003</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">prescribe_medicine</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>patient_id</td><td>str</td><td>Y</td><td>患者ID</td>
    </tr>
    <tr>
        <td>doctor_id</td><td>str</td><td>Y</td><td>医生ID</td>
    </tr>
    <tr>
        <td>medicines</td><td>list</td><td>Y</td><td>药品列表（包含药品名称、剂量、用法等）</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>result</td><td>str</td><td colspan="2">开具结果消息</td>
    </tr>
</table>

#### 功能描述：查询处方工具

<table>
    <th colspan="4">功能描述：<span>查询患者处方记录</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>DOC-003</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">query_prescription</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>patient_id</td><td>str</td><td>Y</td><td>患者ID</td>
    </tr>
    <tr>
        <td>doctor_id</td><td>str</td><td>Y</td><td>医生ID</td>
    </tr>
    <tr>
        <td>start_date</td><td>datetime</td><td>N</td><td>开始日期</td>
    </tr>
    <tr>
        <td>end_date</td><td>datetime</td><td>N</td><td>结束日期</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>prescriptions</td><td>list</td><td colspan="2">处方记录列表</td>
    </tr>
</table>

## 3.5 其他

### 3.5.1 Java微服务集成

医生助手智能体通过HTTP API调用Java微服务，具体实现方式：

```python
import httpx

@tool("query_patient_record", description="查询患者病历记录")
async def query_patient_record(
    patient_id: str,
    doctor_id: str,
    start_date: str = None,
    end_date: str = None
) -> str:
    """调用Java微服务查询患者病历记录"""
    try:
        async with httpx.AsyncClient() as client:
            params = {
                "patientId": patient_id,
                "doctorId": doctor_id
            }
            if start_date:
                params["startDate"] = start_date
            if end_date:
                params["endDate"] = end_date
            
            response = await client.get(
                "http://java-service:8080/api/patient/record/query",
                params=params,
                headers={
                    "Authorization": f"Bearer {get_token()}"
                },
                timeout=10.0
            )
            response.raise_for_status()
            result = response.json()
            
            if result.get("success"):
                records = result.get("data", {}).get("records", [])
                return format_records(records)
            else:
                return f"查询失败：{result.get('message', '未知错误')}"
                
    except httpx.HTTPError as e:
        logger.error(f"调用Java微服务失败: {e}")
        return "病历查询服务暂时不可用，请稍后重试。"
    except Exception as e:
        logger.error(f"查询病历时发生错误: {e}")
        return f"查询病历时发生错误：{str(e)}"
```

### 3.5.2 系统提示词

```
你是一个专业的医生助手，协助医生处理日常咨询、病历管理和处方管理。

你的职责：
1. 处理患者的常见咨询问题，提供医疗建议（基于规则和知识库）
2. 引导患者到合适的科室
3. 查询和更新患者病历记录
4. 查询和开具患者处方记录

注意事项：
- 需要验证医生身份和权限
- 调用Java微服务时需要处理异常情况
- 医疗建议需要谨慎，建议患者咨询专业医生

记住：始终以患者为中心，提供专业、友好的服务。
```

### 3.5.3 错误处理

- **Java微服务不可用**：返回友好的错误提示，建议用户稍后重试
- **权限验证失败**：返回权限不足的错误提示
- **网络超时**：设置合理的超时时间（10秒），超时后返回错误提示
- **数据验证失败**：在调用Java微服务前验证数据合法性

### 3.5.4 配置说明

- **Java微服务地址**：通过环境变量或配置文件配置
- **认证Token**：通过环境变量或配置文件配置
- **超时设置**：默认10秒，可通过配置调整
- **权限验证**：集成权限验证服务，验证医生权限

