# V2.0-04 项目结构调整

## 1. 概述

### 1.1 调整目标

本次项目结构调整的主要目标是：
1. **分离基础代码和业务代码**：将可复用的基础设施代码与项目特定的业务逻辑代码分离，提高代码的可维护性和可复用性
2. **优化基础代码模块**：重构基础代码，使其更加通用、健壮、易用
3. **优化项目结构**：使项目结构更加清晰，便于后续开发和维护
4. **提升代码质量**：通过结构优化，提升代码的可读性、可测试性和可扩展性

### 1.2 调整原则

1. **向后兼容**：调整过程中保持API接口的向后兼容，避免影响现有功能
2. **渐进式重构**：采用渐进式重构方式，分阶段实施，确保每个阶段都可以独立测试
3. **最小化影响**：尽量减少对现有代码的影响，优先调整结构，再优化实现
4. **文档同步**：结构调整过程中同步更新相关文档

### 1.3 文档结构

本文档包含以下内容：
- 当前项目结构分析
- 目标项目结构设计
- 基础代码模块优化方案
- 业务代码模块调整方案
- 其他模块改造方案
- 实施计划
- 迁移指南

## 2. 当前项目结构分析

### 2.1 当前目录结构

```
V2_0_Agent/
├── 01_backendServer.py          # 后端API服务入口
├── 02_frontendServer.py         # 前端客户端入口
├── requirements.txt             # 依赖包列表
├── requirements.lock            # 依赖包锁定版本
├── README.md                    # 项目说明文档
├── alembic.ini                  # Alembic配置文件
├── generate_lock.py             # 依赖锁定生成脚本
├── utils/                       # 工具模块（混合基础代码和业务代码）
│   ├── __init__.py
│   ├── config.py                # 配置管理（基础代码）
│   ├── database.py              # 数据库连接池（基础代码）
│   ├── redis_manager.py        # Redis管理（基础代码）
│   ├── logging_config.py       # 日志配置（基础代码）
│   ├── llms.py                 # LLM初始化（基础代码）
│   ├── llm_callbacks.py        # LLM回调（基础代码）
│   ├── router_state.py          # 路由状态定义（业务代码）
│   ├── router.py                # 路由节点实现（业务代码）
│   ├── router_graph.py          # 路由图创建（业务代码）
│   ├── agents/                  # 智能体模块（业务代码）
│   │   ├── __init__.py
│   │   ├── blood_pressure_agent.py
│   │   ├── appointment_agent.py
│   │   └── diagnosis_agent.py
│   ├── tools/                   # 工具模块（业务代码）
│   │   ├── __init__.py
│   │   ├── router_tools.py
│   │   ├── blood_pressure_tools.py
│   │   ├── appointment_tools.py
│   │   └── diagnosis_tools.py
│   ├── rag/                     # RAG模块（业务代码）
│   │   ├── __init__.py
│   │   ├── document_loader.py
│   │   ├── text_splitter.py
│   │   ├── embedding_service.py
│   │   ├── vector_store.py
│   │   ├── rag_retriever.py
│   │   └── knowledge_base_manager.py
│   └── db/                      # 数据库模型和CRUD（业务代码）
│       ├── __init__.py
│       ├── base.py
│       ├── crud.py
│       └── models/
│           ├── __init__.py
│           ├── blood_pressure_model.py
│           └── appointment_model.py
├── scripts/                     # 数据库脚本
├── test/                        # 测试文件目录
├── alembic/                     # 数据库迁移
├── docs/                        # 文档目录
├── data/                        # 数据文件目录
└── logfile/                     # 日志文件目录
```

### 2.2 问题分析

#### 2.2.1 基础代码与业务代码混合

**问题**：
- `utils/` 目录下同时包含基础代码（如 `config.py`、`database.py`）和业务代码（如 `router.py`、`router_graph.py`）
- 基础代码模块与业务代码模块耦合，不利于代码复用和维护

**影响**：
- 基础代码难以在其他项目中复用
- 业务代码变更可能影响基础代码的稳定性
- 代码职责不清晰，增加维护成本

#### 2.2.2 基础代码模块问题

**问题**：
1. **配置管理（config.py）**：
   - 配置项硬编码，缺乏类型检查和验证
   - 没有配置加载优先级机制
   - 缺少配置热更新支持

2. **数据库管理（database.py）**：
   - 连接池管理逻辑复杂，职责不够单一
   - 缺少连接池健康检查机制
   - 错误处理不够完善

3. **日志配置（logging_config.py）**：
   - 日志配置逻辑分散
   - 缺少日志级别动态调整机制
   - 日志格式不够灵活

4. **LLM管理（llms.py）**：
   - LLM初始化逻辑与业务配置耦合
   - 缺少LLM连接池管理
   - 错误处理不够统一

#### 2.2.3 业务代码模块问题

**问题**：
1. **路由模块**：
   - `router.py`、`router_graph.py`、`router_state.py` 分散在 `utils/` 根目录
   - 缺少统一的路由模块入口

2. **智能体模块**：
   - 智能体实现分散，缺少统一的接口定义
   - 智能体创建逻辑重复

3. **工具模块**：
   - 工具实现分散，缺少统一的工具管理机制

#### 2.2.4 其他模块问题

**问题**：
1. **入口文件**：
   - `01_backendServer.py` 和 `02_frontendServer.py` 命名不够规范
   - 缺少统一的入口管理

2. **测试目录**：
   - 测试文件组织不够清晰
   - 缺少测试工具和辅助函数

## 3. 目标项目结构设计

### 3.1 新的目录结构

```
V2_0_Agent/
├── app/                         # 应用主目录
│   ├── __init__.py
│   ├── main.py                  # 后端服务入口（原 01_backendServer.py）
│   ├── client.py                # 前端客户端入口（原 02_frontendServer.py）
│   └── api/                     # API路由模块
│       ├── __init__.py
│       ├── routes.py            # API路由定义
│       └── models.py            # API数据模型
├── core/                        # 核心基础代码模块（可复用）
│   ├── __init__.py
│   ├── config/                  # 配置管理模块
│   │   ├── __init__.py
│   │   ├── base.py              # 配置基类
│   │   ├── settings.py          # 项目配置（从原 config.py 重构）
│   │   └── validators.py        # 配置验证器
│   ├── database/                # 数据库管理模块
│   │   ├── __init__.py
│   │   ├── pool.py              # 连接池管理（从原 database.py 重构）
│   │   ├── health.py            # 健康检查
│   │   └── exceptions.py        # 数据库异常
│   ├── cache/                   # 缓存管理模块
│   │   ├── __init__.py
│   │   ├── redis.py             # Redis管理（从原 redis_manager.py 重构）
│   │   └── exceptions.py        # 缓存异常
│   ├── logging/                 # 日志管理模块
│   │   ├── __init__.py
│   │   ├── config.py            # 日志配置（从原 logging_config.py 重构）
│   │   ├── formatters.py        # 日志格式化器
│   │   └── handlers.py          # 日志处理器
│   └── llm/                     # LLM管理模块
│       ├── __init__.py
│       ├── factory.py           # LLM工厂（从原 llms.py 重构）
│       ├── callbacks.py         # LLM回调（从原 llm_callbacks.py 重构）
│       └── exceptions.py        # LLM异常
├── domain/                      # 业务领域模块
│   ├── __init__.py
│   ├── router/                  # 路由业务模块
│   │   ├── __init__.py
│   │   ├── state.py             # 路由状态（从原 router_state.py）
│   │   ├── node.py              # 路由节点（从原 router.py）
│   │   ├── graph.py             # 路由图（从原 router_graph.py）
│   │   └── tools/               # 路由工具
│   │       ├── __init__.py
│   │       └── router_tools.py
│   ├── agents/                  # 智能体业务模块
│   │   ├── __init__.py
│   │   ├── base.py             # 智能体基类
│   │   ├── blood_pressure/     # 血压记录智能体
│   │   │   ├── __init__.py
│   │   │   ├── agent.py
│   │   │   └── tools.py
│   │   ├── appointment/        # 复诊管理智能体
│   │   │   ├── __init__.py
│   │   │   ├── agent.py
│   │   │   └── tools.py
│   │   └── diagnosis/          # 诊断智能体
│   │       ├── __init__.py
│   │       ├── base.py
│   │       ├── internal_medicine.py
│   │       ├── surgery.py
│   │       ├── pediatrics.py
│   │       ├── gynecology.py
│   │       ├── cardiology.py
│   │       ├── general.py
│   │       └── tools.py
│   ├── rag/                     # RAG业务模块
│   │   ├── __init__.py
│   │   ├── document_loader.py
│   │   ├── text_splitter.py
│   │   ├── embedding_service.py
│   │   ├── vector_store.py
│   │   ├── rag_retriever.py
│   │   └── knowledge_base_manager.py
│   └── models/                  # 数据模型模块
│       ├── __init__.py
│       ├── base.py             # 模型基类（从原 db/base.py）
│       ├── crud.py             # CRUD操作（从原 db/crud.py）
│       └── schemas/            # 数据模型定义
│           ├── __init__.py
│           ├── blood_pressure.py
│           └── appointment.py
├── infrastructure/             # 基础设施模块
│   ├── __init__.py
│   ├── database/               # 数据库基础设施
│   │   ├── __init__.py
│   │   └── migrations/        # 数据库迁移（从 alembic/ 移动）
│   └── storage/                # 存储基础设施
│       └── __init__.py
├── scripts/                     # 脚本目录
│   ├── create_tables.py        # 创建表脚本
│   └── build_kb.py             # 构建知识库脚本
├── tests/                       # 测试目录（重命名自 test/）
│   ├── __init__.py
│   ├── conftest.py             # pytest配置
│   ├── unit/                   # 单元测试
│   ├── integration/            # 集成测试
│   └── e2e/                    # 端到端测试
├── docs/                        # 文档目录
├── data/                        # 数据文件目录
├── logfile/                     # 日志文件目录
├── requirements.txt             # 依赖包列表
├── requirements.lock            # 依赖包锁定版本
├── alembic.ini                  # Alembic配置文件
├── generate_lock.py             # 依赖锁定生成脚本
└── README.md                    # 项目说明文档
```

### 3.2 结构调整说明

#### 3.2.1 核心基础代码模块（core/）

**设计原则**：
- 完全独立于业务逻辑
- 可复用到其他项目
- 提供清晰的API接口
- 完善的错误处理和日志记录

**模块划分**：
1. **config/**：配置管理
   - 支持环境变量、配置文件、默认值三级配置
   - 类型检查和验证
   - 配置热更新支持

2. **database/**：数据库管理
   - 连接池管理
   - 健康检查
   - 事务管理
   - 错误处理

3. **cache/**：缓存管理
   - Redis连接管理
   - 缓存操作封装
   - 错误处理

4. **logging/**：日志管理
   - 统一的日志配置
   - 灵活的日志格式
   - 日志级别动态调整

5. **llm/**：LLM管理
   - LLM工厂模式
   - 连接池管理
   - 回调处理器
   - 错误处理

#### 3.2.2 业务领域模块（domain/）

**设计原则**：
- 按业务领域组织代码
- 清晰的模块边界
- 统一的接口定义

**模块划分**：
1. **router/**：路由业务
   - 路由状态定义
   - 路由节点实现
   - 路由图构建
   - 路由工具

2. **agents/**：智能体业务
   - 智能体基类
   - 各业务智能体实现
   - 智能体工具

3. **rag/**：RAG业务
   - 文档处理
   - 向量化
   - 检索

4. **models/**：数据模型
   - 数据库模型定义
   - CRUD操作
   - 数据验证

#### 3.2.3 应用入口模块（app/）

**设计原则**：
- 清晰的入口点
- 统一的API管理
- 生命周期管理

## 4. 基础代码模块优化方案

### 4.1 配置管理模块（core/config/）

#### 4.1.1 当前问题

1. 配置项硬编码，缺乏类型检查
2. 没有配置加载优先级机制
3. 缺少配置验证和默认值管理
4. 配置项分散，难以管理

#### 4.1.2 优化方案

**文件结构**：
```
core/config/
├── __init__.py
├── base.py              # 配置基类
├── settings.py          # 项目配置（从原 config.py 重构）
└── validators.py       # 配置验证器
```

**核心设计**：

1. **配置基类（base.py）**：
```python
from pydantic import BaseSettings, Field
from typing import Optional
import os

class BaseConfig(BaseSettings):
    """配置基类，提供统一的配置管理接口"""
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"
        case_sensitive = False
    
    def get(self, key: str, default=None):
        """获取配置项"""
        return getattr(self, key, default)
    
    def validate(self):
        """验证配置"""
        # 实现配置验证逻辑
        pass
```

2. **项目配置（settings.py）**：
```python
from .base import BaseConfig
from .validators import validate_db_uri, validate_redis_config

class Settings(BaseConfig):
    """项目配置类"""
    
    # 数据库配置
    db_uri: str = Field(
        default="postgresql://postgres:password@localhost:5432/dbname",
        description="PostgreSQL数据库连接URI"
    )
    db_timezone: str = Field(default="Asia/Shanghai", description="数据库时区")
    db_min_size: int = Field(default=5, ge=1, le=100, description="连接池最小连接数")
    db_max_size: int = Field(default=10, ge=1, le=100, description="连接池最大连接数")
    
    # Redis配置
    redis_host: str = Field(default="localhost", description="Redis服务器地址")
    redis_port: int = Field(default=6379, ge=1, le=65535, description="Redis服务器端口")
    redis_db: int = Field(default=0, ge=0, le=15, description="Redis数据库编号")
    redis_ttl: int = Field(default=3600, ge=1, description="Redis键过期时间（秒）")
    
    # LLM配置
    llm_type: str = Field(default="deepseek-chat", description="LLM类型")
    llm_temperature: float = Field(default=0.0, ge=0.0, le=2.0, description="LLM温度参数")
    llm_api_key_env_name: str = Field(default="DEEPSEEK_API_KEY", description="LLM API Key环境变量名")
    
    # 服务配置
    host: str = Field(default="0.0.0.0", description="服务监听地址")
    port: int = Field(default=8001, ge=1, le=65535, description="服务监听端口")
    
    # 路由配置
    intent_confidence_threshold: float = Field(default=0.7, ge=0.0, le=1.0, description="意图识别置信度阈值")
    max_dialogue_rounds: int = Field(default=100, ge=1, description="最大对话轮数")
    
    # 日志配置
    log_file: str = Field(default="logfile/app.log", description="日志文件路径")
    log_max_bytes: int = Field(default=5 * 1024 * 1024, description="日志文件最大字节数")
    log_backup_count: int = Field(default=3, ge=1, description="日志备份文件数量")
    
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self._validate()
    
    def _validate(self):
        """验证配置"""
        validate_db_uri(self.db_uri)
        validate_redis_config(self.redis_host, self.redis_port)
```

3. **配置验证器（validators.py）**：
```python
def validate_db_uri(uri: str):
    """验证数据库URI格式"""
    if not uri.startswith("postgresql://"):
        raise ValueError(f"无效的数据库URI格式: {uri}")

def validate_redis_config(host: str, port: int):
    """验证Redis配置"""
    if not host:
        raise ValueError("Redis主机地址不能为空")
    if not (1 <= port <= 65535):
        raise ValueError(f"Redis端口必须在1-65535之间: {port}")
```

#### 4.1.3 迁移步骤

1. 创建 `core/config/` 目录结构
2. 实现配置基类和验证器
3. 重构 `config.py` 为 `settings.py`
4. 更新所有导入路径
5. 测试配置加载和验证

### 4.2 数据库管理模块（core/database/）

#### 4.2.1 当前问题

1. 连接池管理逻辑复杂
2. 缺少连接池健康检查机制
3. 错误处理不够完善
4. 缺少连接池监控

#### 4.2.2 优化方案

**文件结构**：
```
core/database/
├── __init__.py
├── pool.py              # 连接池管理（从原 database.py 重构）
├── health.py            # 健康检查
└── exceptions.py        # 数据库异常
```

**核心设计**：

1. **连接池管理（pool.py）**：
```python
from typing import Optional
from psycopg_pool import AsyncConnectionPool
from sqlalchemy.ext.asyncio import AsyncEngine, create_async_engine
from ..config import Settings
from .exceptions import DatabaseError, ConnectionPoolError
from .health import HealthChecker

class DatabasePool:
    """数据库连接池管理类（优化版）"""
    
    def __init__(self, settings: Settings):
        self.settings = settings
        self._pool: Optional[AsyncConnectionPool] = None
        self._engine: Optional[AsyncEngine] = None
        self._health_checker = HealthChecker(self)
    
    async def initialize(self):
        """初始化连接池"""
        try:
            await self._create_pool()
            await self._create_engine()
            await self._health_checker.check()
        except Exception as e:
            raise ConnectionPoolError(f"连接池初始化失败: {str(e)}") from e
    
    async def _create_pool(self):
        """创建LangGraph连接池"""
        # 实现连接池创建逻辑
        pass
    
    async def _create_engine(self):
        """创建SQLAlchemy引擎"""
        # 实现引擎创建逻辑
        pass
    
    async def health_check(self) -> dict:
        """健康检查"""
        return await self._health_checker.check()
    
    async def close(self):
        """关闭连接池"""
        # 实现关闭逻辑
        pass
```

2. **健康检查（health.py）**：
```python
class HealthChecker:
    """连接池健康检查器"""
    
    def __init__(self, pool: DatabasePool):
        self.pool = pool
    
    async def check(self) -> dict:
        """执行健康检查"""
        result = {
            "status": "healthy",
            "langgraph_pool": await self._check_langgraph_pool(),
            "sqlalchemy_engine": await self._check_sqlalchemy_engine()
        }
        return result
    
    async def _check_langgraph_pool(self) -> dict:
        """检查LangGraph连接池"""
        # 实现检查逻辑
        pass
    
    async def _check_sqlalchemy_engine(self) -> dict:
        """检查SQLAlchemy引擎"""
        # 实现检查逻辑
        pass
```

3. **异常定义（exceptions.py）**：
```python
class DatabaseError(Exception):
    """数据库基础异常"""
    pass

class ConnectionPoolError(DatabaseError):
    """连接池错误"""
    pass

class QueryError(DatabaseError):
    """查询错误"""
    pass
```

#### 4.2.3 迁移步骤

1. 创建 `core/database/` 目录结构
2. 实现异常类和健康检查器
3. 重构 `database.py` 为 `pool.py`
4. 更新所有导入路径
5. 测试连接池管理和健康检查

### 4.3 缓存管理模块（core/cache/）

#### 4.3.1 当前问题

1. Redis管理逻辑简单，缺少高级功能
2. 错误处理不够完善
3. 缺少连接池管理
4. 缺少缓存操作封装

#### 4.3.2 优化方案

**文件结构**：
```
core/cache/
├── __init__.py
├── redis.py             # Redis管理（从原 redis_manager.py 重构）
└── exceptions.py        # 缓存异常
```

**核心设计**：

1. **Redis管理（redis.py）**：
```python
import redis.asyncio as redis
from typing import Optional, Any
from ..config import Settings
from .exceptions import CacheError, ConnectionError

class RedisManager:
    """Redis连接管理类（优化版）"""
    
    def __init__(self, settings: Settings):
        self.settings = settings
        self._client: Optional[redis.Redis] = None
        self._pool: Optional[redis.ConnectionPool] = None
    
    async def initialize(self):
        """初始化Redis连接"""
        try:
            self._pool = redis.ConnectionPool(
                host=self.settings.redis_host,
                port=self.settings.redis_port,
                db=self.settings.redis_db,
                decode_responses=True
            )
            self._client = redis.Redis(connection_pool=self._pool)
            await self._client.ping()
        except Exception as e:
            raise ConnectionError(f"Redis连接失败: {str(e)}") from e
    
    async def get(self, key: str) -> Optional[str]:
        """获取键值"""
        try:
            return await self._client.get(key)
        except Exception as e:
            raise CacheError(f"Redis GET操作失败: {str(e)}") from e
    
    async def set(self, key: str, value: str, ex: Optional[int] = None) -> bool:
        """设置键值"""
        try:
            return await self._client.set(key, value, ex=ex or self.settings.redis_ttl)
        except Exception as e:
            raise CacheError(f"Redis SET操作失败: {str(e)}") from e
    
    async def close(self):
        """关闭连接"""
        if self._client:
            await self._client.close()
        if self._pool:
            await self._pool.disconnect()
```

2. **异常定义（exceptions.py）**：
```python
class CacheError(Exception):
    """缓存基础异常"""
    pass

class ConnectionError(CacheError):
    """连接错误"""
    pass

class OperationError(CacheError):
    """操作错误"""
    pass
```

#### 4.3.3 迁移步骤

1. 创建 `core/cache/` 目录结构
2. 实现异常类
3. 重构 `redis_manager.py` 为 `redis.py`
4. 更新所有导入路径
5. 测试Redis连接和操作

### 4.4 日志管理模块（core/logging/）

#### 4.4.1 当前问题

1. 日志配置逻辑分散
2. 缺少日志级别动态调整机制
3. 日志格式不够灵活
4. 缺少日志过滤机制

#### 4.4.2 优化方案

**文件结构**：
```
core/logging/
├── __init__.py
├── config.py            # 日志配置（从原 logging_config.py 重构）
├── formatters.py        # 日志格式化器
└── handlers.py         # 日志处理器
```

**核心设计**：

1. **日志配置（config.py）**：
```python
import logging
import sys
from pathlib import Path
from concurrent_log_handler import ConcurrentRotatingFileHandler
from ..config import Settings
from .formatters import create_formatter
from .handlers import create_console_handler, create_file_handler

def setup_logging(settings: Settings):
    """设置统一的日志配置"""
    root_logger = logging.getLogger()
    root_logger.handlers = []
    root_logger.setLevel(logging.DEBUG)
    
    # 创建格式化器
    formatter = create_formatter()
    
    # 添加控制台处理器
    console_handler = create_console_handler(formatter)
    root_logger.addHandler(console_handler)
    
    # 添加文件处理器
    log_file = Path(settings.log_file)
    log_file.parent.mkdir(parents=True, exist_ok=True)
    file_handler = create_file_handler(
        log_file,
        formatter,
        max_bytes=settings.log_max_bytes,
        backup_count=settings.log_backup_count
    )
    root_logger.addHandler(file_handler)
    
    # 设置第三方库日志级别
    _configure_third_party_loggers()
    
    root_logger.info("日志系统初始化完成")
```

2. **格式化器（formatters.py）**：
```python
import logging
from typing import Optional

def create_formatter(
    fmt: Optional[str] = None,
    datefmt: Optional[str] = None
) -> logging.Formatter:
    """创建日志格式化器"""
    if fmt is None:
        fmt = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    if datefmt is None:
        datefmt = "%Y-%m-%d %H:%M:%S"
    return logging.Formatter(fmt, datefmt=datefmt)
```

3. **处理器（handlers.py）**：
```python
import logging
import sys
from pathlib import Path
from concurrent_log_handler import ConcurrentRotatingFileHandler
from typing import Optional
from .formatters import create_formatter

def create_console_handler(
    formatter: Optional[logging.Formatter] = None
) -> logging.StreamHandler:
    """创建控制台处理器"""
    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(logging.DEBUG)
    if formatter:
        handler.setFormatter(formatter)
    return handler

def create_file_handler(
    log_file: Path,
    formatter: Optional[logging.Formatter] = None,
    max_bytes: int = 5 * 1024 * 1024,
    backup_count: int = 3
) -> ConcurrentRotatingFileHandler:
    """创建文件处理器"""
    handler = ConcurrentRotatingFileHandler(
        str(log_file),
        maxBytes=max_bytes,
        backupCount=backup_count
    )
    handler.setLevel(logging.DEBUG)
    if formatter:
        handler.setFormatter(formatter)
    return handler
```

#### 4.4.3 迁移步骤

1. 创建 `core/logging/` 目录结构
2. 实现格式化器和处理器
3. 重构 `logging_config.py` 为 `config.py`
4. 更新所有导入路径
5. 测试日志配置和输出

### 4.5 LLM管理模块（core/llm/）

#### 4.5.1 当前问题

1. LLM初始化逻辑与业务配置耦合
2. 缺少LLM连接池管理
3. 错误处理不够统一
4. 缺少LLM健康检查

#### 4.5.2 优化方案

**文件结构**：
```
core/llm/
├── __init__.py
├── factory.py           # LLM工厂（从原 llms.py 重构）
├── callbacks.py         # LLM回调（从原 llm_callbacks.py 重构）
└── exceptions.py        # LLM异常
```

**核心设计**：

1. **LLM工厂（factory.py）**：
```python
from typing import Optional, List
from langchain.chat_models import init_chat_model
from langchain_core.language_models.chat_models import BaseChatModel
from ..config import Settings
from .callbacks import get_model_interaction_logger
from .exceptions import LLMError, InitializationError

class LLMFactory:
    """LLM工厂类"""
    
    def __init__(self, settings: Settings):
        self.settings = settings
    
    def create(
        self,
        model: Optional[str] = None,
        temperature: Optional[float] = None,
        callbacks: Optional[List] = None
    ) -> BaseChatModel:
        """创建LLM实例"""
        model = model or self.settings.llm_type
        temperature = temperature if temperature is not None else self.settings.llm_temperature
        
        try:
            api_key = self._get_api_key()
            llm = init_chat_model(
                model=model,
                temperature=temperature,
                api_key=api_key
            )
            
            if callbacks is None:
                callbacks = [get_model_interaction_logger()]
            
            # 设置回调
            if hasattr(llm, 'callbacks'):
                llm.callbacks = callbacks
            
            return llm
        except Exception as e:
            raise InitializationError(f"LLM初始化失败: {str(e)}") from e
    
    def _get_api_key(self) -> str:
        """获取API Key"""
        api_key = os.getenv(self.settings.llm_api_key_env_name)
        if not api_key:
            raise InitializationError(
                f"请设置环境变量 {self.settings.llm_api_key_env_name}"
            )
        return api_key
```

2. **LLM回调（callbacks.py）**：
```python
# 从原 llm_callbacks.py 移动，保持原有实现
# 可以进一步优化，添加更多回调功能
```

3. **异常定义（exceptions.py）**：
```python
class LLMError(Exception):
    """LLM基础异常"""
    pass

class InitializationError(LLMError):
    """初始化错误"""
    pass

class APIError(LLMError):
    """API错误"""
    pass
```

#### 4.5.3 迁移步骤

1. 创建 `core/llm/` 目录结构
2. 实现异常类
3. 重构 `llms.py` 为 `factory.py`
4. 移动 `llm_callbacks.py` 到 `callbacks.py`
5. 更新所有导入路径
6. 测试LLM初始化和调用

## 5. 业务代码模块调整方案

### 5.1 路由模块（domain/router/）

#### 5.1.1 调整方案

**文件结构**：
```
domain/router/
├── __init__.py
├── state.py             # 路由状态（从 utils/router_state.py）
├── node.py              # 路由节点（从 utils/router.py）
├── graph.py             # 路由图（从 utils/router_graph.py）
└── tools/               # 路由工具
    ├── __init__.py
    └── router_tools.py  # 从 utils/tools/router_tools.py
```

**调整内容**：
1. 将 `router_state.py`、`router.py`、`router_graph.py` 移动到 `domain/router/`
2. 将路由工具移动到 `domain/router/tools/`
3. 更新所有导入路径
4. 统一路由模块的接口

### 5.2 智能体模块（domain/agents/）

#### 5.2.1 调整方案

**文件结构**：
```
domain/agents/
├── __init__.py
├── base.py              # 智能体基类（新建）
├── blood_pressure/      # 血压记录智能体
│   ├── __init__.py
│   ├── agent.py         # 从 utils/agents/blood_pressure_agent.py
│   └── tools.py         # 从 utils/tools/blood_pressure_tools.py
├── appointment/         # 复诊管理智能体
│   ├── __init__.py
│   ├── agent.py         # 从 utils/agents/appointment_agent.py
│   └── tools.py         # 从 utils/tools/appointment_tools.py
└── diagnosis/          # 诊断智能体
    ├── __init__.py
    ├── base.py          # 诊断智能体基类
    ├── internal_medicine.py  # 从 utils/agents/diagnosis_agent.py 拆分
    ├── surgery.py
    ├── pediatrics.py
    ├── gynecology.py
    ├── cardiology.py
    ├── general.py
    └── tools.py         # 从 utils/tools/diagnosis_tools.py
```

**调整内容**：
1. 创建智能体基类，定义统一接口
2. 按业务领域组织智能体代码
3. 将工具代码移动到对应的智能体目录
4. 拆分诊断智能体为独立的文件
5. 更新所有导入路径

### 5.3 RAG模块（domain/rag/）

#### 5.3.1 调整方案

**文件结构**：
```
domain/rag/
├── __init__.py
├── document_loader.py   # 从 utils/rag/document_loader.py
├── text_splitter.py     # 从 utils/rag/text_splitter.py
├── embedding_service.py  # 从 utils/rag/embedding_service.py
├── vector_store.py       # 从 utils/rag/vector_store.py
├── rag_retriever.py     # 从 utils/rag/rag_retriever.py
└── knowledge_base_manager.py  # 从 utils/rag/knowledge_base_manager.py
```

**调整内容**：
1. 将RAG模块从 `utils/rag/` 移动到 `domain/rag/`
2. 更新所有导入路径
3. 优化RAG模块的接口设计

### 5.4 数据模型模块（domain/models/）

#### 5.4.1 调整方案

**文件结构**：
```
domain/models/
├── __init__.py
├── base.py              # 从 utils/db/base.py
├── crud.py              # 从 utils/db/crud.py
└── schemas/             # 数据模型定义
    ├── __init__.py
    ├── blood_pressure.py  # 从 utils/db/models/blood_pressure_model.py
    └── appointment.py     # 从 utils/db/models/appointment_model.py
```

**调整内容**：
1. 将数据库模型从 `utils/db/` 移动到 `domain/models/`
2. 重命名 `models/` 为 `schemas/` 以区分数据库模型和Pydantic模型
3. 更新所有导入路径

## 6. 其他模块改造方案

### 6.1 应用入口模块（app/）

#### 6.1.1 调整方案

**文件结构**：
```
app/
├── __init__.py
├── main.py              # 后端服务入口（从 01_backendServer.py 重构）
├── client.py            # 前端客户端入口（从 02_frontendServer.py 重构）
└── api/                 # API路由模块
    ├── __init__.py
    ├── routes.py        # API路由定义（从 main.py 拆分）
    └── models.py       # API数据模型（从 main.py 拆分）
```

**调整内容**：
1. 重命名 `01_backendServer.py` 为 `app/main.py`
2. 重命名 `02_frontendServer.py` 为 `app/client.py`
3. 将API路由和数据模型拆分到 `app/api/`
4. 优化应用生命周期管理

### 6.2 测试模块（tests/）

#### 6.2.1 调整方案

**文件结构**：
```
tests/
├── __init__.py
├── conftest.py          # pytest配置和fixtures
├── unit/                # 单元测试
│   ├── __init__.py
│   ├── test_config.py
│   ├── test_database.py
│   └── ...
├── integration/         # 集成测试
│   ├── __init__.py
│   ├── test_router.py
│   └── ...
└── e2e/                 # 端到端测试
    ├── __init__.py
    └── test_chat_flow.py
```

**调整内容**：
1. 重命名 `test/` 为 `tests/`
2. 按测试类型组织测试文件
3. 创建 `conftest.py` 提供公共fixtures
4. 优化测试工具和辅助函数

### 6.3 基础设施模块（infrastructure/）

#### 6.3.1 调整方案

**文件结构**：
```
infrastructure/
├── __init__.py
├── database/            # 数据库基础设施
│   ├── __init__.py
│   └── migrations/     # 数据库迁移（从 alembic/ 移动）
└── storage/             # 存储基础设施
    └── __init__.py
```

**调整内容**：
1. 创建 `infrastructure/` 目录
2. 将数据库迁移移动到 `infrastructure/database/migrations/`
3. 为未来扩展预留存储基础设施目录

## 7. 实施计划

### 7.1 阶段划分

本次结构调整分为三个阶段：

#### 阶段一：基础代码模块重构（预计3-4天）

**目标**：完成基础代码模块的分离和优化

**任务清单**：
1. 创建 `core/` 目录结构
2. 实现配置管理模块（`core/config/`）
3. 实现数据库管理模块（`core/database/`）
4. 实现缓存管理模块（`core/cache/`）
5. 实现日志管理模块（`core/logging/`）
6. 实现LLM管理模块（`core/llm/`）
7. 更新所有导入路径
8. 测试基础代码模块

#### 阶段二：业务代码模块调整（预计2-3天）

**目标**：完成业务代码模块的重新组织

**任务清单**：
1. 创建 `domain/` 目录结构
2. 调整路由模块（`domain/router/`）
3. 调整智能体模块（`domain/agents/`）
4. 调整RAG模块（`domain/rag/`）
5. 调整数据模型模块（`domain/models/`）
6. 更新所有导入路径
7. 测试业务代码模块

#### 阶段三：应用入口和其他模块调整（预计1-2天）

**目标**：完成应用入口和其他模块的调整

**任务清单**：
1. 创建 `app/` 目录结构
2. 重构后端服务入口（`app/main.py`）
3. 重构前端客户端入口（`app/client.py`）
4. 调整测试模块（`tests/`）
5. 调整基础设施模块（`infrastructure/`）
6. 更新所有导入路径
7. 端到端测试

### 7.2 实施步骤

#### 步骤1：准备工作

1. 创建新的目录结构（空目录）
2. 备份现有代码
3. 创建git分支 `refactor/project-structure`

#### 步骤2：基础代码模块重构

1. **配置管理模块**：
   - 创建 `core/config/` 目录
   - 实现配置基类和验证器
   - 重构 `config.py` 为 `settings.py`
   - 更新导入路径
   - 测试配置加载

2. **数据库管理模块**：
   - 创建 `core/database/` 目录
   - 实现异常类和健康检查器
   - 重构 `database.py` 为 `pool.py`
   - 更新导入路径
   - 测试连接池管理

3. **缓存管理模块**：
   - 创建 `core/cache/` 目录
   - 实现异常类
   - 重构 `redis_manager.py` 为 `redis.py`
   - 更新导入路径
   - 测试Redis连接

4. **日志管理模块**：
   - 创建 `core/logging/` 目录
   - 实现格式化器和处理器
   - 重构 `logging_config.py` 为 `config.py`
   - 更新导入路径
   - 测试日志配置

5. **LLM管理模块**：
   - 创建 `core/llm/` 目录
   - 实现异常类
   - 重构 `llms.py` 为 `factory.py`
   - 移动 `llm_callbacks.py` 到 `callbacks.py`
   - 更新导入路径
   - 测试LLM初始化

#### 步骤3：业务代码模块调整

1. **路由模块**：
   - 创建 `domain/router/` 目录
   - 移动路由相关文件
   - 移动路由工具
   - 更新导入路径
   - 测试路由功能

2. **智能体模块**：
   - 创建 `domain/agents/` 目录
   - 创建智能体基类
   - 按业务领域组织智能体代码
   - 移动工具代码
   - 更新导入路径
   - 测试智能体功能

3. **RAG模块**：
   - 创建 `domain/rag/` 目录
   - 移动RAG相关文件
   - 更新导入路径
   - 测试RAG功能

4. **数据模型模块**：
   - 创建 `domain/models/` 目录
   - 移动数据库模型文件
   - 更新导入路径
   - 测试数据模型

#### 步骤4：应用入口和其他模块调整

1. **应用入口模块**：
   - 创建 `app/` 目录
   - 重构后端服务入口
   - 重构前端客户端入口
   - 拆分API路由和数据模型
   - 更新导入路径
   - 测试应用启动

2. **测试模块**：
   - 重命名 `test/` 为 `tests/`
   - 按测试类型组织测试文件
   - 创建 `conftest.py`
   - 更新导入路径
   - 运行所有测试

3. **基础设施模块**：
   - 创建 `infrastructure/` 目录
   - 移动数据库迁移
   - 更新导入路径

#### 步骤5：清理和验证

1. 删除旧的 `utils/` 目录
2. 删除旧的入口文件
3. 更新所有文档
4. 运行完整测试套件
5. 代码审查
6. 合并到主分支

### 7.3 风险控制

1. **向后兼容性**：
   - 保持API接口不变
   - 使用别名导入保持兼容
   - 逐步迁移，不一次性替换

2. **测试覆盖**：
   - 每个模块调整后立即测试
   - 保持测试覆盖率
   - 添加集成测试

3. **代码审查**：
   - 每个阶段完成后进行代码审查
   - 确保代码质量
   - 及时发现问题

## 8. 迁移指南

### 8.1 导入路径变更对照表

| 原路径 | 新路径 |
|--------|--------|
| `from utils.config import Config` | `from core.config import get_settings` |
| `from utils.database import get_db_pool` | `from core.database import get_db_pool` |
| `from utils.redis_manager import get_redis_manager` | `from core.cache import get_redis_manager` |
| `from utils.logging_config import setup_logging` | `from core.logging import setup_logging` |
| `from utils.llms import get_llm_by_config` | `from core.llm import get_llm_by_config` |
| `from utils.router_state import RouterState` | `from domain.router import RouterState` |
| `from utils.router import router_node` | `from domain.router import router_node` |
| `from utils.router_graph import create_router_graph` | `from domain.router import create_router_graph` |
| `from utils.agents.blood_pressure_agent import ...` | `from domain.agents.blood_pressure import ...` |
| `from utils.tools.router_tools import ...` | `from domain.router.tools import ...` |
| `from utils.rag.knowledge_base_manager import ...` | `from domain.rag import KnowledgeBaseManager` |
| `from utils.db.models.blood_pressure_model import ...` | `from domain.models.schemas.blood_pressure import ...` |

### 8.2 配置使用变更

**原方式**：
```python
from utils.config import Config

db_uri = Config.DB_URI
```

**新方式**：
```python
from core.config import get_settings

settings = get_settings()
db_uri = settings.db_uri
```

### 8.3 数据库使用变更

**原方式**：
```python
from utils.database import get_db_pool

db_pool = get_db_pool()
pool = await db_pool.create_pool()
```

**新方式**：
```python
from core.database import get_db_pool

db_pool = get_db_pool()
await db_pool.create_pool()
pool = db_pool.pool
```

### 8.4 LLM使用变更

**原方式**：
```python
from utils.llms import get_llm_by_config

llm = get_llm_by_config()
```

**新方式**：
```python
from core.llm import get_llm_by_config

llm = get_llm_by_config()
```

## 9. 总结

本次项目结构调整的主要目标是分离基础代码和业务代码，优化代码结构，提升代码质量。通过本次调整：

1. **基础代码模块（core/）**：完全独立于业务逻辑，可复用到其他项目
2. **业务代码模块（domain/）**：按业务领域组织，职责清晰
3. **应用入口模块（app/）**：统一的入口管理，结构清晰
4. **测试模块（tests/）**：按测试类型组织，便于维护

调整过程中将保持向后兼容，采用渐进式重构方式，确保每个阶段都可以独立测试。调整完成后，项目结构将更加清晰，代码质量将得到提升，为后续开发打下良好基础。

## 10. 附录

### 10.1 相关文档

- `V2.0-10-总体设计.md`：系统总体设计
- `V2.0-11-路由智能体详细设计.md`：路由智能体设计
- `项目开发计划.md`：项目开发计划

### 10.2 参考资源

- Python项目结构最佳实践
- Clean Architecture原则
- Domain-Driven Design原则

