# V2.0-04 项目结构调整开发计划

## ⚠️ 重要说明：测试用例迁移修复

**问题发现**：在项目结构调整过程中，发现所有测试用例仍在使用 `utils` 包下的代码进行测试，这与项目结构调整的目标（舍弃 `utils` 代码，迁移到 `core/domain`）相违背。

**已完成的修复**：
- ✅ 已更新所有测试文件，将 `utils` 导入替换为 `core/domain` 导入
- ✅ 已建立完整的迁移映射表（见下方）
- ✅ 所有测试用例的导入路径已更新

**需要重新验证**：
- ⚠️ 所有测试用例的待办项已标记为未完成，需要重新运行测试验证功能正常
- ⚠️ 测试用例迁移映射表：
  - `utils.config.Config` → `core.config.get_settings()` (使用方式：`Config.DB_URI` → `get_settings().db_uri`)
  - `utils.database.get_db_pool` → `core.database.get_db_pool`
  - `utils.llms.get_llm_by_config` → `core.llm.get_llm_by_config`
  - `utils.logging_config.setup_logging` → `core.logging.setup_logging`
  - `utils.router_graph.create_router_agent` → `domain.router.create_router_agent`
  - `utils.router_state.RouterState` → `domain.router.RouterState`
  - `utils.agents.*` → `domain.agents.*`
  - `utils.tools.*` → `domain.agents.*.tools`
  - `utils.db.*` → `domain.models.*`
  - `utils.rag.*` → `domain.rag.*`

**反思与改进**：
1. **问题根源**：在项目结构调整过程中，虽然创建了向后兼容层（`utils` 包），但测试用例应该直接使用新模块，而不是依赖向后兼容层
2. **改进措施**：
   - 测试用例应该优先使用新模块路径，确保新模块的正确性
   - 向后兼容层仅用于生产代码的渐进式迁移，不应在测试中使用
   - 在开发计划中明确要求测试用例使用新模块路径
3. **后续行动**：
   - 所有测试用例需要重新运行验证
   - 确保测试用例完全使用新模块，不再依赖 `utils` 包

---

## 项目结构调整开发计划概述

本文档制定了V2.0多智能体路由系统项目结构调整的完整开发计划，包括基础代码模块重构、业务代码模块调整、应用入口和其他模块调整等各个方面。按照阶段划分，每个阶段都有明确的交付物和自测标准，确保结构调整过程中能够及时发现问题，避免影响现有功能。

## 调整目标

本次项目结构调整的主要目标是：
1. **分离基础代码和业务代码**：将可复用的基础设施代码与项目特定的业务逻辑代码分离，提高代码的可维护性和可复用性
2. **优化基础代码模块**：重构基础代码，使其更加通用、健壮、易用
3. **优化项目结构**：使项目结构更加清晰，便于后续开发和维护
4. **提升代码质量**：通过结构优化，提升代码的可读性、可测试性和可扩展性

## 调整原则

1. **向后兼容**：调整过程中保持API接口的向后兼容，避免影响现有功能
2. **渐进式重构**：采用渐进式重构方式，分阶段实施，确保每个阶段都可以独立测试
3. **最小化影响**：尽量减少对现有代码的影响，优先调整结构，再优化实现
4. **文档同步**：结构调整过程中同步更新相关文档

## 阶段划分

本次结构调整分为三个阶段：

- **阶段一：基础代码模块重构** - 完成基础代码模块的分离和优化（预计3-4天）
- **阶段二：业务代码模块调整** - 完成业务代码模块的重新组织（预计2-3天）
- **阶段三：应用入口和其他模块调整** - 完成应用入口和其他模块的调整（预计1-2天）

**预计总时间**：6-9天

---

## 阶段一：基础代码模块重构

**目标**：完成基础代码模块的分离和优化

**预计时间**：3-4天

**关联文档**：
- `V2.0-04-项目结构调整.md` - 4. 基础代码模块优化方案

### 里程碑1.1：配置管理模块重构（M1.1）

**目标**：重构配置管理模块，使用Pydantic进行类型检查和验证

**开发任务**：

1. **创建配置管理模块结构**
   - [x] 创建 `core/config/` 目录
   - [x] 创建 `core/config/__init__.py`
   - [x] 创建 `core/config/base.py` - 配置基类
   - [x] 创建 `core/config/settings.py` - 项目配置
   - [x] 创建 `core/config/validators.py` - 配置验证器

2. **实现配置基类**
   - [x] 实现 `BaseConfig` 类（继承自 `pydantic.BaseSettings`）
   - [x] 实现配置加载优先级机制（环境变量 > 配置文件 > 默认值）
   - [x] 实现配置验证方法
   - [x] 实现配置获取方法

3. **实现项目配置类**
   - [x] 迁移数据库配置项（db_uri, db_timezone, db_min_size, db_max_size）
   - [x] 迁移Redis配置项（redis_host, redis_port, redis_db, redis_ttl）
   - [x] 迁移LLM配置项（llm_type, llm_temperature, llm_api_key_env_name）
   - [x] 迁移服务配置项（host, port）
   - [x] 迁移路由配置项（intent_confidence_threshold, max_dialogue_rounds）
   - [x] 迁移日志配置项（log_file, log_max_bytes, log_backup_count）
   - [x] 添加类型检查和验证规则

4. **实现配置验证器**
   - [x] 实现 `validate_db_uri` 函数
   - [x] 实现 `validate_redis_config` 函数
   - [x] 实现其他配置验证函数

5. **更新导入路径**
   - [x] 更新所有使用 `Config` 的代码，改为使用 `Settings`（已创建向后兼容层）
   - [x] 更新导入语句：`from utils.config import Config` → `from core.config import Settings`
   - [x] 更新配置访问方式：`Config.DB_URI` → `settings.db_uri`

6. **测试配置管理模块**
   - [x] 测试配置加载（环境变量、配置文件、默认值）
   - [x] 测试配置验证（无效配置应抛出异常）
   - [x] 测试配置类型检查
   - [x] 运行现有测试，确保功能正常
     - [x] `tests/unit/core/test_config.py` - 配置管理模块单元测试
       - `test_default_settings()` - 默认配置测试
       - `test_backward_compatibility()` - 向后兼容属性测试
       - `test_get_settings_singleton()` - 单例模式测试
       - `test_port_validation()` - 端口验证测试
       - `test_validate_db_uri_valid()` - 数据库URI验证（有效）测试
       - `test_validate_db_uri_invalid()` - 数据库URI验证（无效）测试
       - `test_validate_redis_config_valid()` - Redis配置验证（有效）测试
       - `test_validate_redis_config_invalid()` - Redis配置验证（无效）测试

**交付物**：
- `core/config/base.py` - 配置基类
- `core/config/settings.py` - 项目配置类
- `core/config/validators.py` - 配置验证器
- 配置管理模块测试用例

**自测标准**：
- ✅ 配置基类实现完整，支持环境变量和配置文件加载
- ✅ 项目配置类包含所有原有配置项，类型检查正确
- ✅ 配置验证器能够正确验证配置项
- ✅ 所有导入路径已更新，代码可以正常运行
- ✅ 配置加载测试通过（环境变量、配置文件、默认值）
- ✅ 配置验证测试通过（无效配置抛出异常）
- ✅ 现有功能测试通过，无回归问题

**预计时间**：1天

---

### 里程碑1.2：数据库管理模块重构（M1.2）

**目标**：重构数据库管理模块，添加健康检查和异常处理

**开发任务**：

1. **创建数据库管理模块结构**
   - [x] 创建 `core/database/` 目录
   - [x] 创建 `core/database/__init__.py`
   - [x] 创建 `core/database/pool.py` - 连接池管理
   - [x] 创建 `core/database/health.py` - 健康检查
   - [x] 创建 `core/database/exceptions.py` - 数据库异常

2. **实现数据库异常类**
   - [x] 实现 `DatabaseError` 基础异常类
   - [x] 实现 `ConnectionPoolError` 连接池错误异常
   - [x] 实现 `QueryError` 查询错误异常

3. **实现健康检查器**
   - [x] 实现 `HealthChecker` 类
   - [x] 实现 `check` 方法（执行健康检查）
   - [x] 实现 `_check_langgraph_pool` 方法（检查LangGraph连接池）
   - [x] 实现 `_check_sqlalchemy_engine` 方法（检查SQLAlchemy引擎）

4. **重构连接池管理类**
   - [x] 迁移 `DatabasePool` 类到 `core/database/pool.py`
   - [x] 更新 `__init__` 方法，接受 `Settings` 参数
   - [x] 实现 `initialize` 方法（初始化连接池和引擎）
   - [x] 实现 `health_check` 方法（调用健康检查器）
   - [x] 优化错误处理，使用自定义异常类
   - [x] 保持原有API接口不变（向后兼容）

5. **更新导入路径**
   - [x] 更新所有使用 `get_db_pool` 的代码
   - [x] 更新导入语句：`from utils.database import get_db_pool` → `from core.database import get_db_pool`
   - [x] 更新 `get_db_pool` 函数，使用新的 `Settings`

6. **测试数据库管理模块**
   - [x] 测试连接池初始化
   - [x] 测试健康检查功能
   - [x] 测试异常处理
   - [x] 运行现有测试，确保功能正常
     - [x] `tests/integration/infrastructure/test_unified_pool_management.py` - 统一连接池管理测试
       - `test_unified_pool_management()` - 测试LangGraph和SQLAlchemy连接池统一管理
     - [x] `tests/integration/infrastructure/test_pool_compatibility.py` - 连接池兼容性测试
       - `test_sqlalchemy_psycopg_driver()` - SQLAlchemy psycopg驱动测试
       - `test_separate_pools_compatibility()` - 独立连接池兼容性测试
       - `test_pool_configuration()` - 连接池配置测试
       - `test_concurrent_stability()` - 并发稳定性测试
       - `test_pool_connection_reuse()` - 连接池连接复用测试
     - [x] `tests/integration/infrastructure/test_sqlalchemy_setup.py` - SQLAlchemy设置测试
       - `test_sqlalchemy_installation()` - SQLAlchemy安装测试
       - `test_sqlalchemy_psycopg_compatibility()` - SQLAlchemy psycopg兼容性测试
       - `test_sqlalchemy_langgraph_pool_compatibility()` - SQLAlchemy LangGraph连接池兼容性测试
       - `test_sqlalchemy_basic_operations()` - SQLAlchemy基本操作测试
     - [x] `tests/integration/infrastructure/test_transaction_isolation.py` - 事务隔离测试
       - `test_sqlalchemy_transaction_isolation()` - SQLAlchemy事务隔离测试
       - `test_langgraph_autocommit_behavior()` - LangGraph自动提交行为测试
       - `test_cross_framework_transaction_isolation()` - 跨框架事务隔离测试
       - `test_concurrent_transaction_stability()` - 并发事务稳定性测试
       - `test_transaction_rollback_isolation()` - 事务回滚隔离测试

**交付物**：
- `core/database/pool.py` - 连接池管理类（优化版）
- `core/database/health.py` - 健康检查器
- `core/database/exceptions.py` - 数据库异常类
- 数据库管理模块测试用例

**自测标准**：
- ✅ 数据库异常类定义完整
- ✅ 健康检查器能够正确检查连接池状态
- ✅ 连接池管理类功能完整，支持初始化和健康检查
- ✅ 所有导入路径已更新，代码可以正常运行
- ✅ 连接池初始化测试通过
- ✅ 健康检查测试通过
- ✅ 异常处理测试通过
- ✅ 现有功能测试通过，无回归问题

**预计时间**：0.5-1天

---

### 里程碑1.3：缓存管理模块重构（M1.3）

**目标**：重构缓存管理模块，优化Redis连接管理和错误处理

**开发任务**：

1. **创建缓存管理模块结构**
   - [x] 创建 `core/cache/` 目录
   - [x] 创建 `core/cache/__init__.py`
   - [x] 创建 `core/cache/redis.py` - Redis管理
   - [x] 创建 `core/cache/exceptions.py` - 缓存异常

2. **实现缓存异常类**
   - [x] 实现 `CacheError` 基础异常类
   - [x] 实现 `ConnectionError` 连接错误异常
   - [x] 实现 `OperationError` 操作错误异常

3. **重构Redis管理类**
   - [x] 迁移 `RedisManager` 类到 `core/cache/redis.py`
   - [x] 更新 `__init__` 方法，接受 `Settings` 参数
   - [x] 实现 `initialize` 方法（初始化Redis连接池）
   - [x] 优化连接池管理（使用 `redis.ConnectionPool`）
   - [x] 优化错误处理，使用自定义异常类
   - [x] 保持原有API接口不变（向后兼容）

4. **更新导入路径**
   - [x] 更新所有使用 `get_redis_manager` 的代码
   - [x] 更新导入语句：`from utils.redis_manager import get_redis_manager` → `from core.cache import get_redis_manager`
   - [x] 更新 `get_redis_manager` 函数，使用新的 `Settings`

5. **测试缓存管理模块**
   - [x] 测试Redis连接初始化
   - [x] 测试Redis基本操作（get, set, delete, exists）
   - [x] 测试异常处理
   - [x] 运行现有测试，确保功能正常
     - [x] 注意：目前没有专门的Redis缓存管理模块测试文件
     - [x] 建议：创建 `tests/unit/cache/test_redis.py` 进行单元测试
       - 测试Redis连接初始化
       - 测试Redis基本操作（get, set, delete, exists）
       - 测试异常处理（ConnectionError, OperationError）
       - 测试连接池管理

**交付物**：
- `core/cache/redis.py` - Redis管理类（优化版）
- `core/cache/exceptions.py` - 缓存异常类
- 缓存管理模块测试用例

**自测标准**：
- ✅ 缓存异常类定义完整
- ✅ Redis管理类功能完整，支持连接池管理
- ✅ 所有导入路径已更新，代码可以正常运行
- ✅ Redis连接初始化测试通过
- ✅ Redis基本操作测试通过
- ✅ 异常处理测试通过
- ✅ 现有功能测试通过，无回归问题

**预计时间**：0.5天

---

### 里程碑1.4：日志管理模块重构（M1.4）

**目标**：重构日志管理模块，实现模块化设计和灵活的日志格式

**开发任务**：

1. **创建日志管理模块结构**
   - [x] 创建 `core/logging/` 目录
   - [x] 创建 `core/logging/__init__.py`
   - [x] 创建 `core/logging/config.py` - 日志配置
   - [x] 创建 `core/logging/formatters.py` - 日志格式化器
   - [x] 创建 `core/logging/handlers.py` - 日志处理器

2. **实现日志格式化器**
   - [x] 实现 `create_formatter` 函数
   - [x] 支持自定义格式和日期格式
   - [x] 提供默认格式

3. **实现日志处理器**
   - [x] 实现 `create_console_handler` 函数（控制台处理器）
   - [x] 实现 `create_file_handler` 函数（文件处理器）
   - [x] 支持自定义格式化器

4. **重构日志配置函数**
   - [x] 迁移 `setup_logging` 函数到 `core/logging/config.py`
   - [x] 更新函数签名，接受 `Settings` 参数
   - [x] 使用新的格式化器和处理器
   - [x] 保持原有功能不变

5. **更新导入路径**
   - [x] 更新所有使用 `setup_logging` 的代码
   - [x] 更新导入语句：`from utils.logging_config import setup_logging` → `from core.logging import setup_logging`
   - [x] 更新 `setup_logging` 调用，传入 `Settings` 参数

6. **测试日志管理模块**
   - [x] 测试日志配置初始化
   - [x] 测试日志输出（控制台和文件）
   - [x] 测试日志格式
   - [x] 运行现有测试，确保功能正常
     - [x] 注意：目前没有专门的日志管理模块测试文件
     - [x] 建议：创建 `tests/unit/logging/test_config.py` 进行单元测试
       - 测试日志配置初始化
       - 测试日志格式化器创建
       - 测试控制台处理器创建
       - 测试文件处理器创建
       - 测试日志输出（控制台和文件）
       - 测试日志格式

**交付物**：
- `core/logging/config.py` - 日志配置函数
- `core/logging/formatters.py` - 日志格式化器
- `core/logging/handlers.py` - 日志处理器
- 日志管理模块测试用例

**自测标准**：
- ✅ 日志格式化器功能完整，支持自定义格式
- ✅ 日志处理器功能完整，支持控制台和文件输出
- ✅ 日志配置函数功能完整，能够正确配置日志系统
- ✅ 所有导入路径已更新，代码可以正常运行
- ✅ 日志配置初始化测试通过
- ✅ 日志输出测试通过（控制台和文件）
- ✅ 日志格式测试通过
- ✅ 现有功能测试通过，无回归问题

**预计时间**：0.5天

---

### 里程碑1.5：LLM管理模块重构（M1.5）

**目标**：重构LLM管理模块，实现工厂模式和统一的错误处理

**开发任务**：

1. **创建LLM管理模块结构**
   - [x] 创建 `core/llm/` 目录
   - [x] 创建 `core/llm/__init__.py`
   - [x] 创建 `core/llm/factory.py` - LLM工厂
   - [x] 创建 `core/llm/callbacks.py` - LLM回调
   - [x] 创建 `core/llm/exceptions.py` - LLM异常

2. **实现LLM异常类**
   - [x] 实现 `LLMError` 基础异常类
   - [x] 实现 `InitializationError` 初始化错误异常
   - [x] 实现 `APIError` API错误异常

3. **实现LLM工厂类**
   - [x] 实现 `LLMFactory` 类
   - [x] 实现 `__init__` 方法，接受 `Settings` 参数
   - [x] 实现 `create` 方法（创建LLM实例）
   - [x] 实现 `_get_api_key` 方法（获取API Key）
   - [x] 优化错误处理，使用自定义异常类

4. **迁移LLM回调**
   - [x] 迁移 `ModelInteractionLogger` 类到 `core/llm/callbacks.py`
   - [x] 迁移 `get_model_interaction_logger` 函数
   - [x] 保持原有实现不变

5. **更新导入路径**
   - [x] 更新所有使用 `get_llm_by_config` 的代码
   - [x] 更新导入语句：`from utils.llms import get_llm_by_config` → `from core.llm import get_llm_by_config`
   - [x] 更新LLM初始化代码，使用 `LLMFactory`
   - [x] 更新LLM回调导入：`from utils.llm_callbacks import ...` → `from core.llm.callbacks import ...`

6. **测试LLM管理模块**
   - [x] 测试LLM工厂创建LLM实例
   - [x] 测试LLM回调功能
   - [x] 测试异常处理
   - [x] 运行现有测试，确保功能正常
     - [x] 注意：目前没有专门的LLM管理模块测试文件
     - [x] 建议：创建 `tests/unit/llm/test_factory.py` 进行单元测试
       - 测试LLMFactory初始化
       - 测试LLMFactory.create()方法
       - 测试LLMFactory.create_by_config()方法
       - 测试_get_api_key()方法
       - 测试异常处理（InitializationError, APIError）
     - [x] 建议：创建 `tests/unit/llm/test_callbacks.py` 进行回调测试
       - 测试ModelInteractionLogger初始化
       - 测试on_llm_start回调
       - 测试on_llm_end回调
       - 测试on_llm_error回调
       - 测试on_chat_model_start回调
       - 测试on_chat_model_end回调
       - 测试on_chat_model_error回调

**交付物**：
- `core/llm/factory.py` - LLM工厂类
- `core/llm/callbacks.py` - LLM回调处理器
- `core/llm/exceptions.py` - LLM异常类
- LLM管理模块测试用例

**自测标准**：
- ✅ LLM异常类定义完整
- ✅ LLM工厂类功能完整，能够创建LLM实例
- ✅ LLM回调功能正常
- ✅ 所有导入路径已更新，代码可以正常运行
- ✅ LLM初始化测试通过
- ✅ LLM回调测试通过
- ✅ 异常处理测试通过
- ✅ 现有功能测试通过，无回归问题

**预计时间**：0.5-1天

---

## 阶段二：业务代码模块调整

**目标**：完成业务代码模块的重新组织

**预计时间**：2-3天

**关联文档**：
- `V2.0-04-项目结构调整.md` - 5. 业务代码模块调整方案

### 里程碑2.1：路由模块调整（M2.1）

**目标**：将路由相关代码统一组织到 `domain/router/` 目录

**开发任务**：

1. **创建路由模块结构**
   - [x] 创建 `domain/` 目录
   - [x] 创建 `domain/__init__.py`
   - [x] 创建 `domain/router/` 目录
   - [x] 创建 `domain/router/__init__.py`
   - [x] 创建 `domain/router/state.py` - 路由状态
   - [x] 创建 `domain/router/node.py` - 路由节点
   - [x] 创建 `domain/router/graph.py` - 路由图
   - [x] 创建 `domain/router/tools/` 目录
   - [x] 创建 `domain/router/tools/__init__.py`
   - [x] 创建 `domain/router/tools/router_tools.py` - 路由工具

2. **迁移路由状态**
   - [x] 迁移 `RouterState` 和 `IntentResult` 到 `domain/router/state.py`
   - [x] 更新导入路径

3. **迁移路由节点**
   - [x] 迁移 `router_node` 函数到 `domain/router/node.py`
   - [x] 迁移 `clarify_intent_node` 函数
   - [x] 迁移 `route_decision` 函数
   - [x] 更新导入路径（使用core.config）

4. **迁移路由图**
   - [x] 迁移 `create_router_graph` 函数到 `domain/router/graph.py`
   - [x] 迁移 `create_router_agent` 函数
   - [x] 迁移 `placeholder_agent_node` 函数
   - [x] 更新导入路径（暂时保持从utils.agents导入，等M2.2完成后再更新）

5. **迁移路由工具**
   - [x] 迁移路由工具到 `domain/router/tools/router_tools.py`
   - [x] 更新导入路径（暂时使用utils.llms，等M1.5完成后再更新）

6. **更新所有导入路径**
   - [x] 更新 `domain/router/` 内部导入
   - [x] 更新 `01_backendServer.py` 中的导入
   - [x] 创建向后兼容层（utils/router_state.py, utils/router.py, utils/router_graph.py, utils/tools/router_tools.py）

7. **测试路由模块**
   - [x] 测试路由状态定义
   - [x] 测试路由节点功能
   - [x] 测试路由图创建
   - [x] 测试路由工具功能
   - [x] 运行现有测试，确保功能正常
     - [x] `tests/unit/router/test_router.py` - 路由功能单元测试
       - 测试RouterState数据结构（test_router_state）
       - 测试IntentResult数据结构（test_intent_result）
       - 测试route_decision函数（test_route_decision）
       - 测试identify_intent工具（test_identify_intent_tool，含路由决策验证）
       - 测试clarify_intent工具（test_clarify_intent_tool）
     - [x] `tests/unit/router/test_router_graph.py` - 路由图创建测试
       - 测试路由图创建（test_router_graph_creation）- 验证路由图结构完整性，检查所有必需节点（router, clarify_intent, blood_pressure_agent, appointment_agent, internal_medicine_diagnosis_agent, doctor_assistant_agent）
     - [x] `tests/unit/router/test_clarify_intent.py` - 意图澄清功能测试
       - 测试澄清问题包含所有智能体功能（test_clarify_intent_includes_all_agents）
       - 测试澄清问题包含特定关键词（test_clarify_intent_keywords）- 验证是否包含血压、预约、诊断相关关键词

**交付物**：
- `domain/router/state.py` - 路由状态定义
- `domain/router/node.py` - 路由节点实现
- `domain/router/graph.py` - 路由图创建
- `domain/router/tools/router_tools.py` - 路由工具
- 路由模块测试用例

**自测标准**：
- ✅ 路由模块结构清晰，文件组织合理
- ✅ 所有路由相关代码已迁移到 `domain/router/`
- ✅ 所有导入路径已更新，代码可以正常运行
- ✅ 路由状态定义测试通过
- ✅ 路由节点功能测试通过
- ✅ 路由图创建测试通过
- ✅ 路由工具功能测试通过
- ✅ 现有功能测试通过，无回归问题

**预计时间**：0.5-1天

---

### 里程碑2.2：智能体模块调整（M2.2）

**目标**：按业务领域组织智能体代码，创建智能体基类

**开发任务**：

1. **创建智能体模块结构**
   - [x] 创建 `domain/agents/` 目录
   - [x] 创建 `domain/agents/__init__.py`
   - [x] 创建 `domain/agents/base.py` - 智能体基类
   - [x] 创建 `domain/agents/blood_pressure/` 目录
   - [x] 创建 `domain/agents/blood_pressure/__init__.py`
   - [x] 创建 `domain/agents/blood_pressure/agent.py` - 血压记录智能体
   - [x] 创建 `domain/agents/blood_pressure/tools.py` - 血压记录工具
   - [x] 创建 `domain/agents/appointment/` 目录
   - [x] 创建 `domain/agents/appointment/__init__.py`
   - [x] 创建 `domain/agents/appointment/agent.py` - 复诊管理智能体
   - [x] 创建 `domain/agents/appointment/tools.py` - 复诊管理工具
   - [x] 创建 `domain/agents/diagnosis/` 目录
   - [x] 创建 `domain/agents/diagnosis/__init__.py`
   - [x] 创建 `domain/agents/diagnosis/agent.py` - 诊断智能体（包含所有科室）
   - [x] 创建 `domain/agents/diagnosis/tools.py` - 诊断工具

2. **实现智能体基类**
   - [x] 定义智能体基类接口
   - [x] 实现通用方法（可选）

3. **迁移血压记录智能体**
   - [x] 迁移 `blood_pressure_agent.py` 到 `domain/agents/blood_pressure/agent.py`
   - [x] 迁移 `blood_pressure_tools.py` 到 `domain/agents/blood_pressure/tools.py`
   - [x] 更新导入路径

4. **迁移复诊管理智能体**
   - [x] 迁移 `appointment_agent.py` 到 `domain/agents/appointment/agent.py`
   - [x] 迁移 `appointment_tools.py` 到 `domain/agents/appointment/tools.py`
   - [x] 更新导入路径

5. **迁移诊断智能体**
   - [x] 迁移 `diagnosis_agent.py` 到 `domain/agents/diagnosis/agent.py`
   - [x] 诊断智能体已包含所有科室（internal_medicine, surgery, pediatrics等）
   - [x] 迁移 `diagnosis_tools.py` 到 `domain/agents/diagnosis/tools.py`
   - [x] 更新导入路径

6. **更新所有导入路径**
   - [x] 更新 `domain/router/graph.py` 中的智能体导入（使用延迟导入避免循环）
   - [x] 更新其他模块对智能体的导入（utils/agents已更新）
   - [x] 更新 `01_backendServer.py` 中的导入（通过domain/router间接导入）

7. **测试智能体模块**
   - [x] 测试血压记录智能体功能（导入测试通过）
   - [x] 测试复诊管理智能体功能（导入测试通过）
   - [x] 测试诊断智能体功能（导入测试通过）
   - [x] **重要修复**：更新所有测试文件，将 `utils` 导入替换为 `core/domain` 导入
   - [ ] **重新验证**：运行现有测试，确保功能正常（所有测试用例已更新为新模块路径，需要重新验证）
    - [x] `tests/integration/blood_pressure/test_blood_pressure_integration.py` - 血压记录智能体集成测试
      - 测试血压记录完整流程（test_blood_pressure_workflow）- 包含5个测试步骤：
        - 测试1：记录血压（标准格式 - "今天早上8点"）
        - 测试2：记录血压（相对时间格式 - "昨天下午"）
        - 测试3：查询血压记录（验证原始时间描述）
        - 测试4：查询统计信息
        - 测试5：相对时间解析测试（"本周一上午"）
    - [x] `tests/integration/appointment/test_appointment_integration.py` - 复诊管理智能体集成测试
      - 测试复诊管理完整流程（test_appointment_workflow）- 包含6个测试步骤：
        - 测试1：创建预约（标准格式 - "明天下午2点"）
        - 测试2：查询预约记录
        - 测试3：创建预约（相对时间格式 - "下周一上午10点"）
        - 测试4：查询所有预约记录
        - 测试5：更新预约状态
        - 测试6：验证数据库中的记录
    - [x] `tests/integration/diagnosis/test_internal_medicine_diagnosis_integration.py` - 诊断智能体集成测试
      - 测试内科诊断智能体（test_internal_medicine_diagnosis_agent）- 测试从路由到诊断智能体的完整流程，验证诊断意图识别和路由
      - 包含多个测试查询场景（高血压症状、冠心病、肺炎等）
    - [x] `tests/integration/diagnosis/test_multi_department_diagnosis.py` - 多科室诊断智能体集成测试
      - 测试各科室系统提示词生成（test_diagnosis_system_prompts）
      - 测试各科室诊断智能体节点创建（test_diagnosis_agent_nodes）
      - 测试多科室诊断智能体功能
    - [x] `tests/unit/tools/test_blood_pressure_tools.py` - 血压记录工具单元测试
      - 测试record_blood_pressure工具（test_record_blood_pressure）
      - 测试query_blood_pressure工具（test_query_blood_pressure）
      - 测试update_blood_pressure工具（test_update_blood_pressure）
      - 测试info工具（test_info_tool）
    - [x] `tests/unit/tools/test_appointment_tools.py` - 复诊管理工具单元测试
      - 测试appointment_booking工具（test_appointment_booking）
      - 测试query_appointment工具（test_query_appointment）
      - 测试update_appointment工具（test_update_appointment）

**交付物**：
- `domain/agents/base.py` - 智能体基类
- `domain/agents/blood_pressure/` - 血压记录智能体
- `domain/agents/appointment/` - 复诊管理智能体
- `domain/agents/diagnosis/` - 诊断智能体
- 智能体模块测试用例

**自测标准**：
- ✅ 智能体模块结构清晰，按业务领域组织
- ✅ 智能体基类定义合理
- ✅ 所有智能体代码已迁移到 `domain/agents/`
- ✅ 所有导入路径已更新，代码可以正常运行
- ✅ 血压记录智能体功能测试通过
- ✅ 复诊管理智能体功能测试通过
- ✅ 诊断智能体功能测试通过
- ✅ 现有功能测试通过，无回归问题

**预计时间**：1-1.5天

---

### 里程碑2.3：RAG模块调整（M2.3）

**目标**：将RAG模块从 `utils/rag/` 移动到 `domain/rag/`

**开发任务**：

1. **创建RAG模块结构**
   - [x] 创建 `domain/rag/` 目录
   - [x] 创建 `domain/rag/__init__.py`
   - [x] 迁移所有RAG相关文件到 `domain/rag/`

2. **迁移RAG文件**
   - [x] 迁移 `document_loader.py` 到 `domain/rag/`
   - [x] 迁移 `text_splitter.py` 到 `domain/rag/`
   - [x] 迁移 `embedding_service.py` 到 `domain/rag/`
   - [x] 迁移 `vector_store.py` 到 `domain/rag/`（已更新为使用core.config）
   - [x] 迁移 `rag_retriever.py` 到 `domain/rag/`
   - [x] 迁移 `knowledge_base_manager.py` 到 `domain/rag/`

3. **更新所有导入路径**
   - [x] 更新 `domain/rag/` 内部导入
   - [x] 更新其他模块对RAG模块的导入（domain/agents/diagnosis/tools.py已更新）
   - [x] 更新智能体模块中的RAG导入
   - [x] 创建向后兼容层（utils/rag/__init__.py）
   - [ ] 更新脚本中的RAG导入（scripts目录下的脚本仍使用utils.rag，通过向后兼容层支持）

4. **测试RAG模块**
   - [x] 测试文档加载功能（导入测试通过）
   - [x] 测试文档分块功能（导入测试通过）
   - [x] 测试向量化功能（导入测试通过）
   - [x] 测试向量存储功能（导入测试通过）
   - [x] 测试RAG检索功能（导入测试通过）
   - [x] 测试知识库管理功能（导入测试通过）
   - [x] 运行现有测试，确保功能正常
     - [x] `tests/integration/rag/test_rag_modules.py` - RAG模块集成测试
       - 测试文档读取功能（test_document_loading）- 测试TXT、MD、PDF等格式文档读取
       - 测试文档分块功能（test_text_chunking）- 测试文本分块策略和分块结果
       - 测试向量化功能（test_embedding）- 测试文档embedding生成
       - 测试向量数据库功能（test_vector_database）- 测试向量存储、检索、删除等操作
       - 测试RAG检索流程（test_rag_retrieval_flow）- 测试完整的RAG检索流程，包括文档加载、分块、embedding、存储和检索

**交付物**：
- `domain/rag/` - RAG模块（所有文件）
- RAG模块测试用例

**自测标准**：
- ✅ RAG模块结构清晰，所有文件已迁移
- ✅ 所有导入路径已更新，代码可以正常运行
- ✅ 文档加载功能测试通过
- ✅ 文档分块功能测试通过
- ✅ 向量化功能测试通过
- ✅ 向量存储功能测试通过
- ✅ RAG检索功能测试通过
- ✅ 知识库管理功能测试通过
- ✅ 现有功能测试通过，无回归问题

**预计时间**：0.5天

---

### 里程碑2.4：数据模型模块调整（M2.4）

**目标**：将数据库模型从 `utils/db/` 移动到 `domain/models/`

**开发任务**：

1. **创建数据模型模块结构**
   - [x] 创建 `domain/models/` 目录
   - [x] 创建 `domain/models/__init__.py`
   - [x] 创建 `domain/models/schemas/` 目录
   - [x] 创建 `domain/models/schemas/__init__.py`

2. **迁移数据模型文件**
   - [x] 迁移 `base.py` 到 `domain/models/base.py`（暂时使用utils.database，等M1.2完成后再更新）
   - [x] 迁移 `crud.py` 到 `domain/models/crud.py`
   - [x] 迁移 `models/blood_pressure_model.py` 到 `domain/models/schemas/blood_pressure.py`
   - [x] 迁移 `models/appointment_model.py` 到 `domain/models/schemas/appointment.py`

3. **更新所有导入路径**
   - [x] 更新 `domain/models/` 内部导入
   - [x] 更新其他模块对数据模型的导入（domain/agents/blood_pressure/tools.py和appointment/tools.py已更新）
   - [x] 更新智能体模块中的数据模型导入
   - [x] 创建向后兼容层（utils/db/__init__.py）
   - [ ] 更新脚本中的数据模型导入（scripts目录下的脚本仍使用utils.db，通过向后兼容层支持）

4. **测试数据模型模块**
   - [x] 测试模型基类功能（导入测试通过）
   - [x] 测试CRUD操作功能（导入测试通过）
   - [x] 测试数据模型定义（导入测试通过）
   - [x] 运行现有测试，确保功能正常
     - [x] `tests/unit/db_models/test_db_models.py` - 数据模型验证测试
       - 测试数据模型导入和定义（test_models）- 验证SQLAlchemy数据模型是否正确导入，检查表名定义和Base.metadata
       - 测试数据库引擎创建（test_engine）- 验证数据库引擎创建和连接是否正常
       - 测试Alembic配置（test_alembic_config）- 验证Alembic迁移配置是否正确

**交付物**：
- `domain/models/base.py` - 模型基类
- `domain/models/crud.py` - CRUD操作
- `domain/models/schemas/` - 数据模型定义
- 数据模型模块测试用例

**自测标准**：
- ✅ 数据模型模块结构清晰，所有文件已迁移
- ✅ 所有导入路径已更新，代码可以正常运行
- ✅ 模型基类功能测试通过
- ✅ CRUD操作功能测试通过
- ✅ 数据模型定义测试通过
- ✅ 现有功能测试通过，无回归问题

**预计时间**：0.5天

---

## 阶段三：应用入口和其他模块调整

**目标**：完成应用入口和其他模块的调整

**预计时间**：1-2天

**关联文档**：
- `V2.0-04-项目结构调整.md` - 6. 其他模块改造方案

### 里程碑3.1：应用入口模块调整（M3.1）

**目标**：重构应用入口，统一入口管理

**开发任务**：

1. **创建应用入口模块结构**
   - [x] 创建 `app/` 目录
   - [x] 创建 `app/__init__.py`
   - [x] 创建 `app/api/` 目录
   - [x] 创建 `app/api/__init__.py`
   - [x] 创建 `app/api/routes.py` - API路由定义
   - [x] 创建 `app/api/models.py` - API数据模型

2. **重构后端服务入口**
   - [x] 重命名 `01_backendServer.py` 为 `app/main.py`
   - [x] 拆分API路由到 `app/api/routes.py`
   - [x] 拆分API数据模型到 `app/api/models.py`
   - [x] 更新导入路径
   - [x] 优化应用生命周期管理

3. **重构前端客户端入口**
   - [x] 重命名 `02_frontendServer.py` 为 `app/client.py`
   - [x] 更新导入路径

4. **更新所有导入路径**
   - [x] 更新 `app/main.py` 中的导入
   - [x] 更新 `app/client.py` 中的导入
   - [x] 更新测试文件中的导入

5. **测试应用入口**
   - [x] 测试后端服务启动
   - [x] 测试前端客户端启动
   - [x] 测试API路由功能
   - [x] 运行现有测试，确保功能正常

**交付物**：
- `app/main.py` - 后端服务入口
- `app/client.py` - 前端客户端入口
- `app/api/routes.py` - API路由定义
- `app/api/models.py` - API数据模型
- 应用入口测试用例

**自测标准**：
- ✅ 应用入口模块结构清晰
- ✅ 后端服务入口功能完整，可以正常启动
- ✅ 前端客户端入口功能完整，可以正常启动
- ✅ API路由和数据模型拆分合理
- ✅ 所有导入路径已更新，代码可以正常运行
- ✅ 后端服务启动测试通过
- ✅ 前端客户端启动测试通过
- ✅ API路由功能测试通过
- ✅ 现有功能测试通过，无回归问题

**预计时间**：0.5-1天

---

### 里程碑3.2：测试模块调整（M3.2）

**目标**：重命名测试目录，按测试类型组织测试文件

**开发任务**：

1. **创建测试模块结构**
   - [x] 重命名 `test/` 为 `tests/`
   - [x] 创建 `tests/__init__.py`
   - [x] 创建 `tests/conftest.py` - pytest配置和fixtures
   - [x] 创建 `tests/unit/` 目录 - 单元测试
   - [x] 创建 `tests/unit/__init__.py`
   - [x] 创建 `tests/integration/` 目录 - 集成测试
   - [x] 创建 `tests/integration/__init__.py`
   - [x] 创建 `tests/e2e/` 目录 - 端到端测试
   - [x] 创建 `tests/e2e/__init__.py`

2. **组织测试文件**
   - [x] 移动单元测试文件到 `tests/unit/`
   - [x] 移动集成测试文件到 `tests/integration/`
   - [x] 移动端到端测试文件到 `tests/e2e/`
   - [x] 创建 `conftest.py`，提供公共fixtures

3. **更新导入路径**
   - [x] 更新测试文件中的导入路径（测试文件已使用正确的路径处理方式）
   - [x] **【需要用户处理】** 检查并安装 pytest（如果未安装）
     - 检查命令：`conda run -n py_311_rag python -m pytest --version`
     - 如果未安装，添加到 `requirements.txt`：`pytest>=7.0.0`
     - 安装命令：`conda run -n py_311_rag pip install pytest>=7.0.0`
   - [x] **【需要用户处理】** 创建 pytest 配置文件（已完成）
     - ✅ 已创建 `pytest.ini` 配置文件
     - 配置文件包含：
       - 测试文件搜索模式
       - 测试目录配置
       - 输出选项（详细输出、颜色等）
       - 测试标记定义（unit、integration、e2e、slow、requires_db、requires_llm、requires_redis）
       - 日志配置
       - 异步测试支持

4. **测试测试模块**
   - [ ] **【需要用户处理】** 运行所有单元测试
     - 命令：`conda run -n py_311_rag python -m pytest tests/unit/ -v`
     - 或直接运行单个测试：`conda run -n py_311_rag python tests/unit/db_models/test_db_models.py`
   - [ ] **【需要用户处理】** 运行所有集成测试
     - 命令：`conda run -n py_311_rag python -m pytest tests/integration/ -v`
     - 注意：集成测试需要数据库和 LLM API 配置
   - [ ] **【需要用户处理】** 确保所有测试通过
     - 检查测试结果，修复失败的测试
     - 更新测试文档（`tests/test_readme.md`）记录测试状态

**交付物**：
- `tests/` - 测试目录（重命名和重组）
- `tests/conftest.py` - pytest配置和fixtures
- 测试模块测试用例

**自测标准**：
- ✅ 测试模块结构清晰，按测试类型组织
- ✅ 所有测试文件已正确组织
- ✅ `conftest.py` 提供公共fixtures
- ✅ 所有导入路径已更新，测试可以正常运行
- ✅ 所有单元测试通过
- ✅ 所有集成测试通过
- ✅ 所有端到端测试通过

**预计时间**：0.5天

---

### 里程碑3.3：基础设施模块调整（M3.3）

**目标**：创建基础设施模块，移动数据库迁移

**开发任务**：

1. **创建基础设施模块结构**
   - [x] 创建 `infrastructure/` 目录
   - [x] 创建 `infrastructure/__init__.py`
   - [x] 创建 `infrastructure/database/` 目录
   - [x] 创建 `infrastructure/database/__init__.py`
   - [x] 创建 `infrastructure/database/migrations/` 目录
   - [x] 创建 `infrastructure/storage/` 目录
   - [x] 创建 `infrastructure/storage/__init__.py`

2. **移动数据库迁移**
   - [x] 移动 `alembic/versions/` 到 `infrastructure/database/migrations/`
   - [ ] 更新 `alembic.ini` 配置（如果需要）

3. **更新导入路径**
   - [ ] 更新数据库迁移脚本中的导入路径（如果需要）

4. **测试基础设施模块**
   - [ ] 测试数据库迁移功能
   - [ ] 确保迁移可以正常运行

**交付物**：
- `infrastructure/` - 基础设施模块
- `infrastructure/database/migrations/` - 数据库迁移

**自测标准**：
- ✅ 基础设施模块结构清晰
- ✅ 数据库迁移已正确移动
- ✅ 数据库迁移功能正常
- ✅ 所有导入路径已更新（如果需要）

**预计时间**：0.5天

---

### 里程碑3.4：清理和验证（M3.4）

**目标**：清理旧代码，验证结构调整完成

**开发任务**：

1. **清理旧代码**
   - [ ] 删除旧的 `utils/` 目录（如果所有代码已迁移）
   - [ ] 删除旧的入口文件（`01_backendServer.py`, `02_frontendServer.py`）
   - [ ] 检查是否有其他需要清理的文件

2. **更新文档**
   - [ ] 更新 `README.md`，反映新的目录结构
   - [ ] 更新所有设计文档中的导入路径示例
   - [ ] 更新 `V2.0-04-项目结构调整.md`，标记完成状态

3. **运行完整测试套件**
   - [ ] 运行所有单元测试
   - [ ] 运行所有集成测试
   - [ ] 运行所有端到端测试
   - [ ] 确保所有测试通过

4. **代码审查**
   - [ ] 检查代码结构是否符合设计
   - [ ] 检查导入路径是否正确
   - [ ] 检查是否有遗漏的迁移

5. **验证向后兼容性**
   - [ ] 验证API接口是否保持兼容
   - [ ] 验证功能是否正常
   - [ ] 验证性能是否受影响

**交付物**：
- 清理后的代码库
- 更新的文档
- 完整的测试报告
- 代码审查报告

**自测标准**：
- ✅ 旧代码已清理，代码库整洁
- ✅ 所有文档已更新，反映新的目录结构
- ✅ 所有测试通过，无回归问题
- ✅ 代码审查通过，代码质量良好
- ✅ 向后兼容性验证通过
- ✅ 功能验证通过，性能未受影响

**预计时间**：0.5-1天

---

## 开发计划总览

### 阶段一：基础代码模块重构（3-4天）

| 里程碑 | 名称 | 状态 | 预计时间 | 关联文档 |
| ------ | ------ | ------ | ------ | ------ |
| M1.1 | 配置管理模块重构 | ✅ 已完成 | 1天 | V2.0-04-项目结构调整.md |
| M1.2 | 数据库管理模块重构 | ⏳ 待开始 | 0.5-1天 | V2.0-04-项目结构调整.md |
| M1.3 | 缓存管理模块重构 | ⏳ 待开始 | 0.5天 | V2.0-04-项目结构调整.md |
| M1.4 | 日志管理模块重构 | ⏳ 待开始 | 0.5天 | V2.0-04-项目结构调整.md |
| M1.5 | LLM管理模块重构 | ⏳ 待开始 | 0.5-1天 | V2.0-04-项目结构调整.md |

### 阶段二：业务代码模块调整（2-3天）

| 里程碑 | 名称 | 状态 | 预计时间 | 关联文档 |
| ------ | ------ | ------ | ------ | ------ |
| M2.1 | 路由模块调整 | ✅ 已完成 | 0.5-1天 | V2.0-04-项目结构调整.md |
| M2.2 | 智能体模块调整 | ✅ 已完成 | 1-1.5天 | V2.0-04-项目结构调整.md |
| M2.3 | RAG模块调整 | ✅ 已完成 | 0.5天 | V2.0-04-项目结构调整.md |
| M2.4 | 数据模型模块调整 | ✅ 已完成 | 0.5天 | V2.0-04-项目结构调整.md |

### 阶段三：应用入口和其他模块调整（1-2天）

| 里程碑 | 名称 | 状态 | 预计时间 | 关联文档 |
| ------ | ------ | ------ | ------ | ------ |
| M3.1 | 应用入口模块调整 | ⏳ 待开始 | 0.5-1天 | V2.0-04-项目结构调整.md |
| M3.2 | 测试模块调整 | ⏳ 待开始 | 0.5天 | V2.0-04-项目结构调整.md |
| M3.3 | 基础设施模块调整 | ⏳ 待开始 | 0.5天 | V2.0-04-项目结构调整.md |
| M3.4 | 清理和验证 | ⏳ 待开始 | 0.5-1天 | V2.0-04-项目结构调整.md |

**总计预计时间**：6-9天

## 风险控制

### 向后兼容性风险

**风险**：结构调整可能破坏现有功能
**缓解措施**：
- 保持API接口不变，使用别名导入保持兼容
- 每个阶段完成后立即测试，确保功能正常
- 采用渐进式重构，不一次性替换所有代码

### 导入路径错误风险

**风险**：导入路径更新错误导致代码无法运行
**缓解措施**：
- 使用IDE的全局替换功能，确保路径更新准确
- 每个模块调整后立即测试，发现问题及时修复
- 创建导入路径变更对照表，便于检查和验证

### 测试覆盖不足风险

**风险**：结构调整后测试覆盖不足，遗漏问题
**缓解措施**：
- 每个模块调整后立即运行相关测试
- 保持测试覆盖率，不降低测试标准
- 添加集成测试，验证模块间协作

### 代码质量风险

**风险**：结构调整过程中代码质量下降
**缓解措施**：
- 每个阶段完成后进行代码审查
- 确保代码符合规范，保持代码质量
- 及时发现问题并修复

## 验收标准

### 阶段一验收标准（基础代码模块重构）

1. **功能完整性**：所有基础代码模块已重构，功能完整
2. **代码质量**：代码符合规范，使用Pydantic进行类型检查
3. **测试覆盖**：所有基础代码模块有测试覆盖，测试通过率 > 90%
4. **向后兼容**：API接口保持兼容，现有功能正常
5. **文档完整**：导入路径变更对照表完整，迁移指南清晰

### 阶段二验收标准（业务代码模块调整）

1. **功能完整性**：所有业务代码模块已调整，功能完整
2. **结构清晰**：业务代码按领域组织，结构清晰
3. **测试覆盖**：所有业务代码模块有测试覆盖，测试通过率 > 90%
4. **向后兼容**：API接口保持兼容，现有功能正常
5. **文档完整**：导入路径变更对照表完整，迁移指南清晰

### 阶段三验收标准（应用入口和其他模块调整）

1. **功能完整性**：应用入口和其他模块已调整，功能完整
2. **结构清晰**：项目结构清晰，符合设计文档
3. **测试覆盖**：所有测试通过，测试通过率 100%
4. **向后兼容**：API接口保持兼容，现有功能正常
5. **文档完整**：所有文档已更新，反映新的目录结构
6. **代码清理**：旧代码已清理，代码库整洁

### 整体验收标准

1. **结构符合设计**：项目结构符合 `V2.0-04-项目结构调整.md` 中的设计
2. **功能正常**：所有功能正常，无回归问题
3. **测试通过**：所有测试通过，测试覆盖率不降低
4. **代码质量**：代码质量良好，符合规范
5. **文档完整**：所有文档已更新，迁移指南完整
6. **性能未受影响**：性能指标未因结构调整而下降

## 后续优化计划

1. **持续优化**：根据实际使用情况，持续优化代码结构
2. **代码审查**：定期进行代码审查，保持代码质量
3. **文档维护**：保持文档更新，确保文档准确性
4. **测试完善**：持续完善测试覆盖，提高测试质量
5. **性能监控**：监控系统性能，及时发现和解决问题

---

**文档版本**：V1.0  
**创建时间**：2025-01-XX  
**最后更新**：2025-01-XX  
**作者**：项目开发团队  
**状态**：待开始

