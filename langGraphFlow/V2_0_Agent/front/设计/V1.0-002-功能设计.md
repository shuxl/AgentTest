# V1.0-002 功能设计文档

## 一、功能概述

前端界面需要支持两大核心功能：
1. **聊天功能**：与智能体进行对话交互
2. **后台数据展示**：展示系统运行状态和统计数据

## 二、聊天功能设计

### 2.1 功能需求

#### 2.1.1 核心功能
- ✅ 发送消息给智能体
- ✅ 接收并显示智能体回复
- ✅ 显示对话历史记录
- ✅ 支持Markdown格式的消息渲染
- ✅ 显示当前意图和活跃智能体信息

#### 2.1.2 会话管理
- ✅ 创建新会话
- ✅ 切换会话
- ✅ 会话列表展示
- ✅ 会话历史持久化（通过session_id）

#### 2.1.3 用户体验
- ✅ 消息发送状态提示（发送中、成功、失败）
- ✅ 自动滚动到最新消息
- ✅ 输入框支持多行输入
- ✅ 快捷键支持（Enter发送，Shift+Enter换行）
- ✅ 消息时间戳显示
- ✅ 加载动画和进度提示

### 2.2 UI设计

#### 2.2.1 布局结构
```
┌─────────────────────────────────────────┐
│  Header (标题栏)                         │
├──────────┬──────────────────────────────┤
│          │                              │
│ 会话列表  │        聊天窗口               │
│          │                              │
│ - 会话1   │  ┌──────────────────────┐   │
│ - 会话2   │  │  消息列表区域         │   │
│ - 会话3   │  │                      │   │
│          │  │  [用户消息]            │   │
│  [+新建]  │  │  [智能体回复]         │   │
│          │  └──────────────────────┘   │
│          │  ┌──────────────────────┐   │
│          │  │  输入框               │   │
│          │  │  [输入消息...] [发送] │   │
│          │  └──────────────────────┘   │
└──────────┴──────────────────────────────┘
```

#### 2.2.2 消息展示样式
- **用户消息**：右侧对齐，蓝色背景
- **智能体消息**：左侧对齐，灰色背景
- **系统消息**：居中显示，黄色背景（如：意图切换提示）
- **Markdown渲染**：代码块、列表、链接等格式支持

#### 2.2.3 交互细节
- 消息气泡支持点击复制
- 长消息支持展开/收起
- 图片/文件支持预览（如果后端支持）
- 错误消息显示重试按钮

### 2.3 技术实现要点

#### 2.3.1 状态管理
```typescript
interface ChatState {
  sessions: Session[];           // 会话列表
  currentSessionId: string;      // 当前会话ID
  messages: Message[];            // 当前会话消息列表
  isLoading: boolean;             // 是否正在加载
  error: string | null;           // 错误信息
}

interface Message {
  id: string;
  content: string;
  role: 'user' | 'assistant' | 'system';
  timestamp: number;
  currentIntent?: string;        // 当前意图
  currentAgent?: string;          // 当前智能体
}
```

#### 2.3.2 API调用
- **发送消息**：`POST /api/chat`
- **请求参数**：
  ```typescript
  {
    message: string;
    session_id: string;
    user_id: string;
  }
  ```
- **响应数据**：
  ```typescript
  {
    response: string;
    current_intent: string;
    current_agent: string | null;
  }
  ```

#### 2.3.3 错误处理
- 网络错误：显示重试按钮
- 超时错误：提示用户稍后重试
- 服务器错误：显示错误信息，支持重新发送

## 三、后台数据展示功能设计

### 3.1 功能需求

#### 3.1.1 系统健康状态
- ✅ 服务健康检查状态
- ✅ 数据库连接池状态
- ✅ Redis连接状态（如果后端提供）
- ✅ 实时状态更新（定时轮询）

#### 3.1.2 连接池监控
- ✅ 连接池大小统计
- ✅ 可用连接数
- ✅ 等待连接数
- ✅ 连接池使用率图表

#### 3.1.3 统计数据展示
- ✅ 会话数量统计
- ✅ 消息数量统计
- ✅ 智能体调用统计（如果后端提供）
- ✅ 时间趋势图表

### 3.2 UI设计

#### 3.2.1 布局结构
```
┌─────────────────────────────────────────┐
│  Header (标题栏)                         │
├─────────────────────────────────────────┤
│                                          │
│  ┌──────────┐  ┌──────────┐            │
│  │ 服务状态  │  │ 数据库状态 │            │
│  │  [正常]   │  │  [正常]   │            │
│  └──────────┘  └──────────┘            │
│                                          │
│  ┌──────────────────────────────────┐   │
│  │  连接池使用情况图表                │   │
│  │  [折线图/柱状图]                  │   │
│  └──────────────────────────────────┘   │
│                                          │
│  ┌──────────────────────────────────┐   │
│  │  统计数据表格                     │   │
│  │  [表格展示]                      │   │
│  └──────────────────────────────────┘   │
│                                          │
└─────────────────────────────────────────┘
```

#### 3.2.2 组件设计
- **状态卡片**：显示服务/数据库状态，支持颜色标识（绿色=正常，黄色=警告，红色=异常）
- **图表组件**：使用ECharts展示连接池使用趋势
- **数据表格**：展示详细的连接池统计信息
- **刷新按钮**：手动刷新数据
- **自动刷新开关**：开启/关闭自动刷新（默认每5秒）

### 3.3 技术实现要点

#### 3.3.1 API调用
- **健康检查**：`GET /health`
- **数据库健康检查**：`GET /health/db`
- **响应数据示例**：
  ```typescript
  {
    status: "ok",
    langgraph_pool: "ok",
    sqlalchemy_engine: "ok",
    pool_stats: {
      langgraph_pool: {
        min_size: 5,
        max_size: 10,
        pool_size: 5,
        available: 5,
        waiting: 0
      },
      sqlalchemy_engine: {
        size: 5,
        checked_in: 5,
        checked_out: 0,
        overflow: 0,
        invalid: 0
      }
    }
  }
  ```

#### 3.3.2 数据更新策略
- **定时轮询**：每5秒自动刷新（可配置）
- **手动刷新**：用户点击刷新按钮
- **WebSocket**（可选）：如果后端支持，使用WebSocket实时推送

#### 3.3.3 图表数据
- **连接池使用率**：时间序列折线图
- **连接数统计**：柱状图对比（最小/最大/当前）
- **状态分布**：饼图展示各状态占比

## 四、页面路由设计

### 4.1 路由结构
```
/                    → 重定向到 /chat
/chat                → 聊天页面
/dashboard           → 数据展示页面
```

### 4.2 导航设计
- **顶部导航栏**：Logo + 导航菜单（聊天、数据展示）
- **侧边栏**（聊天页面）：会话列表
- **面包屑导航**（数据展示页面）：当前位置提示

## 五、响应式设计

### 5.1 断点设置
- **移动端**：< 768px
- **平板**：768px - 1024px
- **桌面**：> 1024px

### 5.2 适配策略
- **移动端**：会话列表收起为抽屉，聊天窗口全屏
- **平板**：会话列表和聊天窗口并排显示
- **桌面**：完整布局，支持多列展示

## 六、性能优化

### 6.1 聊天功能优化
- **虚拟滚动**：消息列表使用虚拟滚动，只渲染可见消息
- **消息分页**：历史消息按需加载
- **防抖处理**：输入框防抖，减少不必要的请求

### 6.2 数据展示优化
- **数据缓存**：缓存健康检查数据，减少请求频率
- **图表优化**：大数据量时使用数据采样
- **懒加载**：图表组件按需加载

## 七、错误处理

### 7.1 错误类型
- **网络错误**：显示网络错误提示，提供重试按钮
- **超时错误**：显示超时提示，建议检查网络
- **服务器错误**：显示错误信息，记录错误日志
- **数据格式错误**：显示数据解析错误，联系管理员

### 7.2 错误提示UI
- **Toast提示**：短暂显示的错误提示
- **错误页面**：严重错误时显示错误页面
- **错误边界**：React Error Boundary捕获组件错误

## 八、用户体验优化

### 8.1 加载状态
- **骨架屏**：数据加载时显示骨架屏
- **加载动画**：消息发送时显示加载动画
- **进度条**：长时间操作显示进度条

### 8.2 交互反馈
- **操作确认**：删除会话等操作需要确认
- **操作成功提示**：操作成功后显示成功提示
- **快捷键支持**：常用操作支持快捷键

### 8.3 无障碍支持
- **键盘导航**：支持Tab键导航
- **屏幕阅读器**：添加适当的ARIA标签
- **颜色对比度**：确保文字和背景对比度符合标准

## 九、后续扩展功能（可选）

### 9.1 聊天功能扩展
- 消息搜索功能
- 消息导出功能（PDF/文本）
- 语音输入（如果浏览器支持）
- 表情包支持
- 文件上传功能

### 9.2 数据展示扩展
- 更多统计指标
- 数据导出功能
- 自定义时间范围查询
- 告警规则配置
- 历史数据对比

## 十、开发优先级

### Phase 1：核心功能（MVP）
1. ✅ 聊天界面基础布局
2. ✅ 消息发送和接收
3. ✅ 会话管理
4. ✅ 健康检查展示

### Phase 2：功能完善
1. ⏳ Markdown渲染
2. ⏳ 连接池监控图表
3. ⏳ 错误处理完善
4. ⏳ 响应式适配

### Phase 3：体验优化
1. ⏳ 性能优化
2. ⏳ 加载状态优化
3. ⏳ 无障碍支持
4. ⏳ 扩展功能

