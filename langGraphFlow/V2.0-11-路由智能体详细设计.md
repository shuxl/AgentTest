# 1、功能描述

路由智能体是多智能体路由系统的核心组件，负责识别用户意图并将任务路由到对应的专门智能体。路由智能体每次调用都会经过，自动检测用户意图变化并实现重新路由，确保用户能够无缝切换不同的业务场景。

# 2、需求

## 2.1 功能需求

| JIRA编号 | 产品/子系统/服务 | 功能 | 功能描述 |
| ------ | ------ | ------ | ------ |
| ROUTER-001 | 路由智能体 | 意图识别 | 识别用户真实意图，返回意图类型和置信度 |
| ROUTER-002 | 路由智能体 | 意图澄清 | 当意图不明确时，生成澄清问题引导用户 |
| ROUTER-003 | 路由智能体 | 路由决策 | 根据意图识别结果，路由到对应的专门智能体 |
| ROUTER-004 | 路由智能体 | 重新路由 | 检测用户意图变化，自动重新路由到新智能体 |

## 2.2 非功能需求

| 非功能需求 | 需求描述 |
| ------ | ------ |
| 响应 | 路由决策时间 < 500ms，意图识别响应时间 < 1s |
| 容量 | 支持100个并发会话的路由决策 |
| 扩展性 | 易于添加新的意图类型和专门智能体 |
| 安全性 | 验证用户输入，防止恶意请求 |
| 可靠性 | 路由准确率 > 90%，异常情况下优雅降级 |

# 3、技术设计

## 3.1 设计思路

路由智能体基于LangGraph StateGraph实现，采用以下设计思路：

1. **每次调用都经过路由节点**：确保能够检测到用户意图变化
2. **状态管理**：使用RouterState统一管理所有状态信息
3. **条件路由**：根据意图识别结果，动态路由到对应的专门智能体
4. **智能检查**：优化性能，避免不必要的意图识别

## 3.2 设计图(流程图/时序图/其他)

### 3.2.1 路由节点执行流程

```
接收用户消息
    ↓
从checkpointer读取历史对话和状态
    ↓
调用identify_intent工具识别意图
    ↓
判断意图置信度
    ├─ 高置信度（>0.8）且意图变化 → 设置need_reroute=True → 路由到新智能体
    ├─ 高置信度（>0.8）且意图未变 → 继续当前智能体
    └─ 低置信度（<0.8） → 调用clarify_intent工具 → 生成澄清问题 → 等待用户回复
    ↓
更新RouterState状态
    ↓
路由决策函数route_decision
    ↓
返回路由目标节点名称
```

### 3.2.2 意图识别流程

```
用户消息 + 对话历史 + 当前意图
    ↓
调用LLM进行意图识别
    ↓
解析LLM返回结果
    ├─ intent_type: 意图类型
    ├─ confidence: 置信度
    ├─ entities: 提取的实体
    └─ need_clarification: 是否需要澄清
    ↓
返回IntentResult对象
```

### 3.2.3 重新路由检测流程

```
当前意图: "blood_pressure"
当前智能体: "blood_pressure_agent"
    ↓
用户新消息: "算了，我想预约复诊"
    ↓
识别新意图: "appointment"
    ↓
对比：current_intent != new_intent
    ↓
检查置信度: confidence > 0.7
    ↓
设置need_reroute=True
    ↓
路由决策：路由到"appointment_agent"
    ↓
更新状态：current_intent="appointment", current_agent="appointment_agent"
```

## 3.3 ER设计

路由智能体不涉及数据库表设计，状态信息存储在PostgreSQL的checkpointer中。

## 3.4 接口设计

### 3.4.1 接口清单

| 接口地址 | 接口名称 | 备注 |
| ------ | ------ | ------ |
| POST /api/chat | 对话接口 | 统一的对话入口，内部调用路由智能体 |

### 3.4.2 接口明细

#### 功能描述：对话接口

<table>
    <th colspan="4">功能描述：<span>用户对话入口，自动路由到对应的专门智能体</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>ROUTER-001</span></td>
    </tr>
    <tr>
        <td>请求方式</td><td colspan="3">POST</td>
    </tr>
    <tr>
        <td>请求URL</td><td colspan="3">/api/chat</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>message</td><td>String</td><td>Y</td><td>用户消息内容</td>
    </tr>
    <tr>
        <td>session_id</td><td>String</td><td>Y</td><td>会话ID</td>
    </tr>
    <tr>
        <td>user_id</td><td>String</td><td>Y</td><td>用户ID</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>response</td><td>String</td><td colspan="2">智能体回复内容</td>
    </tr>
    <tr>
        <td>current_intent</td><td>String</td><td colspan="2">当前意图（blood_pressure/appointment/doctor_assistant/unclear）</td>
    </tr>
    <tr>
        <td>current_agent</td><td>String</td><td colspan="2">当前活跃的智能体名称</td>
    </tr>
</table>

## 3.5 其他

### 3.5.1 工具设计

**identify_intent工具**：
- 功能：识别用户意图，返回意图类型和置信度
- 输入：用户查询、对话历史（可选）、当前意图（可选）
- 输出：IntentResult对象

**clarify_intent工具**：
- 功能：当意图不明确时，生成澄清问题
- 输入：用户查询、可能的意图列表
- 输出：澄清问题字符串

### 3.5.2 系统提示词

```
你是一个智能路由助手，负责识别用户的真实意图并将任务路由到对应的专门智能体。

你的核心任务是：
1. 识别用户的真实意图（血压记录、复诊管理、医生助手等）
2. 当意图不明确时，友好地引导用户说明
3. 根据意图将任务路由到对应的专门智能体
4. 自动检测用户意图变化并重新路由

支持的意图类型：
- blood_pressure: 用户想要记录、查询或管理血压数据
- appointment: 用户想要预约、查询或管理复诊
- doctor_assistant: 医生需要助手处理咨询、病历、处方等
- unclear: 意图不明确，需要进一步澄清

路由策略：
- 如果意图明确且置信度高（>0.8），直接路由到对应智能体
- 如果意图不明确（置信度<0.8），使用clarify_intent工具生成澄清问题
- 如果用户改变了意图，自动检测并重新路由到新智能体
- 如果用户同时提及多个意图，按优先级处理（优先级：doctor_assistant > appointment > blood_pressure）

记住：始终以用户为中心，提供自然流畅的对话体验。
```

### 3.5.3 性能优化

1. **智能意图检查**：
   - 如果当前有活跃的智能体，且用户消息很短，可能跳过意图识别
   - 检查意图变化关键词，只对可能改变意图的消息进行识别

2. **缓存机制**：
   - 缓存最近N条消息的意图识别结果
   - 设置合理的缓存TTL

3. **异步处理**：
   - 意图识别异步执行
   - 路由决策异步执行

