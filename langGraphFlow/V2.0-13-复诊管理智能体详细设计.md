# 1、功能描述

复诊管理智能体是专门处理复诊预约、查询和更新的智能体，通过调用Java微服务提供的HTTP API接口实现业务功能。复诊管理智能体作为路由系统中的专门智能体之一，通过路由智能体路由调用。

# 2、需求

## 2.1 功能需求

| JIRA编号 | 产品/子系统/服务 | 功能 | 功能描述 |
| ------ | ------ | ------ | ------ |
| APP-001 | 复诊管理智能体 | 复诊预约 | 引导用户完成复诊预约，包括科室选择、医生选择、时间选择等 |
| APP-002 | 复诊管理智能体 | 查询预约 | 查询用户的复诊预约记录，支持按状态、时间范围查询 |
| APP-003 | 复诊管理智能体 | 更新预约 | 更新已有的复诊预约信息 |

## 2.2 非功能需求

| 非功能需求 | 需求描述 |
| ------ | ------ |
| 响应 | 单次工具调用响应时间 < 3s（包含Java微服务调用时间） |
| 容量 | 支持单用户最多1000条预约记录 |
| 扩展性 | 易于扩展新的复诊相关功能 |
| 安全性 | 验证预约数据合法性，调用Java微服务时进行认证 |
| 可靠性 | Java微服务调用失败时优雅降级，返回友好错误提示 |

# 3、技术设计

## 3.1 设计思路

复诊管理智能体基于LangGraph实现，采用以下设计思路：

1. **引导式预约**：通过多轮对话引导用户完成复诊预约
2. **Java微服务集成**：通过HTTP API调用Java微服务，不直接操作数据库
3. **错误处理**：Java微服务调用失败时优雅降级
4. **数据验证**：在调用Java微服务前验证数据合法性

## 3.2 设计图(流程图/时序图/其他)

### 3.2.1 复诊预约流程

```
用户: "我想预约复诊"
    ↓
复诊管理智能体: "请告诉我您想预约哪个科室？"
    ↓
用户: "心内科"
    ↓
复诊管理智能体: "请选择医生（可选）"
    ↓
用户: "张医生"
    ↓
复诊管理智能体: "请选择预约时间"
    ↓
用户: "明天下午2点"
    ↓
调用appointment_booking工具
    ↓
HTTP POST请求到Java微服务
    ↓
Java微服务处理并返回结果
    ↓
返回: "预约成功，预约编号：..."
```

### 3.2.2 查询预约流程

```
用户: "查询我的预约记录"
    ↓
调用query_appointment工具
    ↓
HTTP GET请求到Java微服务
    ↓
Java微服务返回预约列表
    ↓
格式化返回结果
    ↓
返回: "您最近的预约记录如下：..."
```

## 3.3 ER设计

### 3.3.1 表清单

| 表名 | 描述 | 是否分表 | 备注 |
| ------ | ------ | ------ | ------ |
| - | - | - | 复诊管理数据存储在Java微服务中，本系统不涉及数据库表设计 |

### 3.3.2 ER关系

复诊管理智能体不直接操作数据库，数据存储在Java微服务中。

## 3.4 接口设计

### 3.4.1 接口清单

| 接口地址 | 接口名称 | 备注 |
| ------ | ------ | ------ |
| - | - | 复诊管理智能体通过路由智能体调用，不直接提供HTTP接口 |

### 3.4.2 工具接口

#### 功能描述：复诊预约工具

<table>
    <th colspan="4">功能描述：<span>创建复诊预约</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>APP-001</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">appointment_booking</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>department</td><td>str</td><td>Y</td><td>科室名称</td>
    </tr>
    <tr>
        <td>doctor_id</td><td>str</td><td>N</td><td>医生ID（可选）</td>
    </tr>
    <tr>
        <td>appointment_date</td><td>datetime</td><td>Y</td><td>预约日期时间</td>
    </tr>
    <tr>
        <td>user_id</td><td>str</td><td>Y</td><td>用户ID</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>result</td><td>str</td><td colspan="2">预约结果消息</td>
    </tr>
</table>

#### 功能描述：查询预约工具

<table>
    <th colspan="4">功能描述：<span>查询用户的复诊预约记录</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>APP-002</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">query_appointment</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>user_id</td><td>str</td><td>Y</td><td>用户ID</td>
    </tr>
    <tr>
        <td>status</td><td>str</td><td>N</td><td>预约状态（pending/completed/cancelled）</td>
    </tr>
    <tr>
        <td>start_date</td><td>datetime</td><td>N</td><td>开始日期</td>
    </tr>
    <tr>
        <td>end_date</td><td>datetime</td><td>N</td><td>结束日期</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>appointments</td><td>list</td><td colspan="2">预约记录列表</td>
    </tr>
</table>

#### 功能描述：更新预约工具

<table>
    <th colspan="4">功能描述：<span>更新已有的复诊预约信息</span></th>
    <tr>
        <td colspan="4"> JIRA链接: <span>APP-003</span></td>
    </tr>
    <tr>
        <td>工具名称</td><td colspan="3">update_appointment</td>
    </tr>
    <tr>
        <td colspan="4"> 入参</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td>是否必填</td><td>描述</td>
    </tr>
    <tr>
        <td>appointment_id</td><td>str</td><td>Y</td><td>预约ID</td>
    </tr>
    <tr>
        <td>appointment_date</td><td>datetime</td><td>N</td><td>预约日期时间</td>
    </tr>
    <tr>
        <td>doctor_id</td><td>str</td><td>N</td><td>医生ID</td>
    </tr>
    <tr>
        <td>department</td><td>str</td><td>N</td><td>科室名称</td>
    </tr>
    <tr>
        <td colspan="4"> 返回</td>
    </tr>
    <tr>
        <td>参数名</td><td>类型</td><td colspan="2">描述</td>
    </tr>
    <tr>
        <td>result</td><td>str</td><td colspan="2">更新结果消息</td>
    </tr>
</table>

## 3.5 其他

### 3.5.1 Java微服务集成

复诊管理智能体通过HTTP API调用Java微服务，具体实现方式：

```python
import httpx

@tool("appointment_booking", description="创建复诊预约")
async def appointment_booking(
    department: str,
    appointment_date: str,
    user_id: str,
    doctor_id: str = None
) -> str:
    """调用Java微服务创建复诊预约"""
    try:
        async with httpx.AsyncClient() as client:
            response = await client.post(
                "http://java-service:8080/api/appointment/create",
                json={
                    "department": department,
                    "appointmentDate": appointment_date,
                    "userId": user_id,
                    "doctorId": doctor_id
                },
                headers={
                    "Content-Type": "application/json",
                    "Authorization": f"Bearer {get_token()}"
                },
                timeout=10.0
            )
            response.raise_for_status()
            result = response.json()
            
            if result.get("success"):
                return f"预约成功！预约编号：{result.get('data', {}).get('appointmentId')}"
            else:
                return f"预约失败：{result.get('message', '未知错误')}"
                
    except httpx.HTTPError as e:
        logger.error(f"调用Java微服务失败: {e}")
        return "预约服务暂时不可用，请稍后重试。"
    except Exception as e:
        logger.error(f"创建预约时发生错误: {e}")
        return f"创建预约时发生错误：{str(e)}"
```

### 3.5.2 系统提示词

```
你是一个专业的复诊管理助手，帮助用户预约和管理复诊。

你的职责：
1. 引导用户完成复诊预约（科室、医生、时间）
2. 查询用户的复诊预约记录
3. 更新已有的复诊预约信息

注意事项：
- 预约时间不能是过去时间
- 需要验证科室和医生是否存在
- 调用Java微服务时需要处理异常情况

记住：始终以用户为中心，提供友好的交互体验。
```

### 3.5.3 错误处理

- **Java微服务不可用**：返回友好的错误提示，建议用户稍后重试
- **网络超时**：设置合理的超时时间（10秒），超时后返回错误提示
- **数据验证失败**：在调用Java微服务前验证数据合法性
- **认证失败**：记录日志，返回错误提示

### 3.5.4 配置说明

- **Java微服务地址**：通过环境变量或配置文件配置
- **认证Token**：通过环境变量或配置文件配置
- **超时设置**：默认10秒，可通过配置调整

