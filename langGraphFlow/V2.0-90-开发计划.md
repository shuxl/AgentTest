# V2.0 多智能体路由系统开发计划

## 开发计划概述

本文档制定了V2.0多智能体路由系统的开发计划，按照三个阶段划分，每个阶段都有明确的交付物和自测标准，确保开发过程中能够及时发现问题，避免bug堆积。

## 开发原则

1. **阶段驱动**：每个阶段都有明确的交付物和自测标准
2. **可自测**：每个阶段完成后都可以独立测试，验证功能正确性
3. **增量开发**：逐步构建系统，先实现基础功能，再添加高级功能
4. **文档同步**：开发过程中同步更新设计文档

## 阶段划分

本开发计划分为三个阶段：

- **阶段一：基础功能实现** - 实现路由智能体和三个专业智能体（血压记录、复诊管理、医生助手）的基础功能，所有工具采用服务内代码实现，不支持Java微服务集成。本阶段完成后，能够通过前后端实现三个专业智能体的简单对话。

- **阶段二：流程调优和智能体调优** - 测试和优化正常流程、异常流程，确保智能体对话合理、流畅。主要包括重新路由功能测试、意图识别优化、对话质量提升等。

- **阶段三：外部服务集成和系统完善** - 实现Java微服务集成、后端API完善、端到端测试等高级功能。主要包括复诊管理和医生助手智能体集成Java微服务、后端API服务完善、端到端测试和文档完善等。

---

## 阶段一：基础功能实现

**目标**：实现路由智能体和三个专业智能体（血压记录、复诊管理、医生助手）的基础功能，所有工具采用服务内代码实现，不支持Java微服务集成。本阶段完成后，能够通过前后端实现三个专业智能体的简单对话。

**预计总时间**：14天

### 里程碑1：基础设施搭建（M1）✅ 已完成

**目标**：搭建项目基础架构，配置开发环境

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.4.3 配置
- `V2.0-10-总体设计.md` - 3.5.7 部署要求

**开发任务**：
1. 创建项目结构
   - 创建项目目录结构
   - 创建utils目录和子目录（agents、tools）
   - 创建配置文件

2. 配置开发环境
   - 配置Python虚拟环境
   - 安装依赖包（LangGraph、LangChain、FastAPI等）
   - 配置PostgreSQL数据库
   - 配置Redis

3. 实现基础配置管理
   - 实现config.py配置管理模块
   - 实现数据库连接池
   - 实现Redis连接

**交付物**：
- 完整的项目目录结构
- 配置文件（config.py）
- 数据库连接测试脚本
- Redis连接测试脚本

**自测标准**：
- ✅ 项目结构完整，符合设计文档要求
- ✅ 所有依赖包安装成功
- ✅ 数据库连接测试通过
- ✅ Redis连接测试通过
- ✅ 配置文件可以正常读取

**预计时间**：2天

---

### 里程碑2：路由智能体核心功能（M2）

**目标**：实现路由智能体的核心功能，包括意图识别和路由决策

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.1 功能概述（路由智能体）
- `V2.0-11-路由智能体详细设计.md` - 全部章节

**开发任务**：
1. 实现RouterState数据结构
   - 定义RouterState TypedDict
   - 实现状态初始化函数

2. 实现意图识别工具
   - 实现identify_intent工具
   - 实现clarify_intent工具
   - 测试意图识别准确性

3. 实现路由节点
   - 实现router_node函数
   - 实现route_decision函数
   - 测试路由决策逻辑

4. 创建StateGraph路由图
   - 创建路由图结构
   - 添加router节点
   - 添加clarify_intent节点
   - 配置入口点和条件边

**交付物**：
- `utils/router.py` - 路由智能体实现
- `utils/tools/router_tools.py` - 路由工具实现
- 路由功能单元测试

**自测标准**：
- ✅ RouterState数据结构正确定义
- ✅ identify_intent工具能够识别4种意图类型（blood_pressure、appointment、doctor_assistant、unclear）
- ✅ clarify_intent工具能够生成澄清问题
- ✅ router_node能够正确识别意图并更新状态
- ✅ route_decision能够根据意图正确路由
- ✅ StateGraph路由图可以正常编译和运行
- ✅ 单元测试通过率 > 90%

**预计时间**：3天

---

### 里程碑2.5：最小可用后端API和前端客户端（M2.5）

**目标**：实现最小可用的后端API和前端客户端，支持路由智能体的基本对话功能测试

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.3.2 系统流程图
- `V2.0-11-路由智能体详细设计.md` - 3.4.2 接口明细
- `V2.0-15-前端客户端详细设计.md` - 全部章节

**开发任务**：
1. 实现最小可用FastAPI后端服务
   - 创建FastAPI应用实例
   - 实现POST /api/chat接口（最小版本）
   - 集成路由智能体
   - 实现checkpointer配置（PostgreSQL）
   - 实现基本的会话ID管理

2. 实现前端客户端（命令行界面）
   - 创建02_frontendServer.py
   - 实现用户输入和显示功能
   - 实现与后端API的通信
   - 实现会话管理（用户ID、会话ID）
   - 实现对话历史显示

3. 实现基础错误处理
   - 实现基本的异常捕获
   - 实现友好的错误提示

**交付物**：
- `01_backendServer.py` - 最小可用FastAPI后端服务
- `02_frontendServer.py` - 前端命令行客户端
- 后端和前端集成测试

**自测标准**：
- ✅ FastAPI应用能够正常启动
- ✅ POST /api/chat接口能够正常响应
- ✅ 前端客户端能够连接后端API
- ✅ 能够通过前端客户端与路由智能体进行对话
- ✅ 会话ID管理正常（创建新会话、恢复已有会话）
- ✅ 对话历史能够正确保存和恢复
- ✅ 基本的错误处理正常（异常捕获、友好提示）
- ✅ 集成测试通过率 > 90%

**预计时间**：2天

---

### 里程碑3：血压记录智能体实现（M3）

**目标**：实现血压记录智能体，复用0701版本功能

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.1 功能概述（血压记录智能体）
- `V2.0-12-血压记录智能体详细设计.md` - 全部章节

**开发任务**：
1. 创建血压记录数据库表
   - 创建blood_pressure_records表

2. 实现血压记录工具
   - 实现record_blood_pressure工具
   - 实现query_blood_pressure工具
   - 实现update_blood_pressure工具
   - 实现info工具（统计信息）

3. 实现血压记录智能体节点
   - 创建blood_pressure_agent_node函数
   - 创建血压记录智能体（LangGraph）
   - 集成工具到智能体

4. 集成到路由图
   - 添加blood_pressure_agent节点到路由图
   - 配置路由边（router -> blood_pressure_agent -> router）
   - 测试路由功能

**交付物**：
- `utils/agents/blood_pressure_agent.py` - 血压记录智能体节点
- `utils/tools/blood_pressure_tools.py` - 血压记录工具
- 数据库表结构
- 血压记录功能集成测试

**自测标准**：
- ✅ 数据库表创建成功
- ✅ record_blood_pressure工具能够保存血压数据
- ✅ query_blood_pressure工具能够查询历史记录
- ✅ update_blood_pressure工具能够更新记录
- ✅ info工具能够返回统计信息
- ✅ 血压记录智能体节点能够正常执行
- ✅ 从路由智能体能够正确路由到血压记录智能体
- ✅ 通过前端客户端完整测试血压记录流程（记录 -> 查询 -> 更新）
- ✅ 血压记录完整流程测试通过（记录 -> 查询 -> 更新）
- ✅ 单元测试通过率 > 90%

**预计时间**：3天

---

### 里程碑4：复诊管理智能体实现（M4）

**目标**：实现复诊管理智能体的基础功能，使用服务内代码实现（不集成Java微服务）

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.1 功能概述（复诊管理智能体）
- `V2.0-13-复诊管理智能体详细设计.md` - 全部章节

**开发任务**：
1. 创建复诊管理数据库表
   - 创建appointments表（存储预约信息）

2. 实现复诊管理工具（服务内代码实现）
   - 实现appointment_booking工具（直接操作数据库）
   - 实现query_appointment工具（直接查询数据库）
   - 实现update_appointment工具（直接更新数据库）

3. 实现复诊管理智能体节点
   - 创建appointment_agent_node函数
   - 创建复诊管理智能体（LangGraph）
   - 集成工具到智能体

4. 集成到路由图
   - 添加appointment_agent节点到路由图
   - 配置路由边（router -> appointment_agent -> router）
   - 测试路由功能

**交付物**：
- `utils/agents/appointment_agent.py` - 复诊管理智能体节点
- `utils/tools/appointment_tools.py` - 复诊管理工具（服务内实现）
- 数据库表结构（appointments）
- 复诊管理功能集成测试

**自测标准**：
- ✅ 数据库表创建成功
- ✅ appointment_booking工具能够创建预约
- ✅ query_appointment工具能够查询预约
- ✅ update_appointment工具能够更新预约
- ✅ 复诊管理智能体节点能够正常执行
- ✅ 从路由智能体能够正确路由到复诊管理智能体
- ✅ 通过前端客户端完整测试复诊管理流程（预约 -> 查询 -> 更新）
- ✅ 复诊管理完整流程测试通过（预约 -> 查询 -> 更新）
- ✅ 单元测试通过率 > 90%

**预计时间**：3天

---

### 里程碑5：医生助手智能体实现（M5）

**目标**：实现医生助手智能体的基础功能，使用服务内代码实现（不集成Java微服务）

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.1 功能概述（医生助手智能体）
- `V2.0-14-医生助手智能体详细设计.md` - 全部章节

**开发任务**：
1. 创建医生助手数据库表
   - 创建patient_records表（存储病历信息）
   - 创建prescriptions表（存储处方信息）

2. 实现医生助手工具（服务内代码实现）
   - 实现query_patient_record工具（直接查询数据库）
   - 实现update_patient_record工具（直接更新数据库）
   - 实现prescribe_medicine工具（直接操作数据库）
   - 实现query_prescription工具（直接查询数据库）

3. 实现医生助手智能体节点
   - 创建doctor_assistant_agent_node函数
   - 创建医生助手智能体（LangGraph）
   - 集成工具到智能体

4. 集成到路由图
   - 添加doctor_assistant_agent节点到路由图
   - 配置路由边（router -> doctor_assistant_agent -> router）
   - 测试路由功能

**交付物**：
- `utils/agents/doctor_assistant_agent.py` - 医生助手智能体节点
- `utils/tools/doctor_assistant_tools.py` - 医生助手工具（服务内实现）
- 数据库表结构（patient_records、prescriptions）
- 医生助手功能集成测试

**自测标准**：
- ✅ 数据库表创建成功
- ✅ query_patient_record工具能够查询病历
- ✅ update_patient_record工具能够更新病历
- ✅ prescribe_medicine工具能够开具处方
- ✅ query_prescription工具能够查询处方
- ✅ 医生助手智能体节点能够正常执行
- ✅ 从路由智能体能够正确路由到医生助手智能体
- ✅ 通过前端客户端完整测试医生助手流程（查询病历 -> 开具处方 -> 查询处方）
- ✅ 医生助手完整流程测试通过（查询病历 -> 开具处方 -> 查询处方）
- ✅ 单元测试通过率 > 90%

**预计时间**：3天

---

## 阶段二：流程调优和智能体调优

**目标**：测试和优化正常流程、异常流程，确保智能体对话合理、流畅。主要包括重新路由功能测试、意图识别优化、对话质量提升等。

**预计总时间**：5天

### 里程碑6：重新路由功能测试和优化（M6）

**目标**：测试和优化重新路由功能，确保意图切换正常工作

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.2.1 关键算法和技术实现或选型
- `V2.0-02-重新路由技术细节.md` - 全部章节

**开发任务**：
1. 实现重新路由测试用例
   - 测试正常流程（不改变意图）
   - 测试重新路由场景（改变意图）
   - 测试意图澄清场景

2. 优化路由性能
   - 实现智能意图检查（避免不必要的意图识别）
   - 实现意图识别结果缓存
   - 优化路由决策逻辑

3. 完善日志记录
   - 记录路由决策过程
   - 记录意图识别结果
   - 记录重新路由事件

**交付物**：
- 重新路由功能测试用例
- 性能优化代码
- 日志记录完善
- 重新路由功能测试报告

**自测标准**：
- ✅ 正常流程测试通过（用户在同一智能体中完成任务）
- ✅ 重新路由测试通过（用户改变意图，自动重新路由）
- ✅ 意图澄清测试通过（意图不明确时，生成澄清问题）
- ✅ 性能优化生效（路由决策时间 < 500ms）
- ✅ 日志记录完整，能够追踪路由决策过程
- ✅ 测试用例通过率 100%

**预计时间**：2天

### 里程碑7：智能体对话质量优化（M7）

**目标**：优化智能体对话质量，提升用户体验

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.1 功能概述
- `V2.0-12-血压记录智能体详细设计.md` - 全部章节
- `V2.0-13-复诊管理智能体详细设计.md` - 全部章节
- `V2.0-14-医生助手智能体详细设计.md` - 全部章节

**开发任务**：
1. 优化系统提示词
   - 优化路由智能体提示词
   - 优化血压记录智能体提示词
   - 优化复诊管理智能体提示词
   - 优化医生助手智能体提示词

2. 测试和优化正常流程对话
   - 测试血压记录完整对话流程
   - 测试复诊管理完整对话流程
   - 测试医生助手完整对话流程
   - 优化对话中的引导话术

3. 测试和优化异常流程对话
   - 测试数据验证失败场景
   - 测试用户输入不完整场景
   - 测试用户改变意图场景
   - 优化异常情况的错误提示

4. 优化工具调用逻辑
   - 优化工具参数提取逻辑
   - 优化工具调用失败处理
   - 优化工具返回结果格式化

**交付物**：
- 优化后的智能体提示词
- 正常流程测试用例和测试报告
- 异常流程测试用例和测试报告
- 对话质量优化代码

**自测标准**：
- ✅ 正常流程对话流畅，用户体验良好
- ✅ 异常流程能够友好提示，引导用户正确操作
- ✅ 工具调用逻辑合理，参数提取准确
- ✅ 对话质量测试通过率 > 90%

**预计时间**：3天

---

## 阶段三：外部服务集成和系统完善

**目标**：实现Java微服务集成、后端API完善、端到端测试等高级功能。主要包括复诊管理和医生助手智能体集成Java微服务、后端API服务完善、端到端测试和文档完善等。

**预计总时间**：9天

### 里程碑8：复诊管理智能体集成Java微服务（M8）

**目标**：将复诊管理智能体的工具实现从服务内代码改为调用Java微服务

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.1 功能概述（复诊管理智能体）
- `V2.0-13-复诊管理智能体详细设计.md` - 全部章节
- `900-Java微服务集成说明.md` - 全部章节

**开发任务**：
1. 实现HTTP客户端工具
   - 实现httpx异步客户端封装
   - 实现认证Token管理
   - 实现错误处理和重试机制

2. 重构复诊管理工具（改为调用Java微服务）
   - 重构appointment_booking工具（调用Java微服务）
   - 重构query_appointment工具（调用Java微服务）
   - 重构update_appointment工具（调用Java微服务）

3. 实现优雅降级机制
   - Java微服务调用失败时回退到服务内代码（可选）
   - 实现友好的错误提示
   - 实现重试机制

4. 测试Java微服务集成
   - 测试Java微服务调用正常场景
   - 测试Java微服务调用失败场景
   - 测试网络超时场景

**交付物**：
- `utils/tools/appointment_tools.py` - 复诊管理工具（Java微服务集成版本）
- `utils/http_client.py` - HTTP客户端封装
- 复诊管理Java微服务集成测试

**自测标准**：
- ✅ HTTP客户端能够正常调用Java微服务
- ✅ 复诊管理工具能够正常调用Java微服务接口
- ✅ Java微服务调用失败时能够优雅降级
- ✅ 网络超时能够正确处理
- ✅ 复诊管理完整流程测试通过（预约 -> 查询 -> 更新）
- ✅ 集成测试通过率 > 90%

**预计时间**：2天

### 里程碑9：医生助手智能体集成Java微服务（M9）

**目标**：将医生助手智能体的工具实现从服务内代码改为调用Java微服务

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.1 功能概述（医生助手智能体）
- `V2.0-14-医生助手智能体详细设计.md` - 全部章节
- `900-Java微服务集成说明.md` - 全部章节

**开发任务**：
1. 重构医生助手工具（改为调用Java微服务）
   - 重构query_patient_record工具（调用Java微服务）
   - 重构update_patient_record工具（调用Java微服务）
   - 重构prescribe_medicine工具（调用Java微服务）
   - 重构query_prescription工具（调用Java微服务）

2. 实现权限验证
   - 实现医生身份验证
   - 实现权限检查
   - 集成权限验证服务

3. 实现优雅降级机制
   - Java微服务调用失败时回退到服务内代码（可选）
   - 实现友好的错误提示
   - 实现重试机制

4. 测试Java微服务集成
   - 测试Java微服务调用正常场景
   - 测试Java微服务调用失败场景
   - 测试权限验证场景

**交付物**：
- `utils/tools/doctor_assistant_tools.py` - 医生助手工具（Java微服务集成版本）
- 权限验证模块
- 医生助手Java微服务集成测试

**自测标准**：
- ✅ 医生助手工具能够正常调用Java微服务接口
- ✅ 权限验证功能正常
- ✅ Java微服务调用失败时能够优雅降级
- ✅ 医生助手完整流程测试通过（查询病历 -> 开具处方 -> 查询处方）
- ✅ 集成测试通过率 > 90%

**预计时间**：2天

### 里程碑10：后端API服务完善（M10）

**目标**：完善后端API服务，添加高级功能和优化

**关联设计文档**：
- `V2.0-10-总体设计.md` - 3.3.2 系统流程图
- `V2.0-11-路由智能体详细设计.md` - 3.4.2 接口明细

**开发任务**：
1. 完善FastAPI应用
   - 配置中间件（CORS、认证等）
   - 实现健康检查接口（GET /health）
   - 实现系统信息接口（GET /api/system/info）
   - 实现用户会话查询接口（GET /api/sessions）

2. 实现会话管理模块
   - 实现utils/session_manager.py会话管理模块
   - 实现会话创建和查询功能
   - 实现会话状态管理（Redis）
   - 实现会话超时处理
   - 实现用户活跃会话查询

3. 完善错误处理
   - 实现全局异常处理
   - 实现友好错误响应
   - 实现详细的日志记录
   - 实现错误码和错误消息标准化

4. 实现API文档
   - 配置Swagger UI
   - 完善API接口文档
   - 添加接口使用示例

5. 性能优化
   - 实现请求限流
   - 优化数据库查询
   - 添加响应缓存（如适用）

**交付物**：
- `utils/session_manager.py` - 会话管理模块
- 完善的`01_backendServer.py` - FastAPI后端服务
- API接口文档（Swagger）
- 后端服务完善后的集成测试

**自测标准**：
- ✅ 健康检查接口正常
- ✅ 系统信息接口正常
- ✅ 会话管理功能完善（创建、查询、超时、活跃会话查询）
- ✅ 全局异常处理正常
- ✅ 日志记录详细完整
- ✅ API文档完整且可访问（Swagger）
- ✅ 性能优化生效（请求限流、查询优化）
- ✅ 集成测试通过率 > 90%

**预计时间**：2天

### 里程碑11：端到端测试和文档完善（M11）

**目标**：完成端到端测试，完善文档和代码注释

**关联设计文档**：
- `V2.0-10-总体设计.md` - 全部章节
- 所有详细设计文档

**开发任务**：
1. 端到端测试
   - 测试完整业务流程（血压记录、复诊预约、医生助手）
   - 测试多用户并发场景
   - 测试异常场景（网络故障、服务不可用等）
   - 测试Java微服务集成场景

2. 性能测试
   - 测试并发性能（100并发会话）
   - 测试响应时间（路由决策、工具调用）
   - 测试数据库性能
   - 测试Java微服务调用性能

3. 文档完善
   - 完善代码注释
   - 更新README文档
   - 更新API文档
   - 更新部署文档

4. 代码审查和重构
   - 代码审查
   - 重构优化
   - 代码规范检查

**交付物**：
- 端到端测试用例和测试报告
- 性能测试报告
- 完善的README文档
- 完善的代码注释
- 部署文档

**自测标准**：
- ✅ 端到端测试通过率 > 95%
- ✅ 性能测试达标（并发100会话，响应时间满足要求）
- ✅ 文档完整，代码注释清晰
- ✅ 代码通过代码规范检查
- ✅ 所有测试用例通过

**预计时间**：3天

---

## 开发计划总览

### 阶段一：基础功能实现（14天）

| 里程碑 | 名称 | 状态 | 预计时间 | 关联文档 |
| ------ | ------ | ------ | ------ | ------ |
| M1 | 基础设施搭建 | ✅ 已完成 | 2天 | V2.0-10-总体设计.md |
| M2 | 路由智能体核心功能 | ✅ 已完成 | 3天 | V2.0-11-路由智能体详细设计.md |
| M2.5 | 最小可用后端API和前端客户端 | ✅ 已完成 | 2天 | V2.0-10-总体设计.md、V2.0-11-路由智能体详细设计.md |
| M3 | 血压记录智能体实现 | ✅ 已完成 | 3天 | V2.0-12-血压记录智能体详细设计.md |
| M4 | 复诊管理智能体实现（服务内代码） | 🔄 待实现 | 3天 | V2.0-13-复诊管理智能体详细设计.md |
| M5 | 医生助手智能体实现（服务内代码） | 🔄 待实现 | 3天 | V2.0-14-医生助手智能体详细设计.md |

### 阶段二：流程调优和智能体调优（5天）

| 里程碑 | 名称 | 状态 | 预计时间 | 关联文档 |
| ------ | ------ | ------ | ------ | ------ |
| M6 | 重新路由功能测试和优化 | 🔄 待实现 | 2天 | V2.0-02-重新路由技术细节.md |
| M7 | 智能体对话质量优化 | 🔄 待实现 | 3天 | V2.0-12/13/14-各智能体详细设计.md |

### 阶段三：外部服务集成和系统完善（9天）

| 里程碑 | 名称 | 状态 | 预计时间 | 关联文档 |
| ------ | ------ | ------ | ------ | ------ |
| M8 | 复诊管理智能体集成Java微服务 | 🔄 待实现 | 2天 | V2.0-13-复诊管理智能体详细设计.md、900-Java微服务集成说明.md |
| M9 | 医生助手智能体集成Java微服务 | 🔄 待实现 | 2天 | V2.0-14-医生助手智能体详细设计.md、900-Java微服务集成说明.md |
| M10 | 后端API服务完善 | 🔄 待实现 | 2天 | V2.0-10-总体设计.md、V2.0-11-路由智能体详细设计.md |
| M11 | 端到端测试和文档完善 | 🔄 待实现 | 3天 | 所有设计文档 |

**总计预计时间**：28天（约5.5周）

## 风险控制

1. **Java微服务依赖**：如果Java微服务未就绪，使用Mock服务进行开发
2. **性能问题**：每个里程碑都要进行性能测试，及时发现问题
3. **代码质量**：每个里程碑都要进行代码审查，确保代码质量
4. **测试覆盖**：每个里程碑都要有充分的测试覆盖，确保功能正确性

## 验收标准

1. **功能完整性**：所有设计文档中的功能都已实现
2. **性能达标**：性能指标满足设计要求（路由决策 < 500ms，并发100会话）
3. **测试覆盖**：单元测试覆盖率 > 90%，集成测试通过率 > 95%
4. **文档完整**：所有设计文档都已更新，代码注释完整
5. **代码质量**：代码通过代码规范检查，无严重bug

## 后续优化计划

1. **性能优化**：根据实际使用情况，持续优化性能
2. **功能扩展**：添加新的专门智能体（如：用药提醒、健康咨询等）
3. **用户体验优化**：根据用户反馈，优化交互体验
4. **监控和告警**：添加系统监控和告警机制

---

*开发计划版本：v2.0*  
*制定时间：2025年11月*  
*作者：@舒小龙*

